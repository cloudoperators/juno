#SPDX-FileCopyrightText: 2024 SAP SE or an SAP affiliate company and Juno contributors
#SPDX-License-Identifier: Apache-2.0

query GetImageVersions(
    $filter: ImageVersionFilter
    $first: Int
    $after: String
    $firstVulnerabilities: Int
    $afterVulnerabilities: String
    $firstOccurences: Int
    $afterOccurences: String
) {
  # This query is designed for listing the ImageVersions of a Service
  # - It's ordered by Vulnerability Count per default, then by Repository
  # - Default page size is 10, but can be overridden by the $first parameter
  ImageVersions(first: $first, after: $after, filter: $filter) {
    # Counts will result in a subquery. Request only if needed.
    # Counts number of Vulnerabilities per severity
    counts{
      critical
      high
      medium
      low
      none
      total
    }
    edges{
      node{
        id
        tag
        repository
        version
        # Counts will result in a subquery. Request only if needed.
        # Counts number of Vulnerabilities per severity
        vulnerabilityCounts{
          critical
          high
          medium
          low
          none
          total
        }
        # Default page size is 10, but can be overridden by the $first parameter
        occurences(first: $firstOccurences, after: $afterOccurences){
          edges{
            node{
              id
              ccrn
              componentVersionId
            }
          }
        }
        # - Only returns Issues of type Vulnerability
        # - Only returns Issues with at least one IssueMatch with status "new"
        # - It's ordered by severity per default
        # - Default page size is 10, but can be overridden by the $first parameter
        vulnerabilities(first: $firstVulnerabilities, after: $afterVulnerabilities){
          edges{
            node{
              id
              severity
              name
              sourceUrl
              earliestTargetRemediationDate
              description
            }
          }
          # Requesting pageInfo will result in a subquery. Request only if needed.
          pageInfo{
            pageNumber
            pages{
              after
              pageNumber
            }
          }
        }
      }
    }
    # Total count will result in a subquery. Request only if needed.
    totalCount
    # Requesting pageInfo will result in a subquery. Request only if needed.
    pageInfo {
        hasNextPage
        hasPreviousPage
        isValidPage
        pageNumber
        nextPageAfter
        pages {
            after
            isCurrent
            pageNumber
            pageCount
        }
    }
  }
}

