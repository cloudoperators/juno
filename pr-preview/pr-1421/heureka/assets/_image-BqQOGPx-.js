import{Q as M,T as P,j as e,u as T,o as g,c as v,d as f,V as j,U as q,W as z,Z as A,_ as O,$ as Q,a0 as H,y as G,a1 as B,a2 as U,a3 as V,a4 as D,I as W,P as w,n as m,E as b,M as Z,a as _,f as k,a5 as N,L as J,O as X,m as Y}from"./App-xfI2Ebgt.js";import{r as o}from"./index-65vcCzFS.js";import{E as C,u as F,g as E,L as I,I as ee}from"./IssueCountsPerSeverityLevel-Bad6Z3EJ.js";import{S as se}from"./SectionContentHeading-DCZgGNfl.js";import{I as re}from"./index-D81oq6qM.js";import{C as ae}from"./CursorPagination-DLsKnKK-.js";import"./IssueTimestamp-D7okumt5.js";const ie=({queryClient:a,apiClient:i,filter:r})=>{const c=["remediations",r];return a.ensureQueryData({queryKey:c,queryFn:()=>i.query({query:M,variables:{filter:r}})})},te=({issuesPromise:a,service:i,image:r,onFalsePositiveSuccess:c,onFalsePositiveError:t})=>{const{error:s,data:d}=o.use(a),{vulnerabilities:u}=P(d);return s?e.jsxs(C,{colSpan:5,children:["Error loading vulnerabilities: ",s.message]}):u.length===0?e.jsx(C,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):u.map(h=>e.jsx(re,{issue:h,service:i,image:r,onFalsePositiveSuccess:c,onFalsePositiveError:t},h.id||h.name))},ne=()=>`
    border-l-2
    border-theme-default
    h-full
    pl-5
  `,oe=({remediation:a,onRevert:i})=>{const[r,c]=o.useState(!1),[t,s]=o.useState(!1),{needsExpansion:d,textRef:u}=T(a.description||""),h=n=>{n.preventDefault(),c(!r)},x=async()=>{s(!0);try{await i(a.remediationId)}catch(n){console.error("Failed to revert remediation:",n)}finally{s(!1)}};return e.jsxs(g,{children:[e.jsx(v,{className:"pl-0",children:e.jsx("div",{className:ne(),children:e.jsx(f,{icon:"checkCircle",color:"success"})})}),e.jsx(v,{className:"whitespace-nowrap",children:e.jsx(j,{gap:"2",direction:"vertical",children:e.jsx("span",{children:a.vulnerability||"N/A"})})}),e.jsx(v,{children:e.jsxs(j,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:u,className:r?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:a.description||"No description available"}),a.description&&d&&e.jsx("a",{href:"#",onClick:h,className:"link-hover",children:e.jsxs(j,{alignment:"center",children:[r?"Show less":"Show more",e.jsx(f,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})]})}),e.jsx(v,{className:"cursor-default interactive",onClick:n=>n.stopPropagation(),children:e.jsx(q,{icon:"moreVert",className:"whitespace-nowrap",disabled:t,children:e.jsx(z,{children:e.jsx(A,{label:t?"Reverting...":"Revert false positive",onClick:x,disabled:t})})})})]})},le=async({apiClient:a,remediationId:i})=>{const r=await a.mutate({mutation:O,variables:{id:i}});if(!r.data?.deleteRemediation)throw new Error("Failed to delete remediation");return r.data.deleteRemediation},ce=({remediationsPromise:a,onRevertSuccess:i,onRevertError:r})=>{const{error:c,data:t}=o.use(a),{remediatedVulnerabilities:s}=Q(t),{apiClient:d,queryClient:u}=F({from:"/services/$service"}),h=async x=>{try{await le({apiClient:d,remediationId:x}),u.invalidateQueries({queryKey:["remediations"]}),u.invalidateQueries({queryKey:["images"]}),i()}catch(n){throw console.error("Failed to delete remediation:",n),r(n instanceof Error?n:new Error("Failed to revert false positive")),n}};return c?e.jsxs(C,{colSpan:4,children:["Error loading remediated vulnerabilities: ",c.message]}):s.length===0?e.jsx(C,{colSpan:4,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:s.map(x=>e.jsx(oe,{remediation:x,onRevert:h},x.remediationId))})},de=({service:a,image:i})=>{const{apiClient:r,queryClient:c}=F({from:"/services/$service"}),{addMessage:t}=H(),[s,d]=o.useState(void 0),[u,h]=o.useState(void 0),[x,n]=o.useState(0),R=s?{search:[s]}:void 0,p=G({apiClient:r,queryClient:c,filter:{service:[a],repository:[i.repository]},firstVulnerabilities:20,afterVulnerabilities:u,vulFilter:R}),l=ie({apiClient:r,queryClient:c,filter:{service:[a],image:[i.repository]}}),S=o.useCallback(()=>{t({variant:"success",text:"Vulnerability marked as false positive successfully."})},[t]),L=o.useCallback(y=>{t({variant:"error",text:`Failed to mark as false positive: ${y.message}`})},[t]),$=o.useCallback(()=>{t({variant:"success",text:"False positive reverted successfully."})},[t]),K=o.useCallback(y=>{t({variant:"error",text:`Failed to revert false positive: ${y.message}`})},[t]);return e.jsx(e.Fragment,{children:e.jsxs(B,{selectedIndex:x,onSelect:n,variant:"content",children:[e.jsxs(U,{children:[e.jsx(V,{label:"Vulnerabilities"}),e.jsx(V,{label:"Remediated Vulnerabilities"})]}),e.jsxs(D,{children:[e.jsx(j,{gap:"2",className:"mb-4 mt-4",children:e.jsx(W,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:y=>d(y||""),onClear:()=>{d("")}})}),e.jsxs(w,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(m,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"}),e.jsx(m,{children:"Actions"})]}),p&&e.jsx(b,{displayErrorMessage:!0,fallbackRender:E({colspan:5}),resetKeys:[p],children:e.jsx(o.Suspense,{fallback:e.jsx(I,{colSpan:5}),children:e.jsx(te,{issuesPromise:p,service:a,image:i.repository,onFalsePositiveSuccess:S,onFalsePositiveError:L})})})]}),p&&e.jsx(b,{resetKeys:[p],children:e.jsx(o.Suspense,{children:e.jsx(ae,{dataPromise:p,dataNormalizationMethod:P,goToPage:h})})})]}),e.jsxs(D,{children:[e.jsx("div",{className:"mb-4 mt-4"}),e.jsxs(w,{columns:4,minContentColumns:[0,1,3],cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(m,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Description"}),e.jsx(m,{children:"Actions"})]}),l&&e.jsx(b,{displayErrorMessage:!0,fallbackRender:E({colspan:4}),resetKeys:[l],children:e.jsx(o.Suspense,{fallback:e.jsx(I,{colSpan:4}),children:e.jsx(ce,{remediationsPromise:l,onRevertSuccess:$,onRevertError:K})})})]})]})]})})},ue=({imagesPromise:a,imageRepository:i,service:r})=>{const{data:c}=o.use(a),{images:t}=Z(c),s=t.find(l=>l.repository===i),[d,u]=o.useState(!1),h=_();if(!s)return null;const x=l=>{h({to:"/services/$service/images/$image/versions/$version",params:{service:r,image:i,version:l}})},n=s.versions||[],R=d?n:n.slice(0,3),p=n.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(se,{children:["Image ",s.repository]}),e.jsxs(w,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(g,{children:[e.jsx(m,{children:"Details"}),e.jsx(v,{children:e.jsxs(j,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(k,{pillKey:"repository",pillKeyLabel:"repository",pillValue:s.repository,pillValueLabel:s.repository}),s.versionsCount!==void 0&&s.versionsCount>0&&e.jsx(k,{pillKey:"versions",pillKeyLabel:"versions",pillValue:s.versionsCount.toString(),pillValueLabel:s.versionsCount.toString()})]})})]}),e.jsxs(g,{children:[e.jsx(m,{children:"Vulnerabilities Counts"}),e.jsx(v,{children:e.jsx(ee,{counts:s.vulnerabilityCounts})})]}),n.length>0&&e.jsxs(g,{children:[e.jsxs(m,{children:["Versions (",n.length,")"]}),e.jsx(v,{children:e.jsxs(j,{gap:"2",direction:"vertical",children:[R.map(l=>e.jsx("a",{href:"#",onClick:S=>{S.preventDefault(),x(l.version)},className:"link-hover",children:e.jsx("span",{children:l.version})},l.id)),p&&!d&&e.jsx("a",{href:"#",onClick:l=>{l.preventDefault(),u(!0)},className:"link-hover",children:e.jsxs(j,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(f,{color:"global-text",icon:"expandMore"})]})}),p&&d&&e.jsx("a",{href:"#",onClick:l=>{l.preventDefault(),u(!1)},className:"link-hover",children:e.jsxs(j,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(f,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),r&&i&&s&&e.jsx(de,{service:r,image:s})]})};function fe(){const{imagesPromise:a}=N.useLoaderData(),{service:i,image:r}=N.useParams();return J()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(X,{}):e.jsx(b,{displayErrorMessage:!0,children:e.jsx(o.Suspense,{fallback:e.jsx(Y,{className:"mt-4"}),children:e.jsx(ue,{imagesPromise:a,imageRepository:r,service:i})})})}export{fe as component};
