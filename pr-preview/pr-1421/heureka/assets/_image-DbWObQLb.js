import{Q as J,T as C,j as e,u as X,o as v,c as h,V as m,d as f,g as Y,U as ee,y as D,W as se,Z as re,_ as I,$ as E,a0 as T,a1 as te,a2 as F,a3 as $,I as ae,P as R,n as u,E as S,M as ne,a as ie,f as k,a4 as le,a5 as M,L as oe,O as ce,m as de}from"./App-DSoREZdQ.js";import{r as i}from"./index-CcXZx4YX.js";import{E as y,u as ue,g as z,L as A,I as me}from"./IssueCountsPerSeverityLevel-CFi-XCtT.js";import{S as xe}from"./SectionContentHeading-DzuN5H8_.js";import{I as he,a as je}from"./index-Dbao5QNI.js";import{I as pe}from"./IssueTimestamp-RMXTj89r.js";import{C as K}from"./CursorPagination-Bdrq8zWk.js";const ge=({queryClient:s,apiClient:r,filter:t})=>{const l=["remediations",t];return s.ensureQueryData({queryKey:l,queryFn:()=>r.query({query:J,variables:{filter:t}})})},ve=({issuesPromise:s,service:r,image:t,onFalsePositiveSuccess:l})=>{const{error:n,data:a}=i.use(s),{vulnerabilities:d}=C(a);return n?e.jsxs(y,{colSpan:5,children:["Error loading vulnerabilities: ",n.message]}):d.length===0?e.jsx(y,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):d.filter(o=>o&&o.name).map(o=>e.jsx(he,{issue:o,service:r,image:t,onFalsePositiveSuccess:l},o.id||o.name))},fe=s=>`
    border-l-2
    ${Y(s.toLowerCase())}
    h-full
    pl-5
  `,be=({issue:s})=>{const[r,t]=i.useState(!1),{needsExpansion:l,textRef:n}=X(s?.description||""),a=d=>{d.preventDefault(),t(!r)};return s?.name?e.jsxs(v,{children:[e.jsx(h,{className:"pl-0",children:e.jsx("div",{className:fe(s.severity),children:e.jsx(je,{severity:s.severity})})}),e.jsx(h,{className:"whitespace-nowrap",children:e.jsxs(m,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceUrl&&s.sourceUrl!=="-"&&e.jsx("a",{href:s.sourceUrl,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(m,{gap:"1.5",alignment:"center",children:[e.jsx(f,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Vulnerability source"})]})})]})}),e.jsx(h,{className:"whitespace-nowrap",children:e.jsx(pe,{targetDate:s.earliestTargetRemediationDate})}),e.jsx(h,{className:"min-w-0",children:e.jsxs(m,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:n,className:r?"":"whitespace-nowrap overflow-hidden text-ellipsis max-w-full",children:s.description}),s.description&&l&&e.jsx("a",{href:"#",onClick:a,className:"link-hover",children:e.jsxs(m,{alignment:"center",children:[r?"Show less":"Show more",e.jsx(f,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})]})})]}):null},L=4,Se=({issuesPromise:s,remediationsPromise:r})=>{const t=i.use(s),l=i.use(r),{error:n,data:a}=t,{data:d}=l,{vulnerabilities:o}=C(a);return ee(d),n?e.jsxs(y,{colSpan:L,children:["Error loading remediated vulnerabilities: ",n.message]}):o.length===0?e.jsx(y,{colSpan:L,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:o.map(j=>e.jsx(be,{issue:j},j.id))})},ye=({service:s,image:r,setSearchTerm:t,setPageCursor:l,issuesPromise:n,successMessage:a,onFalsePositiveSuccess:d})=>e.jsxs(e.Fragment,{children:[a&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(F,{text:a,variant:"success"})}),e.jsx($,{className:"mb-4 mt-4"}),e.jsx(m,{gap:"2",className:"mb-4 mt-4",children:e.jsx(ae,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:o=>t(o||""),onClear:()=>{t("")}})}),e.jsxs(R,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(u,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(u,{children:"Vulnerability"}),e.jsx(u,{children:"Target Date"}),e.jsx(u,{children:"Description"}),e.jsx(u,{children:"Actions"})]}),n&&e.jsx(S,{displayErrorMessage:!0,fallbackRender:z({colspan:5}),resetKeys:[n],children:e.jsx(i.Suspense,{fallback:e.jsx(A,{colSpan:5}),children:e.jsx(ve,{issuesPromise:n,service:s,image:r.repository,onFalsePositiveSuccess:d})})})]}),n&&e.jsx(S,{resetKeys:[n],children:e.jsx(i.Suspense,{children:e.jsx(K,{dataPromise:n,dataNormalizationMethod:C,goToPage:l})})})]}),Ce=({issuesPromise:s,remediationsPromise:r,setPageCursor:t,successMessage:l})=>e.jsxs(e.Fragment,{children:[l&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(F,{text:l,variant:"success"})}),e.jsx($,{className:"mb-4 mt-4"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs(R,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(u,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(u,{children:"Vulnerability"}),e.jsx(u,{children:"Target Date"}),e.jsx(u,{children:"Description"})]}),s&&e.jsx(S,{displayErrorMessage:!0,fallbackRender:z({colspan:4}),resetKeys:[s,r],children:e.jsx(i.Suspense,{fallback:e.jsx(A,{colSpan:4}),children:e.jsx(Se,{issuesPromise:s,remediationsPromise:r})})})]}),s&&e.jsx(S,{resetKeys:[s],children:e.jsx(i.Suspense,{children:e.jsx(K,{dataPromise:s,dataNormalizationMethod:C,goToPage:t})})})]})]}),P=5e3,Ve=({service:s,image:r})=>{const{apiClient:t,queryClient:l}=ue({from:"/services/$service"}),[n,a]=i.useState(void 0),[d,o]=i.useState(void 0),[j,V]=i.useState(void 0),[x,N]=i.useState(0),[p,c]=i.useState(null),[b,O]=i.useState(null),U={status:"open",...n?{search:[n]}:{}},_={status:"remediated"},q=D({apiClient:t,queryClient:l,filter:{service:[s],repository:[r.repository]},firstVulnerabilities:20,afterVulnerabilities:d,vulFilter:U}),G=D({apiClient:t,queryClient:l,filter:{service:[s],repository:[r.repository]},firstVulnerabilities:20,afterVulnerabilities:j,vulFilter:_}),H=ge({apiClient:t,queryClient:l,filter:{service:[s],image:[r.repository]}});i.useEffect(()=>{if(!p)return;const g=setTimeout(()=>c(null),P);return()=>clearTimeout(g)},[p]),i.useEffect(()=>{if(!b)return;const g=setTimeout(()=>O(null),P);return()=>clearTimeout(g)},[b]);const Q=()=>{const{addMessage:g}=te(),W=i.useCallback(Z=>{const w=`Vulnerability ${Z} marked as false positive successfully.`;g({variant:"success",text:w}),c(w)},[g]);return e.jsx(ye,{service:s,image:r,setSearchTerm:a,setPageCursor:o,issuesPromise:q,successMessage:p,onFalsePositiveSuccess:W})},B=()=>e.jsx(Ce,{issuesPromise:G,remediationsPromise:H,setPageCursor:V,successMessage:b});return e.jsx(e.Fragment,{children:e.jsxs(se,{selectedIndex:x,onSelect:N,variant:"content",children:[e.jsxs(re,{children:[e.jsx(I,{label:"Active Vulnerabilities"}),e.jsx(I,{label:"Remediated Vulnerabilities"})]}),e.jsx(E,{children:e.jsx(T,{children:e.jsx(Q,{})})}),e.jsx(E,{children:e.jsx(T,{children:e.jsx(B,{})})})]})})},Ne=({imagesPromise:s,imageRepository:r,service:t})=>{const{data:l}=i.use(s),{images:n}=ne(l),a=n.find(c=>c.repository===r),[d,o]=i.useState(!1),j=ie();if(!a)return null;const V=c=>{j({to:"/services/$service/images/$image/versions/$version",params:{service:t,image:r,version:c}})},x=a.versions||[],N=d?x:x.slice(0,3),p=x.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(xe,{children:["Image ",a.repository]}),e.jsxs(R,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(v,{children:[e.jsx(u,{children:"Details"}),e.jsx(h,{children:e.jsxs(m,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(k,{pillKey:"repository",pillKeyLabel:"repository",pillValue:a.repository,pillValueLabel:a.repository}),a.versionsCount!==void 0&&a.versionsCount>0&&e.jsx(k,{pillKey:"versions",pillKeyLabel:"versions",pillValue:a.versionsCount.toString(),pillValueLabel:a.versionsCount.toString()})]})})]}),e.jsxs(v,{children:[e.jsx(u,{children:"Vulnerabilities Counts"}),e.jsx(h,{children:e.jsx(me,{counts:a.vulnerabilityCounts})})]}),x.length>0&&e.jsxs(v,{children:[e.jsxs(u,{children:["Versions (",x.length,")"]}),e.jsx(h,{children:e.jsxs(m,{gap:"2",direction:"vertical",children:[N.map(c=>e.jsx("a",{href:"#",title:c.version,onClick:b=>{b.preventDefault(),V(c.version)},className:"link-hover",children:e.jsx("span",{children:le(c.version)})},c.id)),p&&!d&&e.jsx("a",{href:"#",onClick:c=>{c.preventDefault(),o(!0)},className:"link-hover",children:e.jsxs(m,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(f,{color:"global-text",icon:"expandMore"})]})}),p&&d&&e.jsx("a",{href:"#",onClick:c=>{c.preventDefault(),o(!1)},className:"link-hover",children:e.jsxs(m,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(f,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),t&&r&&a&&e.jsx(Ve,{service:t,image:a})]})};function Me(){const{imagesPromise:s}=M.useLoaderData(),{service:r,image:t}=M.useParams();return oe()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(ce,{}):e.jsx(S,{displayErrorMessage:!0,children:e.jsx(i.Suspense,{fallback:e.jsx(de,{className:"mt-4"}),children:e.jsx(Ne,{imagesPromise:s,imageRepository:t,service:r})})})}export{Me as component};
