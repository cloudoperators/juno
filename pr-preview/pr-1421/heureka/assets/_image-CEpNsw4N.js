import{Q as U,T as P,j as e,u as B,o as S,c as b,d as C,V as g,U as W,W as Z,Z as J,_ as X,$ as Y,y as ee,a0 as se,a1 as ae,a2 as k,a3 as I,a4 as F,a5 as M,a6 as A,a7 as K,I as re,P as D,n as h,E as R,M as te,a as ne,f as T,a8 as ie,a9 as $,L as le,O as oe,m as ce}from"./App-jcUs3ORZ.js";import{r as n}from"./index-CY86_ltb.js";import{E as w,u as q,g as z,L as O,I as de}from"./IssueCountsPerSeverityLevel-DXQdYO9Q.js";import{S as ue}from"./SectionContentHeading-BNl-0TxW.js";import{I as me}from"./index-CRzHIZw_.js";import{C as xe}from"./CursorPagination-Csx4wWGj.js";import"./IssueTimestamp-CPa_Tnn2.js";const he=({queryClient:a,apiClient:t,filter:s})=>{const o=["remediations",s];return a.ensureQueryData({queryKey:o,queryFn:()=>t.query({query:U,variables:{filter:s}})})},je=({issuesPromise:a,service:t,image:s,onFalsePositiveSuccess:o,onFalsePositiveError:i})=>{const{error:r,data:m}=n.use(a),{vulnerabilities:u}=P(m);return r?e.jsxs(w,{colSpan:5,children:["Error loading vulnerabilities: ",r.message]}):u.length===0?e.jsx(w,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):u.filter(c=>c&&c.name).map(c=>e.jsx(me,{issue:c,service:t,image:s,onFalsePositiveSuccess:o,onFalsePositiveError:i},c.id||c.name))},pe=()=>`
    border-l-2
    border-theme-default
    h-full
    pl-5
  `,ve=({remediation:a,onRevert:t})=>{const[s,o]=n.useState(!1),[i,r]=n.useState(!1),{needsExpansion:m,textRef:u}=B(a.description||""),c=l=>{l.preventDefault(),o(!s)},j=async()=>{r(!0);try{await t(a.remediationId)}catch(l){console.error("Failed to revert remediation:",l)}finally{r(!1)}};return e.jsxs(S,{children:[e.jsx(b,{className:"pl-0",children:e.jsx("div",{className:pe(),children:e.jsx(C,{icon:"checkCircle",color:"success"})})}),e.jsx(b,{className:"whitespace-nowrap",children:e.jsx(g,{gap:"2",direction:"vertical",children:e.jsx("span",{children:a.vulnerability||"N/A"})})}),e.jsx(b,{children:e.jsxs(g,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:u,className:s?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:a.description||"No description available"}),a.description&&m&&e.jsx("a",{href:"#",onClick:c,className:"link-hover",children:e.jsxs(g,{alignment:"center",children:[s?"Show less":"Show more",e.jsx(C,{color:"global-text",icon:s?"expandLess":"expandMore"})]})})]})}),e.jsx(b,{className:"cursor-default interactive",onClick:l=>l.stopPropagation(),children:e.jsx(W,{icon:"moreVert",className:"whitespace-nowrap",disabled:i,children:e.jsx(Z,{children:e.jsx(J,{label:i?"Reverting...":"Revert false positive",onClick:j,disabled:i})})})})]})},ge=async({apiClient:a,remediationId:t})=>{const s=await a.mutate({mutation:X,variables:{id:t}});if(!s.data?.deleteRemediation)throw new Error("Failed to delete remediation");return s.data.deleteRemediation},fe=({remediationsPromise:a,onRevertSuccess:t,onRevertError:s})=>{const{error:o,data:i}=n.use(a),{remediatedVulnerabilities:r}=Y(i),{apiClient:m,queryClient:u}=q({from:"/services/$service"}),c=async(j,l)=>{try{await ge({apiClient:m,remediationId:j}),u.invalidateQueries({queryKey:["remediations"]}),u.invalidateQueries({queryKey:["images"]}),t(l)}catch(p){throw console.error("Failed to delete remediation:",p),s(p instanceof Error?p:new Error("Failed to revert false positive"),l),p}};return o?e.jsxs(w,{colSpan:4,children:["Error loading remediated vulnerabilities: ",o.message]}):r.length===0?e.jsx(w,{colSpan:4,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:r.map(j=>e.jsx(ve,{remediation:j,onRevert:l=>c(l,j.vulnerability||"N/A")},j.remediationId))})},be=({service:a,image:t,setSearchTerm:s,setPageCursor:o,issuesPromise:i,successMessage:r,onFalsePositiveSuccess:m,onFalsePositiveError:u})=>e.jsxs(e.Fragment,{children:[r&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(A,{text:r,variant:"success"})}),e.jsx(K,{className:"mb-4 mt-4"}),e.jsx(g,{gap:"2",className:"mb-4 mt-4",children:e.jsx(re,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:c=>s(c||""),onClear:()=>{s("")}})}),e.jsxs(D,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(S,{children:[e.jsx(h,{children:e.jsx(C,{icon:"monitorHeart"})}),e.jsx(h,{children:"Vulnerability"}),e.jsx(h,{children:"Target Date"}),e.jsx(h,{children:"Description"}),e.jsx(h,{children:"Actions"})]}),i&&e.jsx(R,{displayErrorMessage:!0,fallbackRender:z({colspan:5}),resetKeys:[i],children:e.jsx(n.Suspense,{fallback:e.jsx(O,{colSpan:5}),children:e.jsx(je,{issuesPromise:i,service:a,image:t.repository,onFalsePositiveSuccess:m,onFalsePositiveError:u})})})]}),i&&e.jsx(R,{resetKeys:[i],children:e.jsx(n.Suspense,{children:e.jsx(xe,{dataPromise:i,dataNormalizationMethod:P,goToPage:o})})})]}),ye=({remediationsPromise:a,successMessage:t,onRevertSuccess:s,onRevertError:o})=>e.jsxs(e.Fragment,{children:[t&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(A,{text:t,variant:"success"})}),e.jsx(K,{className:"mb-4 mt-4"}),e.jsx("div",{className:"mt-4",children:e.jsxs(D,{columns:4,minContentColumns:[0,1,3],cellVerticalAlignment:"top",children:[e.jsxs(S,{children:[e.jsx(h,{children:e.jsx(C,{icon:"monitorHeart"})}),e.jsx(h,{children:"Vulnerability"}),e.jsx(h,{children:"Description"}),e.jsx(h,{children:"Actions"})]}),a&&e.jsx(R,{displayErrorMessage:!0,fallbackRender:z({colspan:4}),resetKeys:[a],children:e.jsx(n.Suspense,{fallback:e.jsx(O,{colSpan:4}),children:e.jsx(fe,{remediationsPromise:a,onRevertSuccess:s,onRevertError:o})})})]})})]}),L=5e3,Se=({service:a,image:t})=>{const{apiClient:s,queryClient:o}=q({from:"/services/$service"}),[i,r]=n.useState(void 0),[m,u]=n.useState(void 0),[c,j]=n.useState(0),[l,p]=n.useState(null),[y,d]=n.useState(null),V={status:"open",...i?{search:[i]}:{}},Q=ee({apiClient:s,queryClient:o,filter:{service:[a],repository:[t.repository]},firstVulnerabilities:20,afterVulnerabilities:m,vulFilter:V}),_=he({apiClient:s,queryClient:o,filter:{service:[a],image:[t.repository]}});n.useEffect(()=>{if(!l)return;const x=setTimeout(()=>p(null),L);return()=>clearTimeout(x)},[l]),n.useEffect(()=>{if(!y)return;const x=setTimeout(()=>d(null),L);return()=>clearTimeout(x)},[y]);const G=()=>{const{addMessage:x}=M(),N=n.useCallback(f=>{const v=`Vulnerability ${f} marked as false positive successfully.`;x({variant:"success",text:v}),p(v)},[x]),E=n.useCallback((f,v)=>{x({variant:"error",text:`Failed to mark ${v} as false positive: ${f.message}`})},[x]);return e.jsx(be,{service:a,image:t,setSearchTerm:r,setPageCursor:u,issuesPromise:Q,successMessage:l,onFalsePositiveSuccess:N,onFalsePositiveError:E})},H=()=>{const{addMessage:x}=M(),N=n.useCallback(f=>{const v=`False positive for ${f} reverted successfully.`;x({variant:"success",text:v}),d(v)},[x]),E=n.useCallback((f,v)=>{x({variant:"error",text:`Failed to revert false positive for ${v}: ${f.message}`})},[x]);return e.jsx(ye,{remediationsPromise:_,successMessage:y,onRevertSuccess:N,onRevertError:E})};return e.jsx(e.Fragment,{children:e.jsxs(se,{selectedIndex:c,onSelect:j,variant:"content",children:[e.jsxs(ae,{children:[e.jsx(k,{label:"Vulnerabilities"}),e.jsx(k,{label:"Remediated Vulnerabilities"})]}),e.jsx(I,{children:e.jsx(F,{children:e.jsx(G,{})})}),e.jsx(I,{children:e.jsx(F,{children:e.jsx(H,{})})})]})})},Ce=({imagesPromise:a,imageRepository:t,service:s})=>{const{data:o}=n.use(a),{images:i}=te(o),r=i.find(d=>d.repository===t),[m,u]=n.useState(!1),c=ne();if(!r)return null;const j=d=>{c({to:"/services/$service/images/$image/versions/$version",params:{service:s,image:t,version:d}})},l=r.versions||[],p=m?l:l.slice(0,3),y=l.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(ue,{children:["Image ",r.repository]}),e.jsxs(D,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(S,{children:[e.jsx(h,{children:"Details"}),e.jsx(b,{children:e.jsxs(g,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(T,{pillKey:"repository",pillKeyLabel:"repository",pillValue:r.repository,pillValueLabel:r.repository}),r.versionsCount!==void 0&&r.versionsCount>0&&e.jsx(T,{pillKey:"versions",pillKeyLabel:"versions",pillValue:r.versionsCount.toString(),pillValueLabel:r.versionsCount.toString()})]})})]}),e.jsxs(S,{children:[e.jsx(h,{children:"Vulnerabilities Counts"}),e.jsx(b,{children:e.jsx(de,{counts:r.vulnerabilityCounts})})]}),l.length>0&&e.jsxs(S,{children:[e.jsxs(h,{children:["Versions (",l.length,")"]}),e.jsx(b,{children:e.jsxs(g,{gap:"2",direction:"vertical",children:[p.map(d=>e.jsx("a",{href:"#",title:d.version,onClick:V=>{V.preventDefault(),j(d.version)},className:"link-hover",children:e.jsx("span",{children:ie(d.version)})},d.id)),y&&!m&&e.jsx("a",{href:"#",onClick:d=>{d.preventDefault(),u(!0)},className:"link-hover",children:e.jsxs(g,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(C,{color:"global-text",icon:"expandMore"})]})}),y&&m&&e.jsx("a",{href:"#",onClick:d=>{d.preventDefault(),u(!1)},className:"link-hover",children:e.jsxs(g,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(C,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),s&&t&&r&&e.jsx(Se,{service:s,image:r})]})};function Ie(){const{imagesPromise:a}=$.useLoaderData(),{service:t,image:s}=$.useParams();return le()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(oe,{}):e.jsx(R,{displayErrorMessage:!0,children:e.jsx(n.Suspense,{fallback:e.jsx(ce,{className:"mt-4"}),children:e.jsx(Ce,{imagesPromise:a,imageRepository:s,service:t})})})}export{Ie as component};
