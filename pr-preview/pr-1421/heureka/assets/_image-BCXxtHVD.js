import{Q as te,T as w,j as e,u as re,o as g,c as x,V as j,d as b,g as ne,U as z,W as ae,k as ie,p as le,E as y,P as N,n as u,Z as oe,_ as ce,$ as de,y as E,a0 as ue,a1 as me,a2 as T,a3 as M,a4 as P,a5 as xe,a6 as q,a7 as O,I as he,M as je,a as pe,f as L,a8 as ge,a9 as F,L as ve,O as fe,m as be}from"./App-CC4g3d3p.js";import{r as c}from"./index-B9fEeEr3.js";import{E as S,u as U,g as D,L as I,I as ye}from"./IssueCountsPerSeverityLevel-L3XVUWb8.js";import{S as Se}from"./SectionContentHeading-CfKUwpU0.js";import{I as Ce,a as Re}from"./index-BBEeH9Zk.js";import{I as we}from"./IssueTimestamp-Gb9m-ugM.js";import{C as _}from"./CursorPagination-CWHOG2GG.js";const H=({queryClient:s,apiClient:r,filter:t})=>{const l=["remediations",t];return s.ensureQueryData({queryKey:l,queryFn:()=>r.query({query:te,variables:{filter:t}})})},Ne=({issuesPromise:s,service:r,image:t,onFalsePositiveSuccess:l})=>{const{error:a,data:n}=c.use(s),{vulnerabilities:o}=w(n);return a?e.jsxs(S,{colSpan:5,children:["Error loading vulnerabilities: ",a.message]}):o.length===0?e.jsx(S,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):o.filter(d=>d&&d.name).map(d=>e.jsx(Ce,{issue:d,service:r,image:t,onFalsePositiveSuccess:l},d.id||d.name))},Ve=s=>`
    border-l-2
    ${ne(s.toLowerCase())}
    h-full
    pl-5
  `,De=({issue:s,selected:r,onSelect:t})=>{const[l,a]=c.useState(!1),{needsExpansion:n,textRef:o}=re(s?.description||""),d=i=>{i.preventDefault(),a(!l)};return s?.name?e.jsxs(g,{onClick:t,className:r?"bg-theme-background-selected cursor-pointer":"cursor-pointer",children:[e.jsx(x,{className:"pl-0",children:e.jsx("div",{className:Ve(s.severity),children:e.jsx(Re,{severity:s.severity})})}),e.jsx(x,{className:"whitespace-nowrap",children:e.jsxs(j,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceUrl&&s.sourceUrl!=="-"&&e.jsx("a",{href:s.sourceUrl,target:"_blank",rel:"noopener noreferrer",className:"link-hover",onClick:i=>i.stopPropagation(),children:e.jsxs(j,{gap:"1.5",alignment:"center",children:[e.jsx(b,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Vulnerability source"})]})})]})}),e.jsx(x,{className:"whitespace-nowrap",children:e.jsx(we,{targetDate:s.earliestTargetRemediationDate})}),e.jsx(x,{className:"min-w-0",children:e.jsxs(j,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:o,className:l?"":"whitespace-nowrap overflow-hidden text-ellipsis max-w-full",children:s.description}),s.description&&n&&e.jsx("a",{href:"#",onClick:i=>{i.stopPropagation(),d(i)},className:"link-hover",children:e.jsxs(j,{alignment:"center",children:[l?"Show less":"Show more",e.jsx(b,{color:"global-text",icon:l?"expandLess":"expandMore"})]})})]})})]}):null},$=4,Ie=({issuesPromise:s,remediationsPromise:r,selectedVulnerabilityName:t,onSelectVulnerability:l})=>{const a=c.use(s),n=c.use(r),{error:o,data:d}=a,{data:i}=n,{vulnerabilities:p}=w(d);return z(i),o?e.jsxs(S,{colSpan:$,children:["Error loading remediated vulnerabilities: ",o.message]}):p.length===0?e.jsx(S,{colSpan:$,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:p.map(h=>e.jsx(De,{issue:h,selected:t===h.name,onSelect:()=>l(h.name)},h.id))})},ke=async({apiClient:s,remediationId:r})=>{const t=await s.mutate({mutation:ae,variables:{id:r}});if(!t.data?.deleteRemediation)throw new Error("Failed to delete remediation");return t.data.deleteRemediation},R=6;function A(s){if(!s)return"â€”";try{const r=new Date(s);return Number.isNaN(r.getTime())?s:r.toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"})}catch{return s}}const Ee=({remediationsPromise:s,onRevert:r})=>{const[t,l]=c.useState(null),{error:a,data:n}=c.use(s),{remediatedVulnerabilities:o}=z(n),d=async i=>{l(i.remediationId);try{await r(i.remediationId)}finally{l(null)}};return a?e.jsxs(S,{colSpan:R,children:["Error loading remediations: ",a.message]}):o.length===0?e.jsx(S,{colSpan:R,children:"No remediations found for this vulnerability."}):e.jsx(e.Fragment,{children:o.map(i=>e.jsxs(g,{children:[e.jsx(x,{className:"whitespace-nowrap",children:A(i.expirationDate)}),e.jsx(x,{className:"whitespace-nowrap",children:A(i.remediationDate)}),e.jsx(x,{children:i.remediatedBy??"â€”"}),e.jsx(x,{children:i.type??"â€”"}),e.jsx(x,{children:i.description??"â€”"}),e.jsx(x,{className:"cursor-default interactive",onClick:p=>p.stopPropagation(),children:e.jsx(oe,{icon:"moreVert",className:"whitespace-nowrap",disabled:t===i.remediationId,children:e.jsx(ce,{children:e.jsx(de,{label:t===i.remediationId?"Reverting...":"Revert False Positive",onClick:()=>d(i),disabled:t===i.remediationId})})})})]},i.remediationId))})},Te=({service:s,image:r,vulnerability:t,onClose:l})=>{const{apiClient:a,queryClient:n}=U({from:"/services/$service"}),o=c.useMemo(()=>t?H({apiClient:a,queryClient:n,filter:{service:[s],image:[t],vulnerability:[r]}}):null,[s,r,t,a,n]),d=async i=>{await ke({apiClient:a,remediationId:i}),n.invalidateQueries({queryKey:["remediations"]}),n.invalidateQueries({queryKey:["images"]})};return e.jsx(ie,{heading:t?`Remediations for ${t}`:void 0,opened:!!t,onClose:l,size:"large",children:e.jsx(le,{children:o&&e.jsx(y,{displayErrorMessage:!0,fallbackRender:D({colspan:R}),resetKeys:[o],children:e.jsxs(N,{columns:R,cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(u,{children:"Expiration Date"}),e.jsx(u,{children:"Remediation Date"}),e.jsx(u,{children:"Remediated By"}),e.jsx(u,{children:"Type"}),e.jsx(u,{children:"Description"}),e.jsx(u,{children:"Actions"})]}),e.jsx(c.Suspense,{fallback:e.jsx(I,{colSpan:R}),children:e.jsx(Ee,{remediationsPromise:o,onRevert:d})})]})})})})},Me=({service:s,image:r,setSearchTerm:t,setPageCursor:l,issuesPromise:a,successMessage:n,onFalsePositiveSuccess:o})=>e.jsxs(e.Fragment,{children:[n&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(q,{text:n,variant:"success"})}),e.jsx(O,{className:"mb-4 mt-4"}),e.jsx(j,{gap:"2",className:"mb-4 mt-4",children:e.jsx(he,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:d=>t(d||""),onClear:()=>{t("")}})}),e.jsxs(N,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(u,{children:e.jsx(b,{icon:"monitorHeart"})}),e.jsx(u,{children:"Vulnerability"}),e.jsx(u,{children:"Target Date"}),e.jsx(u,{children:"Description"}),e.jsx(u,{children:"Actions"})]}),a&&e.jsx(y,{displayErrorMessage:!0,fallbackRender:D({colspan:5}),resetKeys:[a],children:e.jsx(c.Suspense,{fallback:e.jsx(I,{colSpan:5}),children:e.jsx(Ne,{issuesPromise:a,service:s,image:r.repository,onFalsePositiveSuccess:o})})})]}),a&&e.jsx(y,{resetKeys:[a],children:e.jsx(c.Suspense,{children:e.jsx(_,{dataPromise:a,dataNormalizationMethod:w,goToPage:l})})})]}),Pe=({service:s,image:r,issuesPromise:t,remediationsPromise:l,setPageCursor:a,successMessage:n})=>{const[o,d]=c.useState(null);return e.jsxs(e.Fragment,{children:[n&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(q,{text:n,variant:"success"})}),e.jsx(O,{className:"mb-4 mt-4"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs(N,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(u,{children:e.jsx(b,{icon:"monitorHeart"})}),e.jsx(u,{children:"Vulnerability"}),e.jsx(u,{children:"Target Date"}),e.jsx(u,{children:"Description"})]}),t&&e.jsx(y,{displayErrorMessage:!0,fallbackRender:D({colspan:4}),resetKeys:[t,l],children:e.jsx(c.Suspense,{fallback:e.jsx(I,{colSpan:4}),children:e.jsx(Ie,{issuesPromise:t,remediationsPromise:l,selectedVulnerabilityName:o,onSelectVulnerability:d})})})]}),t&&e.jsx(y,{resetKeys:[t],children:e.jsx(c.Suspense,{children:e.jsx(_,{dataPromise:t,dataNormalizationMethod:w,goToPage:a})})})]}),e.jsx(Te,{service:s,image:r,vulnerability:o,onClose:()=>d(null)})]})},K=5e3,Le=({service:s,image:r})=>{const{apiClient:t,queryClient:l}=U({from:"/services/$service"}),[a,n]=c.useState(void 0),[o,d]=c.useState(void 0),[i,p]=c.useState(void 0),[h,V]=c.useState(0),[v,m]=c.useState(null),[C,B]=c.useState(null),G={status:"open",...a?{search:[a]}:{}},Q={status:"remediated"},W=E({apiClient:t,queryClient:l,filter:{service:[s],repository:[r.repository]},firstVulnerabilities:20,afterVulnerabilities:o,vulFilter:G}),Z=E({apiClient:t,queryClient:l,filter:{service:[s],repository:[r.repository]},firstVulnerabilities:20,afterVulnerabilities:i,vulFilter:Q}),J=H({apiClient:t,queryClient:l,filter:{service:[s],image:[r.repository]}});c.useEffect(()=>{if(!v)return;const f=setTimeout(()=>m(null),K);return()=>clearTimeout(f)},[v]),c.useEffect(()=>{if(!C)return;const f=setTimeout(()=>B(null),K);return()=>clearTimeout(f)},[C]);const X=()=>{const{addMessage:f}=xe(),ee=c.useCallback(se=>{const k=`Vulnerability ${se} marked as false positive successfully.`;f({variant:"success",text:k}),m(k)},[f]);return e.jsx(Me,{service:s,image:r,setSearchTerm:n,setPageCursor:d,issuesPromise:W,successMessage:v,onFalsePositiveSuccess:ee})},Y=()=>e.jsx(Pe,{service:s,image:r.repository,issuesPromise:Z,remediationsPromise:J,setPageCursor:p,successMessage:C});return e.jsx(e.Fragment,{children:e.jsxs(ue,{selectedIndex:h,onSelect:V,variant:"content",children:[e.jsxs(me,{children:[e.jsx(T,{label:"Active Vulnerabilities"}),e.jsx(T,{label:"Remediated Vulnerabilities"})]}),e.jsx(M,{children:e.jsx(P,{children:e.jsx(X,{})})}),e.jsx(M,{children:e.jsx(P,{children:e.jsx(Y,{})})})]})})},Fe=({imagesPromise:s,imageRepository:r,service:t})=>{const{data:l}=c.use(s),{images:a}=je(l),n=a.find(m=>m.repository===r),[o,d]=c.useState(!1),i=pe();if(!n)return null;const p=m=>{i({to:"/services/$service/images/$image/versions/$version",params:{service:t,image:r,version:m}})},h=n.versions||[],V=o?h:h.slice(0,3),v=h.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(Se,{children:["Image ",n.repository]}),e.jsxs(N,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(g,{children:[e.jsx(u,{children:"Details"}),e.jsx(x,{children:e.jsxs(j,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(L,{pillKey:"repository",pillKeyLabel:"repository",pillValue:n.repository,pillValueLabel:n.repository}),n.versionsCount!==void 0&&n.versionsCount>0&&e.jsx(L,{pillKey:"versions",pillKeyLabel:"versions",pillValue:n.versionsCount.toString(),pillValueLabel:n.versionsCount.toString()})]})})]}),e.jsxs(g,{children:[e.jsx(u,{children:"Vulnerabilities Counts"}),e.jsx(x,{children:e.jsx(ye,{counts:n.vulnerabilityCounts})})]}),h.length>0&&e.jsxs(g,{children:[e.jsxs(u,{children:["Versions (",h.length,")"]}),e.jsx(x,{children:e.jsxs(j,{gap:"2",direction:"vertical",children:[V.map(m=>e.jsx("a",{href:"#",title:m.version,onClick:C=>{C.preventDefault(),p(m.version)},className:"link-hover",children:e.jsx("span",{children:ge(m.version)})},m.id)),v&&!o&&e.jsx("a",{href:"#",onClick:m=>{m.preventDefault(),d(!0)},className:"link-hover",children:e.jsxs(j,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(b,{color:"global-text",icon:"expandMore"})]})}),v&&o&&e.jsx("a",{href:"#",onClick:m=>{m.preventDefault(),d(!1)},className:"link-hover",children:e.jsxs(j,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(b,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),t&&r&&n&&e.jsx(Le,{service:t,image:n})]})};function _e(){const{imagesPromise:s}=F.useLoaderData(),{service:r,image:t}=F.useParams();return ve()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(fe,{}):e.jsx(y,{displayErrorMessage:!0,children:e.jsx(c.Suspense,{fallback:e.jsx(be,{className:"mt-4"}),children:e.jsx(Fe,{imagesPromise:s,imageRepository:t,service:r})})})}export{_e as component};
