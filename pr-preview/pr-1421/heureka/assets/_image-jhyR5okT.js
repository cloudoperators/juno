import{Q as X,T as V,j as e,u as Y,o as v,c as p,V as x,d as f,g as ee,U as se,y as I,W as re,Z as te,_ as E,$ as T,a0 as k,a1 as ae,a2 as $,a3 as z,I as ne,P as D,n as m,E as S,M as ie,a as le,f as M,a4 as oe,a5 as F,L as ce,O as de,m as ue}from"./App-rUQfPDVE.js";import{r as n}from"./index-VGGW3vk0.js";import{E as C,u as me,g as A,L as K,I as xe}from"./IssueCountsPerSeverityLevel-CPnDd2IM.js";import{S as he}from"./SectionContentHeading-DCYqaAXu.js";import{I as je,a as pe}from"./index-CE2dKodG.js";import{I as ge}from"./IssueTimestamp-DL6thSJc.js";import{C as O}from"./CursorPagination-C3Dh4_d6.js";const ve=({queryClient:s,apiClient:r,filter:a})=>{const i=["remediations",a];return s.ensureQueryData({queryKey:i,queryFn:()=>r.query({query:X,variables:{filter:a}})})},fe=({issuesPromise:s,service:r,image:a,onFalsePositiveSuccess:i,onFalsePositiveError:l})=>{const{error:t,data:d}=n.use(s),{vulnerabilities:u}=V(d);return t?e.jsxs(C,{colSpan:5,children:["Error loading vulnerabilities: ",t.message]}):u.length===0?e.jsx(C,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):u.filter(o=>o&&o.name).map(o=>e.jsx(je,{issue:o,service:r,image:a,onFalsePositiveSuccess:i,onFalsePositiveError:l},o.id||o.name))},be=s=>`
    border-l-2
    ${ee(s.toLowerCase())}
    h-full
    pl-5
  `,Se=({issue:s})=>{const[r,a]=n.useState(!1),{needsExpansion:i,textRef:l}=Y(s?.description||""),t=d=>{d.preventDefault(),a(!r)};return s?.name?e.jsxs(v,{children:[e.jsx(p,{className:"pl-0",children:e.jsx("div",{className:be(s.severity),children:e.jsx(pe,{severity:s.severity})})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsxs(x,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceUrl&&s.sourceUrl!=="-"&&e.jsx("a",{href:s.sourceUrl,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(x,{gap:"1.5",alignment:"center",children:[e.jsx(f,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Vulnerability source"})]})})]})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsx(ge,{targetDate:s.earliestTargetRemediationDate})}),e.jsx(p,{className:"min-w-0",children:e.jsxs(x,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:l,className:r?"":"whitespace-nowrap overflow-hidden text-ellipsis max-w-full",children:s.description}),s.description&&i&&e.jsx("a",{href:"#",onClick:t,className:"link-hover",children:e.jsxs(x,{alignment:"center",children:[r?"Show less":"Show more",e.jsx(f,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})]})})]}):null},P=4,ye=({issuesPromise:s,remediationsPromise:r})=>{const a=n.use(s),i=n.use(r),{error:l,data:t}=a,{data:d}=i,{vulnerabilities:u}=V(t);return se(d),l?e.jsxs(C,{colSpan:P,children:["Error loading remediated vulnerabilities: ",l.message]}):u.length===0?e.jsx(C,{colSpan:P,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:u.map(o=>e.jsx(Se,{issue:o},o.id))})},Ce=({service:s,image:r,setSearchTerm:a,setPageCursor:i,issuesPromise:l,successMessage:t,onFalsePositiveSuccess:d,onFalsePositiveError:u})=>e.jsxs(e.Fragment,{children:[t&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx($,{text:t,variant:"success"})}),e.jsx(z,{className:"mb-4 mt-4"}),e.jsx(x,{gap:"2",className:"mb-4 mt-4",children:e.jsx(ne,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:o=>a(o||""),onClear:()=>{a("")}})}),e.jsxs(D,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(m,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"}),e.jsx(m,{children:"Actions"})]}),l&&e.jsx(S,{displayErrorMessage:!0,fallbackRender:A({colspan:5}),resetKeys:[l],children:e.jsx(n.Suspense,{fallback:e.jsx(K,{colSpan:5}),children:e.jsx(fe,{issuesPromise:l,service:s,image:r.repository,onFalsePositiveSuccess:d,onFalsePositiveError:u})})})]}),l&&e.jsx(S,{resetKeys:[l],children:e.jsx(n.Suspense,{children:e.jsx(O,{dataPromise:l,dataNormalizationMethod:V,goToPage:i})})})]}),Ve=({issuesPromise:s,remediationsPromise:r,setPageCursor:a,successMessage:i})=>e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx($,{text:i,variant:"success"})}),e.jsx(z,{className:"mb-4 mt-4"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs(D,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(m,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"})]}),s&&e.jsx(S,{displayErrorMessage:!0,fallbackRender:A({colspan:4}),resetKeys:[s,r],children:e.jsx(n.Suspense,{fallback:e.jsx(K,{colSpan:4}),children:e.jsx(ye,{issuesPromise:s,remediationsPromise:r})})})]}),s&&e.jsx(S,{resetKeys:[s],children:e.jsx(n.Suspense,{children:e.jsx(O,{dataPromise:s,dataNormalizationMethod:V,goToPage:a})})})]})]}),L=5e3,Ne=({service:s,image:r})=>{const{apiClient:a,queryClient:i}=me({from:"/services/$service"}),[l,t]=n.useState(void 0),[d,u]=n.useState(void 0),[o,N]=n.useState(void 0),[j,R]=n.useState(0),[g,c]=n.useState(null),[b,U]=n.useState(null),_={status:"open",...l?{search:[l]}:{}},q={status:"remediated"},G=I({apiClient:a,queryClient:i,filter:{service:[s],repository:[r.repository]},firstVulnerabilities:20,afterVulnerabilities:d,vulFilter:_}),H=I({apiClient:a,queryClient:i,filter:{service:[s],repository:[r.repository]},firstVulnerabilities:20,afterVulnerabilities:o,vulFilter:q}),Q=ve({apiClient:a,queryClient:i,filter:{service:[s],image:[r.repository]}});n.useEffect(()=>{if(!g)return;const h=setTimeout(()=>c(null),L);return()=>clearTimeout(h)},[g]),n.useEffect(()=>{if(!b)return;const h=setTimeout(()=>U(null),L);return()=>clearTimeout(h)},[b]);const B=()=>{const{addMessage:h}=ae(),Z=n.useCallback(w=>{const y=`Vulnerability ${w} marked as false positive successfully.`;h({variant:"success",text:y}),c(y)},[h]),J=n.useCallback((w,y)=>{h({variant:"error",text:`Failed to mark ${y} as false positive: ${w.message}`})},[h]);return e.jsx(Ce,{service:s,image:r,setSearchTerm:t,setPageCursor:u,issuesPromise:G,successMessage:g,onFalsePositiveSuccess:Z,onFalsePositiveError:J})},W=()=>e.jsx(Ve,{issuesPromise:H,remediationsPromise:Q,setPageCursor:N,successMessage:b});return e.jsx(e.Fragment,{children:e.jsxs(re,{selectedIndex:j,onSelect:R,variant:"content",children:[e.jsxs(te,{children:[e.jsx(E,{label:"Active Vulnerabilities"}),e.jsx(E,{label:"Remediated Vulnerabilities"})]}),e.jsx(T,{children:e.jsx(k,{children:e.jsx(B,{})})}),e.jsx(T,{children:e.jsx(k,{children:e.jsx(W,{})})})]})})},Re=({imagesPromise:s,imageRepository:r,service:a})=>{const{data:i}=n.use(s),{images:l}=ie(i),t=l.find(c=>c.repository===r),[d,u]=n.useState(!1),o=le();if(!t)return null;const N=c=>{o({to:"/services/$service/images/$image/versions/$version",params:{service:a,image:r,version:c}})},j=t.versions||[],R=d?j:j.slice(0,3),g=j.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(he,{children:["Image ",t.repository]}),e.jsxs(D,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(v,{children:[e.jsx(m,{children:"Details"}),e.jsx(p,{children:e.jsxs(x,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(M,{pillKey:"repository",pillKeyLabel:"repository",pillValue:t.repository,pillValueLabel:t.repository}),t.versionsCount!==void 0&&t.versionsCount>0&&e.jsx(M,{pillKey:"versions",pillKeyLabel:"versions",pillValue:t.versionsCount.toString(),pillValueLabel:t.versionsCount.toString()})]})})]}),e.jsxs(v,{children:[e.jsx(m,{children:"Vulnerabilities Counts"}),e.jsx(p,{children:e.jsx(xe,{counts:t.vulnerabilityCounts})})]}),j.length>0&&e.jsxs(v,{children:[e.jsxs(m,{children:["Versions (",j.length,")"]}),e.jsx(p,{children:e.jsxs(x,{gap:"2",direction:"vertical",children:[R.map(c=>e.jsx("a",{href:"#",title:c.version,onClick:b=>{b.preventDefault(),N(c.version)},className:"link-hover",children:e.jsx("span",{children:oe(c.version)})},c.id)),g&&!d&&e.jsx("a",{href:"#",onClick:c=>{c.preventDefault(),u(!0)},className:"link-hover",children:e.jsxs(x,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(f,{color:"global-text",icon:"expandMore"})]})}),g&&d&&e.jsx("a",{href:"#",onClick:c=>{c.preventDefault(),u(!1)},className:"link-hover",children:e.jsxs(x,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(f,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),a&&r&&t&&e.jsx(Ne,{service:a,image:t})]})};function Fe(){const{imagesPromise:s}=F.useLoaderData(),{service:r,image:a}=F.useParams();return ce()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(de,{}):e.jsx(S,{displayErrorMessage:!0,children:e.jsx(n.Suspense,{fallback:e.jsx(ue,{className:"mt-4"}),children:e.jsx(Re,{imagesPromise:s,imageRepository:a,service:r})})})}export{Fe as component};
