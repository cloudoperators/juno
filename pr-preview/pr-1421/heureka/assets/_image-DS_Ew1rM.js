import{Q as z,T,j as e,u as O,o as b,c as f,d as y,V as v,U as Q,W as H,Z as G,_ as B,$ as U,y as W,a0 as Z,a1 as _,a2 as E,a3 as I,a4 as F,a5 as $,a6 as M,I as J,P as k,n as h,E as R,M as X,a as Y,f as L,a7 as P,L as ee,O as se,m as re}from"./App-BbqoobHA.js";import{r as l}from"./index-CLcfsAyo.js";import{E as w,u as K,g as q,L as A,I as ae}from"./IssueCountsPerSeverityLevel-CSSUyX9U.js";import{S as te}from"./SectionContentHeading-DQjFjhxZ.js";import{I as ne}from"./index-sfJOOZQ4.js";import{C as ie}from"./CursorPagination-BObwo6Z9.js";import"./IssueTimestamp-DdbnaeP_.js";const le=({queryClient:r,apiClient:t,filter:s})=>{const o=["remediations",s];return r.ensureQueryData({queryKey:o,queryFn:()=>t.query({query:z,variables:{filter:s}})})},oe=({issuesPromise:r,service:t,image:s,onFalsePositiveSuccess:o,onFalsePositiveError:n})=>{const{error:a,data:u}=l.use(r),{vulnerabilities:c}=T(u);return a?e.jsxs(w,{colSpan:5,children:["Error loading vulnerabilities: ",a.message]}):c.length===0?e.jsx(w,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):c.filter(d=>d&&d.name).map(d=>e.jsx(ne,{issue:d,service:t,image:s,onFalsePositiveSuccess:o,onFalsePositiveError:n},d.id||d.name))},ce=()=>`
    border-l-2
    border-theme-default
    h-full
    pl-5
  `,de=({remediation:r,onRevert:t})=>{const[s,o]=l.useState(!1),[n,a]=l.useState(!1),{needsExpansion:u,textRef:c}=O(r.description||""),d=i=>{i.preventDefault(),o(!s)},m=async()=>{a(!0);try{await t(r.remediationId)}catch(i){console.error("Failed to revert remediation:",i)}finally{a(!1)}};return e.jsxs(b,{children:[e.jsx(f,{className:"pl-0",children:e.jsx("div",{className:ce(),children:e.jsx(y,{icon:"checkCircle",color:"success"})})}),e.jsx(f,{className:"whitespace-nowrap",children:e.jsx(v,{gap:"2",direction:"vertical",children:e.jsx("span",{children:r.vulnerability||"N/A"})})}),e.jsx(f,{children:e.jsxs(v,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:c,className:s?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:r.description||"No description available"}),r.description&&u&&e.jsx("a",{href:"#",onClick:d,className:"link-hover",children:e.jsxs(v,{alignment:"center",children:[s?"Show less":"Show more",e.jsx(y,{color:"global-text",icon:s?"expandLess":"expandMore"})]})})]})}),e.jsx(f,{className:"cursor-default interactive",onClick:i=>i.stopPropagation(),children:e.jsx(Q,{icon:"moreVert",className:"whitespace-nowrap",disabled:n,children:e.jsx(H,{children:e.jsx(G,{label:n?"Reverting...":"Revert false positive",onClick:m,disabled:n})})})})]})},ue=async({apiClient:r,remediationId:t})=>{const s=await r.mutate({mutation:B,variables:{id:t}});if(!s.data?.deleteRemediation)throw new Error("Failed to delete remediation");return s.data.deleteRemediation},xe=({remediationsPromise:r,onRevertSuccess:t,onRevertError:s})=>{const{error:o,data:n}=l.use(r),{remediatedVulnerabilities:a}=U(n),{apiClient:u,queryClient:c}=K({from:"/services/$service"}),d=async(m,i)=>{try{await ue({apiClient:u,remediationId:m}),c.invalidateQueries({queryKey:["remediations"]}),c.invalidateQueries({queryKey:["images"]}),t(i)}catch(j){throw console.error("Failed to delete remediation:",j),s(j instanceof Error?j:new Error("Failed to revert false positive"),i),j}};return o?e.jsxs(w,{colSpan:4,children:["Error loading remediated vulnerabilities: ",o.message]}):a.length===0?e.jsx(w,{colSpan:4,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:a.map(m=>e.jsx(de,{remediation:m,onRevert:i=>d(i,m.vulnerability||"N/A")},m.remediationId))})},he=({service:r,image:t,setSearchTerm:s,setPageCursor:o,issuesPromise:n,onFalsePositiveSuccess:a,onFalsePositiveError:u})=>e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"mb-4 mt-4"}),e.jsx(v,{gap:"2",className:"mb-4 mt-4",children:e.jsx(J,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:c=>s(c||""),onClear:()=>{s("")}})}),e.jsxs(k,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(b,{children:[e.jsx(h,{children:e.jsx(y,{icon:"monitorHeart"})}),e.jsx(h,{children:"Vulnerability"}),e.jsx(h,{children:"Target Date"}),e.jsx(h,{children:"Description"}),e.jsx(h,{children:"Actions"})]}),n&&e.jsx(R,{displayErrorMessage:!0,fallbackRender:q({colspan:5}),resetKeys:[n],children:e.jsx(l.Suspense,{fallback:e.jsx(A,{colSpan:5}),children:e.jsx(oe,{issuesPromise:n,service:r,image:t.repository,onFalsePositiveSuccess:a,onFalsePositiveError:u})})})]}),n&&e.jsx(R,{resetKeys:[n],children:e.jsx(l.Suspense,{children:e.jsx(ie,{dataPromise:n,dataNormalizationMethod:T,goToPage:o})})})]}),me=({remediationsPromise:r,onRevertSuccess:t,onRevertError:s})=>e.jsxs(e.Fragment,{children:[e.jsx(M,{className:"mb-4 mt-4"}),e.jsx("div",{className:"mt-4",children:e.jsxs(k,{columns:4,minContentColumns:[0,1,3],cellVerticalAlignment:"top",children:[e.jsxs(b,{children:[e.jsx(h,{children:e.jsx(y,{icon:"monitorHeart"})}),e.jsx(h,{children:"Vulnerability"}),e.jsx(h,{children:"Description"}),e.jsx(h,{children:"Actions"})]}),r&&e.jsx(R,{displayErrorMessage:!0,fallbackRender:q({colspan:4}),resetKeys:[r],children:e.jsx(l.Suspense,{fallback:e.jsx(A,{colSpan:4}),children:e.jsx(xe,{remediationsPromise:r,onRevertSuccess:t,onRevertError:s})})})]})})]}),pe=({service:r,image:t})=>{const{apiClient:s,queryClient:o}=K({from:"/services/$service"}),[n,a]=l.useState(void 0),[u,c]=l.useState(void 0),[d,m]=l.useState(0),i=n?{search:[n]}:void 0,j=W({apiClient:s,queryClient:o,filter:{service:[r],repository:[t.repository]},firstVulnerabilities:20,afterVulnerabilities:u,vulFilter:i}),C=le({apiClient:s,queryClient:o,filter:{service:[r],image:[t.repository]}}),x=()=>{const{addMessage:p}=$(),V=l.useCallback(g=>{p({variant:"success",text:`Vulnerability ${g} marked as false positive successfully.`})},[p]),N=l.useCallback((g,D)=>{p({variant:"error",text:`Failed to mark ${D} as false positive: ${g.message}`})},[p]);return e.jsx(he,{service:r,image:t,setSearchTerm:a,setPageCursor:c,issuesPromise:j,onFalsePositiveSuccess:V,onFalsePositiveError:N})},S=()=>{const{addMessage:p}=$(),V=l.useCallback(g=>{p({variant:"success",text:`False positive for ${g} reverted successfully.`})},[p]),N=l.useCallback((g,D)=>{p({variant:"error",text:`Failed to revert false positive for ${D}: ${g.message}`})},[p]);return e.jsx(me,{remediationsPromise:C,onRevertSuccess:V,onRevertError:N})};return e.jsx(e.Fragment,{children:e.jsxs(Z,{selectedIndex:d,onSelect:m,variant:"content",children:[e.jsxs(_,{children:[e.jsx(E,{label:"Vulnerabilities"}),e.jsx(E,{label:"Remediated Vulnerabilities"})]}),e.jsx(I,{children:e.jsx(F,{children:e.jsx(x,{})})}),e.jsx(I,{children:e.jsx(F,{children:e.jsx(S,{})})})]})})},je=({imagesPromise:r,imageRepository:t,service:s})=>{const{data:o}=l.use(r),{images:n}=X(o),a=n.find(x=>x.repository===t),[u,c]=l.useState(!1),d=Y();if(!a)return null;const m=x=>{d({to:"/services/$service/images/$image/versions/$version",params:{service:s,image:t,version:x}})},i=a.versions||[],j=u?i:i.slice(0,3),C=i.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(te,{children:["Image ",a.repository]}),e.jsxs(k,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(b,{children:[e.jsx(h,{children:"Details"}),e.jsx(f,{children:e.jsxs(v,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(L,{pillKey:"repository",pillKeyLabel:"repository",pillValue:a.repository,pillValueLabel:a.repository}),a.versionsCount!==void 0&&a.versionsCount>0&&e.jsx(L,{pillKey:"versions",pillKeyLabel:"versions",pillValue:a.versionsCount.toString(),pillValueLabel:a.versionsCount.toString()})]})})]}),e.jsxs(b,{children:[e.jsx(h,{children:"Vulnerabilities Counts"}),e.jsx(f,{children:e.jsx(ae,{counts:a.vulnerabilityCounts})})]}),i.length>0&&e.jsxs(b,{children:[e.jsxs(h,{children:["Versions (",i.length,")"]}),e.jsx(f,{children:e.jsxs(v,{gap:"2",direction:"vertical",children:[j.map(x=>e.jsx("a",{href:"#",onClick:S=>{S.preventDefault(),m(x.version)},className:"link-hover",children:e.jsx("span",{children:x.version})},x.id)),C&&!u&&e.jsx("a",{href:"#",onClick:x=>{x.preventDefault(),c(!0)},className:"link-hover",children:e.jsxs(v,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(y,{color:"global-text",icon:"expandMore"})]})}),C&&u&&e.jsx("a",{href:"#",onClick:x=>{x.preventDefault(),c(!1)},className:"link-hover",children:e.jsxs(v,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(y,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),s&&t&&a&&e.jsx(pe,{service:s,image:a})]})};function we(){const{imagesPromise:r}=P.useLoaderData(),{service:t,image:s}=P.useParams();return ee()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(se,{}):e.jsx(R,{displayErrorMessage:!0,children:e.jsx(l.Suspense,{fallback:e.jsx(re,{className:"mt-4"}),children:e.jsx(je,{imagesPromise:r,imageRepository:s,service:t})})})}export{we as component};
