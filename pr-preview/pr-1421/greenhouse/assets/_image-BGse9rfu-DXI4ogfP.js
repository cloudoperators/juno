import{a5 as E,j as e,L as Y,O,E as b,m as ee,M as se,a as ie,P as k,o as g,n as m,c as p,V as x,f as w,a4 as re,d as f,y as T,W as ae,Z as ne,_ as K,$ as L,a0 as D,Q as le,a1 as te,a2 as q,a3 as R,I as oe,T as S,U as ce,u as de,g as ue}from"./App-BQk8RP7q-CnbQkqTu.js";import{G as n}from"./_extensionId._-C6qpIImd.js";import{E as me,C as xe,f as z,b as U,a as P}from"./IssueCountsPerSeverityLevel-BfkLaxaZ-C4QMKi9f.js";import{n as he}from"./SectionContentHeading-DkaJxedS-kEX7qM4H.js";import{e as je,B as pe}from"./index-BAGedx1p-CtAx7K92.js";import{s as ve}from"./IssueTimestamp-LJ96Sk7H-BnG4TUVY.js";import{g as X}from"./CursorPagination-uK4EcnKd-Kk617Nsi.js";import"./index-Dix4Az1T.js";import"./Shell-CWncoRB9.js";import"./index-CK2QkhwD.js";const ge=({queryClient:s,apiClient:i,filter:a})=>{const l=["remediations",a];return s.ensureQueryData({queryKey:l,queryFn:()=>i.query({query:le,variables:{filter:a}})})},fe=({issuesPromise:s,service:i,image:a,onFalsePositiveSuccess:l,onFalsePositiveError:t})=>{const{error:r,data:d}=n.use(s),{vulnerabilities:u}=S(d);return r?e.jsxs(P,{colSpan:5,children:["Error loading vulnerabilities: ",r.message]}):u.length===0?e.jsx(P,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):u.filter(o=>o&&o.name).map(o=>e.jsx(je,{issue:o,service:i,image:a,onFalsePositiveSuccess:l,onFalsePositiveError:t},o.id||o.name))},ye=s=>`
    border-l-2
    ${ue(s.toLowerCase())}
    h-full
    pl-5
  `,be=({issue:s})=>{const[i,a]=n.useState(!1),{needsExpansion:l,textRef:t}=de(s?.description||""),r=d=>{d.preventDefault(),a(!i)};return s?.name?e.jsxs(g,{children:[e.jsx(p,{className:"pl-0",children:e.jsx("div",{className:ye(s.severity),children:e.jsx(pe,{severity:s.severity})})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsxs(x,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceUrl&&s.sourceUrl!=="-"&&e.jsx("a",{href:s.sourceUrl,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(x,{gap:"1.5",alignment:"center",children:[e.jsx(f,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Vulnerability source"})]})})]})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsx(ve,{targetDate:s.earliestTargetRemediationDate})}),e.jsx(p,{className:"min-w-0",children:e.jsxs(x,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:t,className:i?"":"whitespace-nowrap overflow-hidden text-ellipsis max-w-full",children:s.description}),s.description&&l&&e.jsx("a",{href:"#",onClick:r,className:"link-hover",children:e.jsxs(x,{alignment:"center",children:[i?"Show less":"Show more",e.jsx(f,{color:"global-text",icon:i?"expandLess":"expandMore"})]})})]})})]}):null},M=4,Ce=({issuesPromise:s,remediationsPromise:i})=>{const a=n.use(s),l=n.use(i),{error:t,data:r}=a,{data:d}=l,{vulnerabilities:u}=S(r);return ce(d),t?e.jsxs(P,{colSpan:M,children:["Error loading remediated vulnerabilities: ",t.message]}):u.length===0?e.jsx(P,{colSpan:M,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:u.map(o=>e.jsx(be,{issue:o},o.id))})},Pe=({service:s,image:i,setSearchTerm:a,setPageCursor:l,issuesPromise:t,successMessage:r,onFalsePositiveSuccess:d,onFalsePositiveError:u})=>e.jsxs(e.Fragment,{children:[r&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(q,{text:r,variant:"success"})}),e.jsx(R,{className:"mb-4 mt-4"}),e.jsx(x,{gap:"2",className:"mb-4 mt-4",children:e.jsx(oe,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:o=>a(o||""),onClear:()=>{a("")}})}),e.jsxs(k,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(m,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"}),e.jsx(m,{children:"Actions"})]}),t&&e.jsx(b,{displayErrorMessage:!0,fallbackRender:z({colspan:5}),resetKeys:[t],children:e.jsx(n.Suspense,{fallback:e.jsx(U,{colSpan:5}),children:e.jsx(fe,{issuesPromise:t,service:s,image:i.repository,onFalsePositiveSuccess:d,onFalsePositiveError:u})})})]}),t&&e.jsx(b,{resetKeys:[t],children:e.jsx(n.Suspense,{children:e.jsx(X,{dataPromise:t,dataNormalizationMethod:S,goToPage:l})})})]}),Se=({issuesPromise:s,remediationsPromise:i,setPageCursor:a,successMessage:l})=>e.jsxs(e.Fragment,{children:[l&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(q,{text:l,variant:"success"})}),e.jsx(R,{className:"mb-4 mt-4"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs(k,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(m,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"})]}),s&&e.jsx(b,{displayErrorMessage:!0,fallbackRender:z({colspan:4}),resetKeys:[s,i],children:e.jsx(n.Suspense,{fallback:e.jsx(U,{colSpan:4}),children:e.jsx(Ce,{issuesPromise:s,remediationsPromise:i})})})]}),s&&e.jsx(b,{resetKeys:[s],children:e.jsx(n.Suspense,{children:e.jsx(X,{dataPromise:s,dataNormalizationMethod:S,goToPage:a})})})]})]}),H=5e3,Ne=({service:s,image:i})=>{const{apiClient:a,queryClient:l}=xe({from:"/services/$service"}),[t,r]=n.useState(void 0),[d,u]=n.useState(void 0),[o,N]=n.useState(void 0),[j,V]=n.useState(0),[v,c]=n.useState(null),[y,W]=n.useState(null),$={status:"open",...t?{search:[t]}:{}},A={status:"remediated"},I=T({apiClient:a,queryClient:l,filter:{service:[s],repository:[i.repository]},firstVulnerabilities:20,afterVulnerabilities:d,vulFilter:$}),J=T({apiClient:a,queryClient:l,filter:{service:[s],repository:[i.repository]},firstVulnerabilities:20,afterVulnerabilities:o,vulFilter:A}),Z=ge({apiClient:a,queryClient:l,filter:{service:[s],image:[i.repository]}});n.useEffect(()=>{if(!v)return;const h=setTimeout(()=>c(null),H);return()=>clearTimeout(h)},[v]),n.useEffect(()=>{if(!y)return;const h=setTimeout(()=>W(null),H);return()=>clearTimeout(h)},[y]);const G=()=>{const{addMessage:h}=te(),_=n.useCallback(F=>{const C=`Vulnerability ${F} marked as false positive successfully.`;h({variant:"success",text:C}),c(C)},[h]),B=n.useCallback((F,C)=>{h({variant:"error",text:`Failed to mark ${C} as false positive: ${F.message}`})},[h]);return e.jsx(Pe,{service:s,image:i,setSearchTerm:r,setPageCursor:u,issuesPromise:I,successMessage:v,onFalsePositiveSuccess:_,onFalsePositiveError:B})},Q=()=>e.jsx(Se,{issuesPromise:J,remediationsPromise:Z,setPageCursor:N,successMessage:y});return e.jsx(e.Fragment,{children:e.jsxs(ae,{selectedIndex:j,onSelect:V,variant:"content",children:[e.jsxs(ne,{children:[e.jsx(K,{label:"Active Vulnerabilities"}),e.jsx(K,{label:"Remediated Vulnerabilities"})]}),e.jsx(L,{children:e.jsx(D,{children:e.jsx(G,{})})}),e.jsx(L,{children:e.jsx(D,{children:e.jsx(Q,{})})})]})})},Ve=({imagesPromise:s,imageRepository:i,service:a})=>{const{data:l}=n.use(s),{images:t}=se(l),r=t.find(c=>c.repository===i),[d,u]=n.useState(!1),o=ie();if(!r)return null;const N=c=>{o({to:"/services/$service/images/$image/versions/$version",params:{service:a,image:i,version:c}})},j=r.versions||[],V=d?j:j.slice(0,3),v=j.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(he,{children:["Image ",r.repository]}),e.jsxs(k,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(g,{children:[e.jsx(m,{children:"Details"}),e.jsx(p,{children:e.jsxs(x,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(w,{pillKey:"repository",pillKeyLabel:"repository",pillValue:r.repository,pillValueLabel:r.repository}),r.versionsCount!==void 0&&r.versionsCount>0&&e.jsx(w,{pillKey:"versions",pillKeyLabel:"versions",pillValue:r.versionsCount.toString(),pillValueLabel:r.versionsCount.toString()})]})})]}),e.jsxs(g,{children:[e.jsx(m,{children:"Vulnerabilities Counts"}),e.jsx(p,{children:e.jsx(me,{counts:r.vulnerabilityCounts})})]}),j.length>0&&e.jsxs(g,{children:[e.jsxs(m,{children:["Versions (",j.length,")"]}),e.jsx(p,{children:e.jsxs(x,{gap:"2",direction:"vertical",children:[V.map(c=>e.jsx("a",{href:"#",title:c.version,onClick:y=>{y.preventDefault(),N(c.version)},className:"link-hover",children:e.jsx("span",{children:re(c.version)})},c.id)),v&&!d&&e.jsx("a",{href:"#",onClick:c=>{c.preventDefault(),u(!0)},className:"link-hover",children:e.jsxs(x,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(f,{color:"global-text",icon:"expandMore"})]})}),v&&d&&e.jsx("a",{href:"#",onClick:c=>{c.preventDefault(),u(!1)},className:"link-hover",children:e.jsxs(x,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(f,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),a&&i&&r&&e.jsx(Ne,{service:a,image:r})]})};function qe(){const{imagesPromise:s}=E.useLoaderData(),{service:i,image:a}=E.useParams();return Y()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(O,{}):e.jsx(b,{displayErrorMessage:!0,children:e.jsx(n.Suspense,{fallback:e.jsx(ee,{className:"mt-4"}),children:e.jsx(Ve,{imagesPromise:s,imageRepository:a,service:i})})})}export{qe as component};
