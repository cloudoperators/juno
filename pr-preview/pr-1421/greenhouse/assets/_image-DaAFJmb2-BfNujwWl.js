import{a9 as w,j as e,L as J,O as Z,E as P,m as _,M as B,a as O,P as R,o as C,n as h,c as y,V as g,f as V,a8 as U,d as S,y as Y,a0 as ee,a1 as se,a2 as K,a3 as H,a4 as $,Q as re,a5 as L,a6 as q,a7 as T,I as ie,T as D,$ as ae,u as ne,U as te,W as le,Z as oe,_ as ce}from"./App-D9HKdvlg-BRh-Fi_d.js";import{G as n}from"./_extensionId._-CytiG_xx.js";import{E as de,C as I,f as A,b as Q,a as E}from"./IssueCountsPerSeverityLevel-BBfw2S8R-BJs_Yk0h.js";import{n as me}from"./SectionContentHeading-Cn23HaEO-BpQhWimp.js";import{H as ue}from"./index-uo9MLYzY-eVrpt-bS.js";import{g as xe}from"./CursorPagination-Bwo_yUxs-CniofpaK.js";import"./index-qkF2fjjl.js";import"./Shell-Bziu4l_E.js";import"./index-DRskXj0V.js";import"./IssueTimestamp-BBoGe0js-DPJV2gyK.js";const he=({queryClient:r,apiClient:a,filter:s})=>{const o=["remediations",s];return r.ensureQueryData({queryKey:o,queryFn:()=>a.query({query:re,variables:{filter:s}})})},pe=({issuesPromise:r,service:a,image:s,onFalsePositiveSuccess:o,onFalsePositiveError:l})=>{const{error:i,data:u}=n.use(r),{vulnerabilities:m}=D(u);return i?e.jsxs(E,{colSpan:5,children:["Error loading vulnerabilities: ",i.message]}):m.length===0?e.jsx(E,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):m.filter(c=>c&&c.name).map(c=>e.jsx(ue,{issue:c,service:a,image:s,onFalsePositiveSuccess:o,onFalsePositiveError:l},c.id||c.name))},ve=()=>`
    border-l-2
    border-theme-default
    h-full
    pl-5
  `,je=({remediation:r,onRevert:a})=>{const[s,o]=n.useState(!1),[l,i]=n.useState(!1),{needsExpansion:u,textRef:m}=ne(r.description||""),c=t=>{t.preventDefault(),o(!s)},p=async()=>{i(!0);try{await a(r.remediationId)}catch(t){console.error("Failed to revert remediation:",t)}finally{i(!1)}};return e.jsxs(C,{children:[e.jsx(y,{className:"pl-0",children:e.jsx("div",{className:ve(),children:e.jsx(S,{icon:"checkCircle",color:"success"})})}),e.jsx(y,{className:"whitespace-nowrap",children:e.jsx(g,{gap:"2",direction:"vertical",children:e.jsx("span",{children:r.vulnerability||"N/A"})})}),e.jsx(y,{children:e.jsxs(g,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:m,className:s?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:r.description||"No description available"}),r.description&&u&&e.jsx("a",{href:"#",onClick:c,className:"link-hover",children:e.jsxs(g,{alignment:"center",children:[s?"Show less":"Show more",e.jsx(S,{color:"global-text",icon:s?"expandLess":"expandMore"})]})})]})}),e.jsx(y,{className:"cursor-default interactive",onClick:t=>t.stopPropagation(),children:e.jsx(te,{icon:"moreVert",className:"whitespace-nowrap",disabled:l,children:e.jsx(le,{children:e.jsx(oe,{label:l?"Reverting...":"Revert false positive",onClick:p,disabled:l})})})})]})},ge=async({apiClient:r,remediationId:a})=>{const s=await r.mutate({mutation:ce,variables:{id:a}});if(!s.data?.deleteRemediation)throw new Error("Failed to delete remediation");return s.data.deleteRemediation},fe=({remediationsPromise:r,onRevertSuccess:a,onRevertError:s})=>{const{error:o,data:l}=n.use(r),{remediatedVulnerabilities:i}=ae(l),{apiClient:u,queryClient:m}=I({from:"/services/$service"}),c=async(p,t)=>{try{await ge({apiClient:u,remediationId:p}),m.invalidateQueries({queryKey:["remediations"]}),m.invalidateQueries({queryKey:["images"]}),a(t)}catch(v){throw console.error("Failed to delete remediation:",v),s(v instanceof Error?v:new Error("Failed to revert false positive"),t),v}};return o?e.jsxs(E,{colSpan:4,children:["Error loading remediated vulnerabilities: ",o.message]}):i.length===0?e.jsx(E,{colSpan:4,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:i.map(p=>e.jsx(je,{remediation:p,onRevert:t=>c(t,p.vulnerability||"N/A")},p.remediationId))})},ye=({service:r,image:a,setSearchTerm:s,setPageCursor:o,issuesPromise:l,successMessage:i,onFalsePositiveSuccess:u,onFalsePositiveError:m})=>e.jsxs(e.Fragment,{children:[i&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(q,{text:i,variant:"success"})}),e.jsx(T,{className:"mb-4 mt-4"}),e.jsx(g,{gap:"2",className:"mb-4 mt-4",children:e.jsx(ie,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:c=>s(c||""),onClear:()=>{s("")}})}),e.jsxs(R,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(C,{children:[e.jsx(h,{children:e.jsx(S,{icon:"monitorHeart"})}),e.jsx(h,{children:"Vulnerability"}),e.jsx(h,{children:"Target Date"}),e.jsx(h,{children:"Description"}),e.jsx(h,{children:"Actions"})]}),l&&e.jsx(P,{displayErrorMessage:!0,fallbackRender:A({colspan:5}),resetKeys:[l],children:e.jsx(n.Suspense,{fallback:e.jsx(Q,{colSpan:5}),children:e.jsx(pe,{issuesPromise:l,service:r,image:a.repository,onFalsePositiveSuccess:u,onFalsePositiveError:m})})})]}),l&&e.jsx(P,{resetKeys:[l],children:e.jsx(n.Suspense,{children:e.jsx(xe,{dataPromise:l,dataNormalizationMethod:D,goToPage:o})})})]}),be=({remediationsPromise:r,successMessage:a,onRevertSuccess:s,onRevertError:o})=>e.jsxs(e.Fragment,{children:[a&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(q,{text:a,variant:"success"})}),e.jsx(T,{className:"mb-4 mt-4"}),e.jsx("div",{className:"mt-4",children:e.jsxs(R,{columns:4,minContentColumns:[0,1,3],cellVerticalAlignment:"top",children:[e.jsxs(C,{children:[e.jsx(h,{children:e.jsx(S,{icon:"monitorHeart"})}),e.jsx(h,{children:"Vulnerability"}),e.jsx(h,{children:"Description"}),e.jsx(h,{children:"Actions"})]}),r&&e.jsx(P,{displayErrorMessage:!0,fallbackRender:A({colspan:4}),resetKeys:[r],children:e.jsx(n.Suspense,{fallback:e.jsx(Q,{colSpan:4}),children:e.jsx(fe,{remediationsPromise:r,onRevertSuccess:s,onRevertError:o})})})]})})]}),M=5e3,Ce=({service:r,image:a})=>{const{apiClient:s,queryClient:o}=I({from:"/services/$service"}),[l,i]=n.useState(void 0),[u,m]=n.useState(void 0),[c,p]=n.useState(0),[t,v]=n.useState(null),[b,d]=n.useState(null),N={status:"open",...l?{search:[l]}:{}},X=Y({apiClient:s,queryClient:o,filter:{service:[r],repository:[a.repository]},firstVulnerabilities:20,afterVulnerabilities:u,vulFilter:N}),W=he({apiClient:s,queryClient:o,filter:{service:[r],image:[a.repository]}});n.useEffect(()=>{if(!t)return;const x=setTimeout(()=>v(null),M);return()=>clearTimeout(x)},[t]),n.useEffect(()=>{if(!b)return;const x=setTimeout(()=>d(null),M);return()=>clearTimeout(x)},[b]);const z=()=>{const{addMessage:x}=L(),F=n.useCallback(f=>{const j=`Vulnerability ${f} marked as false positive successfully.`;x({variant:"success",text:j}),v(j)},[x]),k=n.useCallback((f,j)=>{x({variant:"error",text:`Failed to mark ${j} as false positive: ${f.message}`})},[x]);return e.jsx(ye,{service:r,image:a,setSearchTerm:i,setPageCursor:m,issuesPromise:X,successMessage:t,onFalsePositiveSuccess:F,onFalsePositiveError:k})},G=()=>{const{addMessage:x}=L(),F=n.useCallback(f=>{const j=`False positive for ${f} reverted successfully.`;x({variant:"success",text:j}),d(j)},[x]),k=n.useCallback((f,j)=>{x({variant:"error",text:`Failed to revert false positive for ${j}: ${f.message}`})},[x]);return e.jsx(be,{remediationsPromise:W,successMessage:b,onRevertSuccess:F,onRevertError:k})};return e.jsx(e.Fragment,{children:e.jsxs(ee,{selectedIndex:c,onSelect:p,variant:"content",children:[e.jsxs(se,{children:[e.jsx(K,{label:"Vulnerabilities"}),e.jsx(K,{label:"Remediated Vulnerabilities"})]}),e.jsx(H,{children:e.jsx($,{children:e.jsx(z,{})})}),e.jsx(H,{children:e.jsx($,{children:e.jsx(G,{})})})]})})},Se=({imagesPromise:r,imageRepository:a,service:s})=>{const{data:o}=n.use(r),{images:l}=B(o),i=l.find(d=>d.repository===a),[u,m]=n.useState(!1),c=O();if(!i)return null;const p=d=>{c({to:"/services/$service/images/$image/versions/$version",params:{service:s,image:a,version:d}})},t=i.versions||[],v=u?t:t.slice(0,3),b=t.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(me,{children:["Image ",i.repository]}),e.jsxs(R,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(C,{children:[e.jsx(h,{children:"Details"}),e.jsx(y,{children:e.jsxs(g,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(V,{pillKey:"repository",pillKeyLabel:"repository",pillValue:i.repository,pillValueLabel:i.repository}),i.versionsCount!==void 0&&i.versionsCount>0&&e.jsx(V,{pillKey:"versions",pillKeyLabel:"versions",pillValue:i.versionsCount.toString(),pillValueLabel:i.versionsCount.toString()})]})})]}),e.jsxs(C,{children:[e.jsx(h,{children:"Vulnerabilities Counts"}),e.jsx(y,{children:e.jsx(de,{counts:i.vulnerabilityCounts})})]}),t.length>0&&e.jsxs(C,{children:[e.jsxs(h,{children:["Versions (",t.length,")"]}),e.jsx(y,{children:e.jsxs(g,{gap:"2",direction:"vertical",children:[v.map(d=>e.jsx("a",{href:"#",title:d.version,onClick:N=>{N.preventDefault(),p(d.version)},className:"link-hover",children:e.jsx("span",{children:U(d.version)})},d.id)),b&&!u&&e.jsx("a",{href:"#",onClick:d=>{d.preventDefault(),m(!0)},className:"link-hover",children:e.jsxs(g,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(S,{color:"global-text",icon:"expandMore"})]})}),b&&u&&e.jsx("a",{href:"#",onClick:d=>{d.preventDefault(),m(!1)},className:"link-hover",children:e.jsxs(g,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(S,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),s&&a&&i&&e.jsx(Ce,{service:s,image:i})]})};function $e(){const{imagesPromise:r}=w.useLoaderData(),{service:a,image:s}=w.useParams();return J()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(Z,{}):e.jsx(P,{displayErrorMessage:!0,children:e.jsx(n.Suspense,{fallback:e.jsx(_,{className:"mt-4"}),children:e.jsx(Se,{imagesPromise:r,imageRepository:s,service:a})})})}export{$e as component};
