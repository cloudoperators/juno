import{a5 as k,j as e,L as Z,O as B,E as y,m as Y,M as ee,a as se,P as V,o as v,n as m,c as j,V as u,f as E,a4 as ie,d as f,y as M,W as re,Z as ae,_ as T,$ as D,a0 as F,Q as le,a1 as ne,a2 as q,a3 as H,I as te,T as C,U as oe,u as ce,g as de}from"./App-D0qakPoK-HBqtXR5n.js";import{G as l}from"./_extensionId._-C53Sdkf5.js";import{E as me,C as ue,f as X,b as R,a as S}from"./IssueCountsPerSeverityLevel-BBMgaNdT-C2FcxF0N.js";import{n as xe}from"./SectionContentHeading-B1vx_evo-CPDBI8SQ.js";import{a as je,Q as he}from"./index-CZ-Imm41-kYATNXok.js";import{s as pe}from"./IssueTimestamp-11SAcU2M-DSJt3Aze.js";import{g as z}from"./CursorPagination-DeNt0GgA-BdbpBDEd.js";import"./index-21jQD_BD.js";import"./Shell-CA9s1e8I.js";import"./index-Bl6MSoRf.js";const ge=({queryClient:s,apiClient:i,filter:r})=>{const t=["remediations",r];return s.ensureQueryData({queryKey:t,queryFn:()=>i.query({query:le,variables:{filter:r}})})},ve=({issuesPromise:s,service:i,image:r,onFalsePositiveSuccess:t})=>{const{error:n,data:a}=l.use(s),{vulnerabilities:d}=C(a);return n?e.jsxs(S,{colSpan:5,children:["Error loading vulnerabilities: ",n.message]}):d.length===0?e.jsx(S,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):d.filter(o=>o&&o.name).map(o=>e.jsx(je,{issue:o,service:i,image:r,onFalsePositiveSuccess:t},o.id||o.name))},fe=s=>`
    border-l-2
    ${de(s.toLowerCase())}
    h-full
    pl-5
  `,be=({issue:s})=>{const[i,r]=l.useState(!1),{needsExpansion:t,textRef:n}=ce(s?.description||""),a=d=>{d.preventDefault(),r(!i)};return s?.name?e.jsxs(v,{children:[e.jsx(j,{className:"pl-0",children:e.jsx("div",{className:fe(s.severity),children:e.jsx(he,{severity:s.severity})})}),e.jsx(j,{className:"whitespace-nowrap",children:e.jsxs(u,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceUrl&&s.sourceUrl!=="-"&&e.jsx("a",{href:s.sourceUrl,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(u,{gap:"1.5",alignment:"center",children:[e.jsx(f,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Vulnerability source"})]})})]})}),e.jsx(j,{className:"whitespace-nowrap",children:e.jsx(pe,{targetDate:s.earliestTargetRemediationDate})}),e.jsx(j,{className:"min-w-0",children:e.jsxs(u,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:n,className:i?"":"whitespace-nowrap overflow-hidden text-ellipsis max-w-full",children:s.description}),s.description&&t&&e.jsx("a",{href:"#",onClick:a,className:"link-hover",children:e.jsxs(u,{alignment:"center",children:[i?"Show less":"Show more",e.jsx(f,{color:"global-text",icon:i?"expandLess":"expandMore"})]})})]})})]}):null},K=4,ye=({issuesPromise:s,remediationsPromise:i})=>{const r=l.use(s),t=l.use(i),{error:n,data:a}=r,{data:d}=t,{vulnerabilities:o}=C(a);return oe(d),n?e.jsxs(S,{colSpan:K,children:["Error loading remediated vulnerabilities: ",n.message]}):o.length===0?e.jsx(S,{colSpan:K,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:o.map(h=>e.jsx(be,{issue:h},h.id))})},Se=({service:s,image:i,setSearchTerm:r,setPageCursor:t,issuesPromise:n,successMessage:a,onFalsePositiveSuccess:d})=>e.jsxs(e.Fragment,{children:[a&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(q,{text:a,variant:"success"})}),e.jsx(H,{className:"mb-4 mt-4"}),e.jsx(u,{gap:"2",className:"mb-4 mt-4",children:e.jsx(te,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:o=>r(o||""),onClear:()=>{r("")}})}),e.jsxs(V,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(m,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"}),e.jsx(m,{children:"Actions"})]}),n&&e.jsx(y,{displayErrorMessage:!0,fallbackRender:X({colspan:5}),resetKeys:[n],children:e.jsx(l.Suspense,{fallback:e.jsx(R,{colSpan:5}),children:e.jsx(ve,{issuesPromise:n,service:s,image:i.repository,onFalsePositiveSuccess:d})})})]}),n&&e.jsx(y,{resetKeys:[n],children:e.jsx(l.Suspense,{children:e.jsx(z,{dataPromise:n,dataNormalizationMethod:C,goToPage:t})})})]}),Ce=({issuesPromise:s,remediationsPromise:i,setPageCursor:r,successMessage:t})=>e.jsxs(e.Fragment,{children:[t&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(q,{text:t,variant:"success"})}),e.jsx(H,{className:"mb-4 mt-4"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs(V,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(m,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"})]}),s&&e.jsx(y,{displayErrorMessage:!0,fallbackRender:X({colspan:4}),resetKeys:[s,i],children:e.jsx(l.Suspense,{fallback:e.jsx(R,{colSpan:4}),children:e.jsx(ye,{issuesPromise:s,remediationsPromise:i})})})]}),s&&e.jsx(y,{resetKeys:[s],children:e.jsx(l.Suspense,{children:e.jsx(z,{dataPromise:s,dataNormalizationMethod:C,goToPage:r})})})]})]}),L=5e3,Pe=({service:s,image:i})=>{const{apiClient:r,queryClient:t}=ue({from:"/services/$service"}),[n,a]=l.useState(void 0),[d,o]=l.useState(void 0),[h,P]=l.useState(void 0),[x,N]=l.useState(0),[p,c]=l.useState(null),[b,G]=l.useState(null),U={status:"open",...n?{search:[n]}:{}},A={status:"remediated"},I=M({apiClient:r,queryClient:t,filter:{service:[s],repository:[i.repository]},firstVulnerabilities:20,afterVulnerabilities:d,vulFilter:U}),Q=M({apiClient:r,queryClient:t,filter:{service:[s],repository:[i.repository]},firstVulnerabilities:20,afterVulnerabilities:h,vulFilter:A}),$=ge({apiClient:r,queryClient:t,filter:{service:[s],image:[i.repository]}});l.useEffect(()=>{if(!p)return;const g=setTimeout(()=>c(null),L);return()=>clearTimeout(g)},[p]),l.useEffect(()=>{if(!b)return;const g=setTimeout(()=>G(null),L);return()=>clearTimeout(g)},[b]);const W=()=>{const{addMessage:g}=ne(),J=l.useCallback(O=>{const w=`Vulnerability ${O} marked as false positive successfully.`;g({variant:"success",text:w}),c(w)},[g]);return e.jsx(Se,{service:s,image:i,setSearchTerm:a,setPageCursor:o,issuesPromise:I,successMessage:p,onFalsePositiveSuccess:J})},_=()=>e.jsx(Ce,{issuesPromise:Q,remediationsPromise:$,setPageCursor:P,successMessage:b});return e.jsx(e.Fragment,{children:e.jsxs(re,{selectedIndex:x,onSelect:N,variant:"content",children:[e.jsxs(ae,{children:[e.jsx(T,{label:"Active Vulnerabilities"}),e.jsx(T,{label:"Remediated Vulnerabilities"})]}),e.jsx(D,{children:e.jsx(F,{children:e.jsx(W,{})})}),e.jsx(D,{children:e.jsx(F,{children:e.jsx(_,{})})})]})})},Ne=({imagesPromise:s,imageRepository:i,service:r})=>{const{data:t}=l.use(s),{images:n}=ee(t),a=n.find(c=>c.repository===i),[d,o]=l.useState(!1),h=se();if(!a)return null;const P=c=>{h({to:"/services/$service/images/$image/versions/$version",params:{service:r,image:i,version:c}})},x=a.versions||[],N=d?x:x.slice(0,3),p=x.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(xe,{children:["Image ",a.repository]}),e.jsxs(V,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(v,{children:[e.jsx(m,{children:"Details"}),e.jsx(j,{children:e.jsxs(u,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(E,{pillKey:"repository",pillKeyLabel:"repository",pillValue:a.repository,pillValueLabel:a.repository}),a.versionsCount!==void 0&&a.versionsCount>0&&e.jsx(E,{pillKey:"versions",pillKeyLabel:"versions",pillValue:a.versionsCount.toString(),pillValueLabel:a.versionsCount.toString()})]})})]}),e.jsxs(v,{children:[e.jsx(m,{children:"Vulnerabilities Counts"}),e.jsx(j,{children:e.jsx(me,{counts:a.vulnerabilityCounts})})]}),x.length>0&&e.jsxs(v,{children:[e.jsxs(m,{children:["Versions (",x.length,")"]}),e.jsx(j,{children:e.jsxs(u,{gap:"2",direction:"vertical",children:[N.map(c=>e.jsx("a",{href:"#",title:c.version,onClick:b=>{b.preventDefault(),P(c.version)},className:"link-hover",children:e.jsx("span",{children:ie(c.version)})},c.id)),p&&!d&&e.jsx("a",{href:"#",onClick:c=>{c.preventDefault(),o(!0)},className:"link-hover",children:e.jsxs(u,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(f,{color:"global-text",icon:"expandMore"})]})}),p&&d&&e.jsx("a",{href:"#",onClick:c=>{c.preventDefault(),o(!1)},className:"link-hover",children:e.jsxs(u,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(f,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),r&&i&&a&&e.jsx(Pe,{service:r,image:a})]})};function qe(){const{imagesPromise:s}=k.useLoaderData(),{service:i,image:r}=k.useParams();return Z()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(B,{}):e.jsx(y,{displayErrorMessage:!0,children:e.jsx(l.Suspense,{fallback:e.jsx(Y,{className:"mt-4"}),children:e.jsx(Ne,{imagesPromise:s,imageRepository:r,service:i})})})}export{qe as component};
