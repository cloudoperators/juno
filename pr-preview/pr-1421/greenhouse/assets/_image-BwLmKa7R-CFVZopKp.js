import{a5 as N,j as e,L as D,O as I,E as b,m as M,M as A,a as z,P as w,o as g,n as u,c as v,V as j,f as E,d as f,a0 as G,y as T,a1 as Q,a2 as W,a3 as F,a4 as V,I as O,T as $,Q as X,$ as Y,u as Z,U,W as _,Z as B,_ as J}from"./App-BW_MrYFG-a2Mle5AC.js";import{G as t}from"./_extensionId._-DPGachgW.js";import{E as ee,C as L,f as P,b as R,a as C}from"./IssueCountsPerSeverityLevel-DP0ME6BC-DmX74uNM.js";import{n as se}from"./SectionContentHeading-CwN0SFr0-BX_D8ey-.js";import{G as ie}from"./index-CIvXQmRW-yzzIjDbY.js";import{g as re}from"./CursorPagination-Cm__Ela7-BCAa4Umz.js";import"./index-DbLSj9-S.js";import"./Shell-BdgWVXzG.js";import"./index-xDw3V3KT.js";import"./IssueTimestamp-B9KuuRci-DUa9cBt4.js";const ae=({queryClient:r,apiClient:a,filter:i})=>{const c=["remediations",i];return r.ensureQueryData({queryKey:c,queryFn:()=>a.query({query:X,variables:{filter:i}})})},ne=({issuesPromise:r,service:a,image:i,onFalsePositiveSuccess:c,onFalsePositiveError:n})=>{const{error:s,data:d}=t.use(r),{vulnerabilities:m}=$(d);return s?e.jsxs(C,{colSpan:5,children:["Error loading vulnerabilities: ",s.message]}):m.length===0?e.jsx(C,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):m.map(x=>e.jsx(ie,{issue:x,service:a,image:i,onFalsePositiveSuccess:c,onFalsePositiveError:n},x.id||x.name))},le=()=>`
    border-l-2
    border-theme-default
    h-full
    pl-5
  `,te=({remediation:r,onRevert:a})=>{const[i,c]=t.useState(!1),[n,s]=t.useState(!1),{needsExpansion:d,textRef:m}=Z(r.description||""),x=l=>{l.preventDefault(),c(!i)},p=async()=>{s(!0);try{await a(r.remediationId)}catch(l){console.error("Failed to revert remediation:",l)}finally{s(!1)}};return e.jsxs(g,{children:[e.jsx(v,{className:"pl-0",children:e.jsx("div",{className:le(),children:e.jsx(f,{icon:"checkCircle",color:"success"})})}),e.jsx(v,{className:"whitespace-nowrap",children:e.jsx(j,{gap:"2",direction:"vertical",children:e.jsx("span",{children:r.vulnerability||"N/A"})})}),e.jsx(v,{children:e.jsxs(j,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:m,className:i?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:r.description||"No description available"}),r.description&&d&&e.jsx("a",{href:"#",onClick:x,className:"link-hover",children:e.jsxs(j,{alignment:"center",children:[i?"Show less":"Show more",e.jsx(f,{color:"global-text",icon:i?"expandLess":"expandMore"})]})})]})}),e.jsx(v,{className:"cursor-default interactive",onClick:l=>l.stopPropagation(),children:e.jsx(U,{icon:"moreVert",className:"whitespace-nowrap",disabled:n,children:e.jsx(_,{children:e.jsx(B,{label:n?"Reverting...":"Revert false positive",onClick:p,disabled:n})})})})]})},oe=async({apiClient:r,remediationId:a})=>{const i=await r.mutate({mutation:J,variables:{id:a}});if(!i.data?.deleteRemediation)throw new Error("Failed to delete remediation");return i.data.deleteRemediation},ce=({remediationsPromise:r,onRevertSuccess:a,onRevertError:i})=>{const{error:c,data:n}=t.use(r),{remediatedVulnerabilities:s}=Y(n),{apiClient:d,queryClient:m}=L({from:"/services/$service"}),x=async p=>{try{await oe({apiClient:d,remediationId:p}),m.invalidateQueries({queryKey:["remediations"]}),m.invalidateQueries({queryKey:["images"]}),a()}catch(l){throw console.error("Failed to delete remediation:",l),i(l instanceof Error?l:new Error("Failed to revert false positive")),l}};return c?e.jsxs(C,{colSpan:4,children:["Error loading remediated vulnerabilities: ",c.message]}):s.length===0?e.jsx(C,{colSpan:4,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:s.map(p=>e.jsx(te,{remediation:p,onRevert:x},p.remediationId))})},de=({service:r,image:a})=>{const{apiClient:i,queryClient:c}=L({from:"/services/$service"}),{addMessage:n}=G(),[s,d]=t.useState(void 0),[m,x]=t.useState(void 0),[p,l]=t.useState(0),S=s?{search:[s]}:void 0,h=T({apiClient:i,queryClient:c,filter:{service:[r],repository:[a.repository]},firstVulnerabilities:20,afterVulnerabilities:m,vulFilter:S}),o=ae({apiClient:i,queryClient:c,filter:{service:[r],image:[a.repository]}}),k=t.useCallback(()=>{n({variant:"success",text:"Vulnerability marked as false positive successfully."})},[n]),q=t.useCallback(y=>{n({variant:"error",text:`Failed to mark as false positive: ${y.message}`})},[n]),H=t.useCallback(()=>{n({variant:"success",text:"False positive reverted successfully."})},[n]),K=t.useCallback(y=>{n({variant:"error",text:`Failed to revert false positive: ${y.message}`})},[n]);return e.jsx(e.Fragment,{children:e.jsxs(Q,{selectedIndex:p,onSelect:l,variant:"content",children:[e.jsxs(W,{children:[e.jsx(F,{label:"Vulnerabilities"}),e.jsx(F,{label:"Remediated Vulnerabilities"})]}),e.jsxs(V,{children:[e.jsx(j,{gap:"2",className:"mb-4 mt-4",children:e.jsx(O,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:y=>d(y||""),onClear:()=>{d("")}})}),e.jsxs(w,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(u,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(u,{children:"Vulnerability"}),e.jsx(u,{children:"Target Date"}),e.jsx(u,{children:"Description"}),e.jsx(u,{children:"Actions"})]}),h&&e.jsx(b,{displayErrorMessage:!0,fallbackRender:P({colspan:5}),resetKeys:[h],children:e.jsx(t.Suspense,{fallback:e.jsx(R,{colSpan:5}),children:e.jsx(ne,{issuesPromise:h,service:r,image:a.repository,onFalsePositiveSuccess:k,onFalsePositiveError:q})})})]}),h&&e.jsx(b,{resetKeys:[h],children:e.jsx(t.Suspense,{children:e.jsx(re,{dataPromise:h,dataNormalizationMethod:$,goToPage:x})})})]}),e.jsxs(V,{children:[e.jsx("div",{className:"mb-4 mt-4"}),e.jsxs(w,{columns:4,minContentColumns:[0,1,3],cellVerticalAlignment:"top",children:[e.jsxs(g,{children:[e.jsx(u,{children:e.jsx(f,{icon:"monitorHeart"})}),e.jsx(u,{children:"Vulnerability"}),e.jsx(u,{children:"Description"}),e.jsx(u,{children:"Actions"})]}),o&&e.jsx(b,{displayErrorMessage:!0,fallbackRender:P({colspan:4}),resetKeys:[o],children:e.jsx(t.Suspense,{fallback:e.jsx(R,{colSpan:4}),children:e.jsx(ce,{remediationsPromise:o,onRevertSuccess:H,onRevertError:K})})})]})]})]})})},me=({imagesPromise:r,imageRepository:a,service:i})=>{const{data:c}=t.use(r),{images:n}=A(c),s=n.find(o=>o.repository===a),[d,m]=t.useState(!1),x=z();if(!s)return null;const p=o=>{x({to:"/services/$service/images/$image/versions/$version",params:{service:i,image:a,version:o}})},l=s.versions||[],S=d?l:l.slice(0,3),h=l.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(se,{children:["Image ",s.repository]}),e.jsxs(w,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(g,{children:[e.jsx(u,{children:"Details"}),e.jsx(v,{children:e.jsxs(j,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(E,{pillKey:"repository",pillKeyLabel:"repository",pillValue:s.repository,pillValueLabel:s.repository}),s.versionsCount!==void 0&&s.versionsCount>0&&e.jsx(E,{pillKey:"versions",pillKeyLabel:"versions",pillValue:s.versionsCount.toString(),pillValueLabel:s.versionsCount.toString()})]})})]}),e.jsxs(g,{children:[e.jsx(u,{children:"Vulnerabilities Counts"}),e.jsx(v,{children:e.jsx(ee,{counts:s.vulnerabilityCounts})})]}),l.length>0&&e.jsxs(g,{children:[e.jsxs(u,{children:["Versions (",l.length,")"]}),e.jsx(v,{children:e.jsxs(j,{gap:"2",direction:"vertical",children:[S.map(o=>e.jsx("a",{href:"#",onClick:k=>{k.preventDefault(),p(o.version)},className:"link-hover",children:e.jsx("span",{children:o.version})},o.id)),h&&!d&&e.jsx("a",{href:"#",onClick:o=>{o.preventDefault(),m(!0)},className:"link-hover",children:e.jsxs(j,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(f,{color:"global-text",icon:"expandMore"})]})}),h&&d&&e.jsx("a",{href:"#",onClick:o=>{o.preventDefault(),m(!1)},className:"link-hover",children:e.jsxs(j,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(f,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),i&&a&&s&&e.jsx(de,{service:i,image:s})]})};function Ce(){const{imagesPromise:r}=N.useLoaderData(),{service:a,image:i}=N.useParams();return D()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(I,{}):e.jsx(b,{displayErrorMessage:!0,children:e.jsx(t.Suspense,{fallback:e.jsx(M,{className:"mt-4"}),children:e.jsx(me,{imagesPromise:r,imageRepository:i,service:a})})})}export{Ce as component};
