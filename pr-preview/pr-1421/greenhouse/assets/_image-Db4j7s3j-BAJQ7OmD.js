import{a9 as E,j as e,L as ie,O as re,E as f,m as ae,M as ne,a as le,P as N,o as v,n as m,c as x,V as p,f as R,a8 as te,d as b,y as F,a0 as oe,a1 as ce,a2 as T,a3 as M,a4 as X,Q as de,a5 as me,a6 as H,a7 as $,I as ue,T as V,U as z,k as xe,p as he,u as pe,g as je,Z as ve,_ as ge,$ as ye,W as fe}from"./App-D2RrjzBc-CtlFNKLV.js";import{G as c}from"./_extensionId._-8V-6klNq.js";import{E as be,C as A,f as k,b as D,a as C}from"./IssueCountsPerSeverityLevel-BgSE3hJ9-DTQ5TLvO.js";import{n as Ce}from"./SectionContentHeading-B0HlvpMy-Drntvsjo.js";import{a as Se,K as Pe}from"./index-2Wu8hwef-KYNNcWMp.js";import{s as Ne}from"./IssueTimestamp-ttrvf95_-UHDHRigR.js";import{g as G}from"./CursorPagination-BIjgKgkv-DTUN5lBZ.js";import"./index-D1U2VCB5.js";import"./Shell-BADX8tyo.js";import"./index-Di10iGng.js";const Q=({queryClient:s,apiClient:r,filter:i})=>{const t=["remediations",i];return s.ensureQueryData({queryKey:t,queryFn:()=>r.query({query:de,variables:{filter:i}})})},Ve=({issuesPromise:s,service:r,image:i,onFalsePositiveSuccess:t})=>{const{error:l,data:a}=c.use(s),{vulnerabilities:o}=V(a);return l?e.jsxs(C,{colSpan:5,children:["Error loading vulnerabilities: ",l.message]}):o.length===0?e.jsx(C,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):o.filter(d=>d&&d.name).map(d=>e.jsx(Se,{issue:d,service:r,image:i,onFalsePositiveSuccess:t},d.id||d.name))},we=s=>`
    border-l-2
    ${je(s.toLowerCase())}
    h-full
    pl-5
  `,ke=({issue:s,selected:r,onSelect:i})=>{const[t,l]=c.useState(!1),{needsExpansion:a,textRef:o}=pe(s?.description||""),d=n=>{n.preventDefault(),l(!t)};return s?.name?e.jsxs(v,{onClick:i,className:r?"bg-theme-background-selected cursor-pointer":"cursor-pointer",children:[e.jsx(x,{className:"pl-0",children:e.jsx("div",{className:we(s.severity),children:e.jsx(Pe,{severity:s.severity})})}),e.jsx(x,{className:"whitespace-nowrap",children:e.jsxs(p,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceUrl&&s.sourceUrl!=="-"&&e.jsx("a",{href:s.sourceUrl,target:"_blank",rel:"noopener noreferrer",className:"link-hover",onClick:n=>n.stopPropagation(),children:e.jsxs(p,{gap:"1.5",alignment:"center",children:[e.jsx(b,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Vulnerability source"})]})})]})}),e.jsx(x,{className:"whitespace-nowrap",children:e.jsx(Ne,{targetDate:s.earliestTargetRemediationDate})}),e.jsx(x,{className:"min-w-0",children:e.jsxs(p,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:o,className:t?"":"whitespace-nowrap overflow-hidden text-ellipsis max-w-full",children:s.description}),s.description&&a&&e.jsx("a",{href:"#",onClick:n=>{n.stopPropagation(),d(n)},className:"link-hover",children:e.jsxs(p,{alignment:"center",children:[t?"Show less":"Show more",e.jsx(b,{color:"global-text",icon:t?"expandLess":"expandMore"})]})})]})})]}):null},q=4,De=({issuesPromise:s,remediationsPromise:r,selectedVulnerabilityName:i,onSelectVulnerability:t})=>{const l=c.use(s),a=c.use(r),{error:o,data:d}=l,{data:n}=a,{vulnerabilities:j}=V(d);return z(n),o?e.jsxs(C,{colSpan:q,children:["Error loading remediated vulnerabilities: ",o.message]}):j.length===0?e.jsx(C,{colSpan:q,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:j.map(h=>e.jsx(ke,{issue:h,selected:i===h.name,onSelect:()=>t(h.name)},h.id))})},Ke=async({apiClient:s,remediationId:r})=>{const i=await s.mutate({mutation:fe,variables:{id:r}});if(!i.data?.deleteRemediation)throw new Error("Failed to delete remediation");return i.data.deleteRemediation},P=6;function I(s){if(!s)return"â€”";try{const r=new Date(s);return Number.isNaN(r.getTime())?s:r.toLocaleDateString("en-GB",{year:"numeric",month:"short",day:"numeric"})}catch{return s}}const Ee=({remediationsPromise:s,onRevert:r})=>{const[i,t]=c.useState(null),{error:l,data:a}=c.use(s),{remediatedVulnerabilities:o}=z(a),d=async n=>{t(n.remediationId);try{await r(n.remediationId)}finally{t(null)}};return l?e.jsxs(C,{colSpan:P,children:["Error loading remediations: ",l.message]}):o.length===0?e.jsx(C,{colSpan:P,children:"No remediations found for this vulnerability."}):e.jsx(e.Fragment,{children:o.map(n=>e.jsxs(v,{children:[e.jsx(x,{className:"whitespace-nowrap",children:I(n.expirationDate)}),e.jsx(x,{className:"whitespace-nowrap",children:I(n.remediationDate)}),e.jsx(x,{children:n.remediatedBy??"â€”"}),e.jsx(x,{children:n.type??"â€”"}),e.jsx(x,{children:n.description??"â€”"}),e.jsx(x,{className:"cursor-default interactive",onClick:j=>j.stopPropagation(),children:e.jsx(ve,{icon:"moreVert",className:"whitespace-nowrap",disabled:i===n.remediationId,children:e.jsx(ge,{children:e.jsx(ye,{label:i===n.remediationId?"Reverting...":"Revert False Positive",onClick:()=>d(n),disabled:i===n.remediationId})})})})]},n.remediationId))})},Re=({service:s,image:r,vulnerability:i,onClose:t})=>{const{apiClient:l,queryClient:a}=A({from:"/services/$service"}),o=c.useMemo(()=>i?Q({apiClient:l,queryClient:a,filter:{service:[s],image:[i],vulnerability:[r]}}):null,[s,r,i,l,a]),d=async n=>{await Ke({apiClient:l,remediationId:n}),a.invalidateQueries({queryKey:["remediations"]}),a.invalidateQueries({queryKey:["images"]})};return e.jsx(xe,{heading:i?`Remediations for ${i}`:void 0,opened:!!i,onClose:t,size:"large",children:e.jsx(he,{children:o&&e.jsx(f,{displayErrorMessage:!0,fallbackRender:k({colspan:P}),resetKeys:[o],children:e.jsxs(N,{columns:P,cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(m,{children:"Expiration Date"}),e.jsx(m,{children:"Remediation Date"}),e.jsx(m,{children:"Remediated By"}),e.jsx(m,{children:"Type"}),e.jsx(m,{children:"Description"}),e.jsx(m,{children:"Actions"})]}),e.jsx(c.Suspense,{fallback:e.jsx(D,{colSpan:P}),children:e.jsx(Ee,{remediationsPromise:o,onRevert:d})})]})})})})},Fe=({service:s,image:r,setSearchTerm:i,setPageCursor:t,issuesPromise:l,successMessage:a,onFalsePositiveSuccess:o})=>e.jsxs(e.Fragment,{children:[a&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(H,{text:a,variant:"success"})}),e.jsx($,{className:"mb-4 mt-4"}),e.jsx(p,{gap:"2",className:"mb-4 mt-4",children:e.jsx(ue,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:d=>i(d||""),onClear:()=>{i("")}})}),e.jsxs(N,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(m,{children:e.jsx(b,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"}),e.jsx(m,{children:"Actions"})]}),l&&e.jsx(f,{displayErrorMessage:!0,fallbackRender:k({colspan:5}),resetKeys:[l],children:e.jsx(c.Suspense,{fallback:e.jsx(D,{colSpan:5}),children:e.jsx(Ve,{issuesPromise:l,service:s,image:r.repository,onFalsePositiveSuccess:o})})})]}),l&&e.jsx(f,{resetKeys:[l],children:e.jsx(c.Suspense,{children:e.jsx(G,{dataPromise:l,dataNormalizationMethod:V,goToPage:t})})})]}),Te=({service:s,image:r,issuesPromise:i,remediationsPromise:t,setPageCursor:l,successMessage:a})=>{const[o,d]=c.useState(null);return e.jsxs(e.Fragment,{children:[a&&e.jsx("div",{className:"mb-4 mt-4",children:e.jsx(H,{text:a,variant:"success"})}),e.jsx($,{className:"mb-4 mt-4"}),e.jsxs("div",{className:"mt-4",children:[e.jsxs(N,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(v,{children:[e.jsx(m,{children:e.jsx(b,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"})]}),i&&e.jsx(f,{displayErrorMessage:!0,fallbackRender:k({colspan:4}),resetKeys:[i,t],children:e.jsx(c.Suspense,{fallback:e.jsx(D,{colSpan:4}),children:e.jsx(De,{issuesPromise:i,remediationsPromise:t,selectedVulnerabilityName:o,onSelectVulnerability:d})})})]}),i&&e.jsx(f,{resetKeys:[i],children:e.jsx(c.Suspense,{children:e.jsx(G,{dataPromise:i,dataNormalizationMethod:V,goToPage:l})})})]}),e.jsx(Re,{service:s,image:r,vulnerability:o,onClose:()=>d(null)})]})},L=5e3,Me=({service:s,image:r})=>{const{apiClient:i,queryClient:t}=A({from:"/services/$service"}),[l,a]=c.useState(void 0),[o,d]=c.useState(void 0),[n,j]=c.useState(void 0),[h,w]=c.useState(0),[g,u]=c.useState(null),[S,U]=c.useState(null),B={status:"open",...l?{search:[l]}:{}},J={status:"remediated"},W=F({apiClient:i,queryClient:t,filter:{service:[s],repository:[r.repository]},firstVulnerabilities:20,afterVulnerabilities:o,vulFilter:B}),Z=F({apiClient:i,queryClient:t,filter:{service:[s],repository:[r.repository]},firstVulnerabilities:20,afterVulnerabilities:n,vulFilter:J}),_=Q({apiClient:i,queryClient:t,filter:{service:[s],image:[r.repository]}});c.useEffect(()=>{if(!g)return;const y=setTimeout(()=>u(null),L);return()=>clearTimeout(y)},[g]),c.useEffect(()=>{if(!S)return;const y=setTimeout(()=>U(null),L);return()=>clearTimeout(y)},[S]);const Y=()=>{const{addMessage:y}=me(),ee=c.useCallback(se=>{const K=`Vulnerability ${se} marked as false positive successfully.`;y({variant:"success",text:K}),u(K)},[y]);return e.jsx(Fe,{service:s,image:r,setSearchTerm:a,setPageCursor:d,issuesPromise:W,successMessage:g,onFalsePositiveSuccess:ee})},O=()=>e.jsx(Te,{service:s,image:r.repository,issuesPromise:Z,remediationsPromise:_,setPageCursor:j,successMessage:S});return e.jsx(e.Fragment,{children:e.jsxs(oe,{selectedIndex:h,onSelect:w,variant:"content",children:[e.jsxs(ce,{children:[e.jsx(T,{label:"Active Vulnerabilities"}),e.jsx(T,{label:"Remediated Vulnerabilities"})]}),e.jsx(M,{children:e.jsx(X,{children:e.jsx(Y,{})})}),e.jsx(M,{children:e.jsx(X,{children:e.jsx(O,{})})})]})})},Xe=({imagesPromise:s,imageRepository:r,service:i})=>{const{data:t}=c.use(s),{images:l}=ne(t),a=l.find(u=>u.repository===r),[o,d]=c.useState(!1),n=le();if(!a)return null;const j=u=>{n({to:"/services/$service/images/$image/versions/$version",params:{service:i,image:r,version:u}})},h=a.versions||[],w=o?h:h.slice(0,3),g=h.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(Ce,{children:["Image ",a.repository]}),e.jsxs(N,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(v,{children:[e.jsx(m,{children:"Details"}),e.jsx(x,{children:e.jsxs(p,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(R,{pillKey:"repository",pillKeyLabel:"repository",pillValue:a.repository,pillValueLabel:a.repository}),a.versionsCount!==void 0&&a.versionsCount>0&&e.jsx(R,{pillKey:"versions",pillKeyLabel:"versions",pillValue:a.versionsCount.toString(),pillValueLabel:a.versionsCount.toString()})]})})]}),e.jsxs(v,{children:[e.jsx(m,{children:"Vulnerabilities Counts"}),e.jsx(x,{children:e.jsx(be,{counts:a.vulnerabilityCounts})})]}),h.length>0&&e.jsxs(v,{children:[e.jsxs(m,{children:["Versions (",h.length,")"]}),e.jsx(x,{children:e.jsxs(p,{gap:"2",direction:"vertical",children:[w.map(u=>e.jsx("a",{href:"#",title:u.version,onClick:S=>{S.preventDefault(),j(u.version)},className:"link-hover",children:e.jsx("span",{children:te(u.version)})},u.id)),g&&!o&&e.jsx("a",{href:"#",onClick:u=>{u.preventDefault(),d(!0)},className:"link-hover",children:e.jsxs(p,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(b,{color:"global-text",icon:"expandMore"})]})}),g&&o&&e.jsx("a",{href:"#",onClick:u=>{u.preventDefault(),d(!1)},className:"link-hover",children:e.jsxs(p,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(b,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),i&&r&&a&&e.jsx(Me,{service:i,image:a})]})};function Be(){const{imagesPromise:s}=E.useLoaderData(),{service:r,image:i}=E.useParams();return ie()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(re,{}):e.jsx(f,{displayErrorMessage:!0,children:e.jsx(c.Suspense,{fallback:e.jsx(ae,{className:"mt-4"}),children:e.jsx(Xe,{imagesPromise:s,imageRepository:i,service:r})})})}export{Be as component};
