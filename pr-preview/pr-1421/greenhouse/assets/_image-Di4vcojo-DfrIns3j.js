import{a7 as V,j as e,L as T,O as z,E as S,m as Q,M as G,a as W,P as R,o as y,n as x,c as f,V as v,f as w,d as b,y as Y,a0 as Z,a1 as _,a2 as $,a3 as H,a4 as L,Q as O,a5 as q,a6 as D,I as U,T as K,$ as B,u as J,U as X,W as ee,Z as se,_ as ie}from"./App-vF9zOeeO-BmUu5RcU.js";import{G as t}from"./_extensionId._-CZlsEEn1.js";import{E as re,C as M,f as I,b as A,a as P}from"./IssueCountsPerSeverityLevel-CaILDW4D-U8NTBIX4.js";import{n as ae}from"./SectionContentHeading-BughA7re-B54CX2Ef.js";import{H as ne}from"./index-DNL-f_aX-Dbs29dkX.js";import{g as le}from"./CursorPagination-CDSrorZj-Bc3E3PWO.js";import"./index-BcHE3nWB.js";import"./Shell-BNh9Ssw6.js";import"./index-DLMkkpzA.js";import"./IssueTimestamp-CafW-tA7-BwjKj1X7.js";const te=({queryClient:i,apiClient:a,filter:s})=>{const o=["remediations",s];return i.ensureQueryData({queryKey:o,queryFn:()=>a.query({query:O,variables:{filter:s}})})},oe=({issuesPromise:i,service:a,image:s,onFalsePositiveSuccess:o,onFalsePositiveError:n})=>{const{error:r,data:m}=t.use(i),{vulnerabilities:c}=K(m);return r?e.jsxs(P,{colSpan:5,children:["Error loading vulnerabilities: ",r.message]}):c.length===0?e.jsx(P,{colSpan:5,children:"No vulnerabilities found! ðŸš€"}):c.filter(d=>d&&d.name).map(d=>e.jsx(ne,{issue:d,service:a,image:s,onFalsePositiveSuccess:o,onFalsePositiveError:n},d.id||d.name))},ce=()=>`
    border-l-2
    border-theme-default
    h-full
    pl-5
  `,de=({remediation:i,onRevert:a})=>{const[s,o]=t.useState(!1),[n,r]=t.useState(!1),{needsExpansion:m,textRef:c}=J(i.description||""),d=l=>{l.preventDefault(),o(!s)},h=async()=>{r(!0);try{await a(i.remediationId)}catch(l){console.error("Failed to revert remediation:",l)}finally{r(!1)}};return e.jsxs(y,{children:[e.jsx(f,{className:"pl-0",children:e.jsx("div",{className:ce(),children:e.jsx(b,{icon:"checkCircle",color:"success"})})}),e.jsx(f,{className:"whitespace-nowrap",children:e.jsx(v,{gap:"2",direction:"vertical",children:e.jsx("span",{children:i.vulnerability||"N/A"})})}),e.jsx(f,{children:e.jsxs(v,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:c,className:s?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:i.description||"No description available"}),i.description&&m&&e.jsx("a",{href:"#",onClick:d,className:"link-hover",children:e.jsxs(v,{alignment:"center",children:[s?"Show less":"Show more",e.jsx(b,{color:"global-text",icon:s?"expandLess":"expandMore"})]})})]})}),e.jsx(f,{className:"cursor-default interactive",onClick:l=>l.stopPropagation(),children:e.jsx(X,{icon:"moreVert",className:"whitespace-nowrap",disabled:n,children:e.jsx(ee,{children:e.jsx(se,{label:n?"Reverting...":"Revert false positive",onClick:h,disabled:n})})})})]})},me=async({apiClient:i,remediationId:a})=>{const s=await i.mutate({mutation:ie,variables:{id:a}});if(!s.data?.deleteRemediation)throw new Error("Failed to delete remediation");return s.data.deleteRemediation},ue=({remediationsPromise:i,onRevertSuccess:a,onRevertError:s})=>{const{error:o,data:n}=t.use(i),{remediatedVulnerabilities:r}=B(n),{apiClient:m,queryClient:c}=M({from:"/services/$service"}),d=async(h,l)=>{try{await me({apiClient:m,remediationId:h}),c.invalidateQueries({queryKey:["remediations"]}),c.invalidateQueries({queryKey:["images"]}),a(l)}catch(j){throw console.error("Failed to delete remediation:",j),s(j instanceof Error?j:new Error("Failed to revert false positive"),l),j}};return o?e.jsxs(P,{colSpan:4,children:["Error loading remediated vulnerabilities: ",o.message]}):r.length===0?e.jsx(P,{colSpan:4,children:"No remediated vulnerabilities found!"}):e.jsx(e.Fragment,{children:r.map(h=>e.jsx(de,{remediation:h,onRevert:l=>d(l,h.vulnerability||"N/A")},h.remediationId))})},xe=({service:i,image:a,setSearchTerm:s,setPageCursor:o,issuesPromise:n,onFalsePositiveSuccess:r,onFalsePositiveError:m})=>e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"mb-4 mt-4"}),e.jsx(v,{gap:"2",className:"mb-4 mt-4",children:e.jsx(U,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:c=>s(c||""),onClear:()=>{s("")}})}),e.jsxs(R,{columns:5,minContentColumns:[0,1,2,4],cellVerticalAlignment:"top",children:[e.jsxs(y,{children:[e.jsx(x,{children:e.jsx(b,{icon:"monitorHeart"})}),e.jsx(x,{children:"Vulnerability"}),e.jsx(x,{children:"Target Date"}),e.jsx(x,{children:"Description"}),e.jsx(x,{children:"Actions"})]}),n&&e.jsx(S,{displayErrorMessage:!0,fallbackRender:I({colspan:5}),resetKeys:[n],children:e.jsx(t.Suspense,{fallback:e.jsx(A,{colSpan:5}),children:e.jsx(oe,{issuesPromise:n,service:i,image:a.repository,onFalsePositiveSuccess:r,onFalsePositiveError:m})})})]}),n&&e.jsx(S,{resetKeys:[n],children:e.jsx(t.Suspense,{children:e.jsx(le,{dataPromise:n,dataNormalizationMethod:K,goToPage:o})})})]}),he=({remediationsPromise:i,onRevertSuccess:a,onRevertError:s})=>e.jsxs(e.Fragment,{children:[e.jsx(D,{className:"mb-4 mt-4"}),e.jsx("div",{className:"mt-4",children:e.jsxs(R,{columns:4,minContentColumns:[0,1,3],cellVerticalAlignment:"top",children:[e.jsxs(y,{children:[e.jsx(x,{children:e.jsx(b,{icon:"monitorHeart"})}),e.jsx(x,{children:"Vulnerability"}),e.jsx(x,{children:"Description"}),e.jsx(x,{children:"Actions"})]}),i&&e.jsx(S,{displayErrorMessage:!0,fallbackRender:I({colspan:4}),resetKeys:[i],children:e.jsx(t.Suspense,{fallback:e.jsx(A,{colSpan:4}),children:e.jsx(ue,{remediationsPromise:i,onRevertSuccess:a,onRevertError:s})})})]})})]}),pe=({service:i,image:a})=>{const{apiClient:s,queryClient:o}=M({from:"/services/$service"}),[n,r]=t.useState(void 0),[m,c]=t.useState(void 0),[d,h]=t.useState(0),l=n?{search:[n]}:void 0,j=Y({apiClient:s,queryClient:o,filter:{service:[i],repository:[a.repository]},firstVulnerabilities:20,afterVulnerabilities:m,vulFilter:l}),C=te({apiClient:s,queryClient:o,filter:{service:[i],image:[a.repository]}}),u=()=>{const{addMessage:p}=q(),N=t.useCallback(g=>{p({variant:"success",text:`Vulnerability ${g} marked as false positive successfully.`})},[p]),E=t.useCallback((g,k)=>{p({variant:"error",text:`Failed to mark ${k} as false positive: ${g.message}`})},[p]);return e.jsx(xe,{service:i,image:a,setSearchTerm:r,setPageCursor:c,issuesPromise:j,onFalsePositiveSuccess:N,onFalsePositiveError:E})},F=()=>{const{addMessage:p}=q(),N=t.useCallback(g=>{p({variant:"success",text:`False positive for ${g} reverted successfully.`})},[p]),E=t.useCallback((g,k)=>{p({variant:"error",text:`Failed to revert false positive for ${k}: ${g.message}`})},[p]);return e.jsx(he,{remediationsPromise:C,onRevertSuccess:N,onRevertError:E})};return e.jsx(e.Fragment,{children:e.jsxs(Z,{selectedIndex:d,onSelect:h,variant:"content",children:[e.jsxs(_,{children:[e.jsx($,{label:"Vulnerabilities"}),e.jsx($,{label:"Remediated Vulnerabilities"})]}),e.jsx(H,{children:e.jsx(L,{children:e.jsx(u,{})})}),e.jsx(H,{children:e.jsx(L,{children:e.jsx(F,{})})})]})})},je=({imagesPromise:i,imageRepository:a,service:s})=>{const{data:o}=t.use(i),{images:n}=G(o),r=n.find(u=>u.repository===a),[m,c]=t.useState(!1),d=W();if(!r)return null;const h=u=>{d({to:"/services/$service/images/$image/versions/$version",params:{service:s,image:a,version:u}})},l=r.versions||[],j=m?l:l.slice(0,3),C=l.length>3;return e.jsxs(e.Fragment,{children:[e.jsxs(ae,{children:["Image ",r.repository]}),e.jsxs(R,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(y,{children:[e.jsx(x,{children:"Details"}),e.jsx(f,{children:e.jsxs(v,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(w,{pillKey:"repository",pillKeyLabel:"repository",pillValue:r.repository,pillValueLabel:r.repository}),r.versionsCount!==void 0&&r.versionsCount>0&&e.jsx(w,{pillKey:"versions",pillKeyLabel:"versions",pillValue:r.versionsCount.toString(),pillValueLabel:r.versionsCount.toString()})]})})]}),e.jsxs(y,{children:[e.jsx(x,{children:"Vulnerabilities Counts"}),e.jsx(f,{children:e.jsx(re,{counts:r.vulnerabilityCounts})})]}),l.length>0&&e.jsxs(y,{children:[e.jsxs(x,{children:["Versions (",l.length,")"]}),e.jsx(f,{children:e.jsxs(v,{gap:"2",direction:"vertical",children:[j.map(u=>e.jsx("a",{href:"#",onClick:F=>{F.preventDefault(),h(u.version)},className:"link-hover",children:e.jsx("span",{children:u.version})},u.id)),C&&!m&&e.jsx("a",{href:"#",onClick:u=>{u.preventDefault(),c(!0)},className:"link-hover",children:e.jsxs(v,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show all"}),e.jsx(b,{color:"global-text",icon:"expandMore"})]})}),C&&m&&e.jsx("a",{href:"#",onClick:u=>{u.preventDefault(),c(!1)},className:"link-hover",children:e.jsxs(v,{alignment:"center",direction:"horizontal",gap:"1",children:[e.jsx("span",{children:"Show less"}),e.jsx(b,{color:"global-text",icon:"expandLess"})]})})]})})]})]}),s&&a&&r&&e.jsx(pe,{service:s,image:r})]})};function Ee(){const{imagesPromise:i}=V.useLoaderData(),{service:a,image:s}=V.useParams();return T()({to:"/services/$service/images/$image/versions/$version"})?e.jsx(z,{}):e.jsx(S,{displayErrorMessage:!0,children:e.jsx(t.Suspense,{fallback:e.jsx(Q,{className:"mt-4"}),children:e.jsx(je,{imagesPromise:i,imageRepository:s,service:a})})})}export{Ee as component};
