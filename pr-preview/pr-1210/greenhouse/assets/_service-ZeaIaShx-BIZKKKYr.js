import{c as C,h as I,$ as w,d as N,j as e,Y as S,a2 as L,x as P,t as T,M as b,R as h,Q as p,a as m,K as d,X as g,a0 as E,Z as F,L as z,a1 as M,g as j,_ as $,F as O,W as k,G as _,H as G,I as R,J as B,N as y,P as V,U as H,V as Q,u as U,b as D,i as A}from"./App-DIu-kE-u-BcboiLd-.js";import{w as o}from"./_extensionId._-DlQ0muZk.js";import{y as q,E as K,N as f,P as J}from"./IssueCountsPerSeverityLevel-CuFRemoz-j-hsHKkG.js";import{T as W,q as Y,E as X}from"./fetchImageVersions-DuiJl_a7-D5FdQMoO.js";import{s as Z}from"./IssueTimestamp-CaVX8RiZ-NVcqHBtQ.js";import"./index-DhmROJFJ.js";import"./Shell-ChsCkVm3.js";import"./index-d0AJpEZn.js";const ee=({instance:s})=>e.jsxs(_,{className:"text-sm text-theme-light",children:[e.jsxs(d,{children:[e.jsx("div",{className:"text-sm whitespace-nowrap overflow-hidden text-ellipsis w-full",children:s?.pod||"--"}),e.jsxs(G,{triggerEvent:"hover",children:[e.jsx(R,{children:e.jsx(j,{icon:"info",size:"18",className:"cursor-pointer hover:text-theme-primary"})}),e.jsxs(B,{children:[e.jsxs("span",{children:[" Namespace: ",s?.namespace||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Region: ",s?.region||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Cluster: ",s?.cluster||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Container: ",s?.container||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Pod: ",s?.pod||"--"]})]})]})]}),e.jsx("div",{className:"text-sm whitespace-nowrap",children:s?.cluster||"--"})]}),se=s=>{const r={};return s.forEach(i=>{const n=i.namespace||"Unknown",l=i.container||"Unknown";r[n]||(r[n]={}),r[n][l]||(r[n][l]=[]),r[n][l].push(i)}),r},re=({imageVersion:s})=>{const[r,i]=o.useState(!1),n=se(s.componentInstances||[]);o.useEffect(()=>{i(!1)},[s]);const l=c=>{c.preventDefault(),i(!r)};return e.jsxs(e.Fragment,{children:[r&&n&&Object.entries(n).map(([c,a])=>e.jsx(e.Fragment,{children:Object.entries(a).map(([x,t])=>e.jsxs("div",{className:"my-2",children:[e.jsxs("div",{className:"mb-4",children:["Namespace ",e.jsx("b",{children:c})," - Container ",e.jsx("b",{children:x})]}),e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,_minmax(240px,_1fr))] gap-2",children:t.map((u,v)=>e.jsx(ee,{instance:u},v))})]},`${c}-${x}`))})),e.jsx("div",{className:"advance-link",children:e.jsx("a",{href:"#",rel:"noopener noreferrer",onClick:l,children:e.jsxs(d,{alignment:"center",children:[r?"Hide Occurrences":"Display Occurrences",e.jsx(j,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})})]})},ie=({queryClient:s,apiClient:r,service:i,imageVersion:n,searchTerm:l,after:c})=>s.ensureQueryData({queryKey:["imageVersionsIssues",i,n,l,c],queryFn:()=>r.query({query:Q,variables:{componentVersionFilter:{version:[n]},issueMatchFilter:{serviceCcrn:[i]},issuesFilter:l?{search:[l]}:void 0,first:20,orderByIssueSeverity:[{by:H.Severity,direction:y.Desc}],orderBySeverity:[{by:V.Severity,direction:y.Desc}],orderByTrd:[{by:V.TargetRemediationDate,direction:y.Asc}],after:c}})}),ne=s=>{const r=s.toLowerCase(),i=D(r);return e.jsx(j,{icon:A[r]||"help",color:i})},ae=({severity:s})=>ne(s),le=s=>`
    border-l-2
    ${D(s.toLowerCase())}
    h-full
    pl-5
  `,ce=({issue:s})=>{const[r,i]=o.useState(!1),{needsExpansion:n,textRef:l}=U(s.description),c=a=>{a.preventDefault(),i(!r)};return e.jsxs(h,{children:[e.jsx(m,{className:"pl-0",children:e.jsx("div",{className:le(s.severity),children:e.jsx(ae,{severity:s.severity})})}),e.jsx(m,{className:"whitespace-nowrap",children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceLink&&s.sourceLink!=="-"&&e.jsx("a",{href:s.sourceLink,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(d,{gap:"1.5",alignment:"center",children:[e.jsx(j,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Vulnerability source"})]})})]})}),e.jsx(m,{className:"whitespace-nowrap",children:e.jsx(Z,{targetDate:s.earliestTargetRemediation})}),e.jsx(m,{children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:l,className:r?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:s.description}),s.description&&n&&e.jsx("a",{href:"#",onClick:c,className:"link-hover",children:e.jsxs(d,{alignment:"center",children:[r?"Show less":"Show more",e.jsx(j,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})]})})]})},oe=({issuesPromise:s})=>{const{error:r,data:i}=o.use(s),{issues:n}=k(i);return r?e.jsxs(f,{colSpan:4,children:["Error loading vulnerabilities: ",r.message]}):n.length===0?e.jsx(f,{colSpan:4,children:"No vulnerabilities found! ðŸš€"}):n.map(l=>e.jsx(ce,{issue:l},l.name))},te=({service:s,imageVersion:r})=>{const{apiClient:i,queryClient:n}=q({from:"/services/$service"}),[l,c]=o.useState(void 0),[a,x]=o.useState(void 0),t=ie({apiClient:i,queryClient:n,service:s,imageVersion:r.version,searchTerm:l,after:a});return e.jsxs(e.Fragment,{children:[e.jsxs(d,{gap:"2",className:"mb-4 mt-8",children:[e.jsx($,{children:"Vulnerabilities"}),e.jsx(O,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:u=>c(u||""),onClear:()=>{c("")}})]}),e.jsxs(b,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(h,{children:[e.jsx(p,{children:e.jsx(j,{icon:"monitorHeart"})}),e.jsx(p,{children:"Vulnerability"}),e.jsx(p,{children:"Target Date"}),e.jsx(p,{children:"Description"})]}),t&&e.jsx(o.Suspense,{fallback:e.jsx(f,{colSpan:4,children:e.jsxs(d,{gap:"2",alignment:"center",children:[e.jsx("div",{children:"Loading vulnerabilities"}),e.jsx(P,{variant:"primary"})]})}),children:e.jsx(oe,{issuesPromise:t})})]}),t&&e.jsx(o.Suspense,{children:e.jsx(J,{dataPromise:t,dataNormalizationMethod:k,goToPage:x})})]})},de=({imageVersionsPromise:s})=>{const r=C(),{service:i}=w({from:"/services/$service"}),{imageVersion:n}=N({from:"/services/$service"}),{data:l}=o.use(s),{imageVersions:c}=E(l),a=c.find(x=>x.version===n);return a?e.jsx(S,{children:e.jsx(F,{heading:`Image ${a.repository} Information`,opened:!!i,onClose:()=>r({to:"/services/$service",params:{service:i}}),size:"large",children:e.jsxs(z,{children:[e.jsx(M,{py:!0,px:!1,children:e.jsx(L,{})}),e.jsxs(b,{columns:2,gridColumnTemplate:"20% auto",children:[e.jsxs(h,{children:[e.jsx(p,{children:"Details"}),e.jsx(m,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(g,{pillKey:"tag",pillKeyLabel:"tag",pillValue:a.tag,pillValueLabel:a.tag}),e.jsx(g,{pillKey:"repository",pillKeyLabel:"repository",pillValue:a.repository,pillValueLabel:a.repository}),e.jsx(g,{pillKey:"version",pillKeyLabel:"version",pillValue:a.version,pillValueLabel:a.version})]})})]}),e.jsxs(h,{children:[e.jsx(p,{children:"Vulnerabilities Counts"}),e.jsx(m,{children:e.jsx(K,{counts:a.issueCounts})})]}),e.jsxs(h,{children:[e.jsx(p,{className:"whitespace-nowrap",children:`Occurrences (${a.componentInstancesCount||0})`}),e.jsx(m,{children:e.jsx(re,{imageVersion:a})})]})]}),i&&n&&a&&e.jsx(te,{service:i,imageVersion:a})]})})}):null},pe=({servicePromise:s})=>{const{data:r}=o.use(s),i=T(r).services[0];return e.jsxs(e.Fragment,{children:[e.jsxs(X,{children:["Service ",i.name]}),e.jsxs(b,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(h,{children:[e.jsx(p,{children:"Details"}),e.jsx(m,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(g,{pillKey:"service",pillKeyLabel:"service",pillValue:i.name,pillValueLabel:i.name}),i.serviceDetails?.supportGroups?.map(n=>e.jsx(g,{pillKey:"support_group",pillKeyLabel:"support_group",pillValue:n,pillValueLabel:n},n))]})})]}),e.jsxs(h,{children:[e.jsx(p,{children:"Vulnerabilities Counts"}),e.jsx(m,{children:e.jsx(K,{counts:i.issuesCount})})]})]})]})},me=()=>{const s=C(),{queryClient:r,apiClient:i}=q({from:"/services/$service"}),{servicePromise:n}=I({from:"/services/$service"}),{service:l}=w({from:"/services/$service"}),{imageVersion:c}=N({from:"/services/$service"}),[a,x]=o.useState(void 0),[t,u]=o.useState(void 0);return o.useEffect(()=>{const v=W({queryClient:r,apiClient:i,service:l,after:a});u(v)},[a]),e.jsxs(S,{children:[e.jsx(L,{className:"mb-4"}),e.jsx(o.Suspense,{fallback:e.jsx(P,{className:"mt-4"}),children:e.jsx(pe,{servicePromise:n})}),t&&e.jsx(Y,{selectedImageVersion:c,imageVersionsPromise:t,onImageVersionItemClick:v=>{s({to:"/services/$service",params:{service:l},search:{imageVersion:v.version}})},goToPage:x}),e.jsx(o.Suspense,{children:t&&e.jsx(de,{imageVersionsPromise:t})})]})},be=me;export{be as component};
