import{aw as X,ax as B,ay as v,az as U,aA as j,aB as D,aC as Q,aD as K,aE as he,aF as F,aG as de,aH as fe,aI as $,aJ as _,aK as V,aL as pe,aM as Z,v as P,aN as ee,f as te,a as se,e as re,j as a,B as ne,C as ie,c as ae,z as me,D as ye,V as ge,w as be,F as ve,I as k,J as Se,Q as we,Y as xe,W as Ee,aO as Ce,aP as Re}from"./App-DxL_sEWJ.js";import{r as p}from"./index-B9rLzfnb.js";var Oe=class extends X{constructor(e,t){super(),this.options=t,this.#s=e,this.#o=null,this.#a=B(),this.bindMethods(),this.setOptions(t)}#s;#e=void 0;#r=void 0;#t=void 0;#n;#i;#a;#o;#m;#d;#f;#l;#u;#c;#p=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#e.addObserver(this),H(this.#e,this.options)?this.#h():this.updateResult(),this.#v())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return A(this.#e,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return A(this.#e,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#S(),this.#w(),this.#e.removeObserver(this)}setOptions(e){const t=this.options,r=this.#e;if(this.options=this.#s.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof v(this.options.enabled,this.#e)!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#x(),this.#e.setOptions(this.options),t._defaulted&&!U(this.options,t)&&this.#s.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#e,observer:this});const s=this.hasListeners();s&&q(this.#e,r,this.options,t)&&this.#h(),this.updateResult(),s&&(this.#e!==r||v(this.options.enabled,this.#e)!==v(t.enabled,this.#e)||j(this.options.staleTime,this.#e)!==j(t.staleTime,this.#e))&&this.#y();const n=this.#g();s&&(this.#e!==r||v(this.options.enabled,this.#e)!==v(t.enabled,this.#e)||n!==this.#c)&&this.#b(n)}getOptimisticResult(e){const t=this.#s.getQueryCache().build(this.#s,e),r=this.createResult(t,e);return Ie(this,r)&&(this.#t=r,this.#i=this.options,this.#n=this.#e.state),r}getCurrentResult(){return this.#t}trackResult(e,t){return new Proxy(e,{get:(r,s)=>(this.trackProp(s),t?.(s),s==="promise"&&(this.trackProp("data"),!this.options.experimental_prefetchInRender&&this.#a.status==="pending"&&this.#a.reject(new Error("experimental_prefetchInRender feature flag is not enabled"))),Reflect.get(r,s))})}trackProp(e){this.#p.add(e)}getCurrentQuery(){return this.#e}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const t=this.#s.defaultQueryOptions(e),r=this.#s.getQueryCache().build(this.#s,t);return r.fetch().then(()=>this.createResult(r,t))}fetch(e){return this.#h({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#t))}#h(e){this.#x();let t=this.#e.fetch(this.options,e);return e?.throwOnError||(t=t.catch(D)),t}#y(){this.#S();const e=j(this.options.staleTime,this.#e);if(Q||this.#t.isStale||!K(e))return;const r=he(this.#t.dataUpdatedAt,e)+1;this.#l=F.setTimeout(()=>{this.#t.isStale||this.updateResult()},r)}#g(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.#e):this.options.refetchInterval)??!1}#b(e){this.#w(),this.#c=e,!(Q||v(this.options.enabled,this.#e)===!1||!K(this.#c)||this.#c===0)&&(this.#u=F.setInterval(()=>{(this.options.refetchIntervalInBackground||de.isFocused())&&this.#h()},this.#c))}#v(){this.#y(),this.#b(this.#g())}#S(){this.#l&&(F.clearTimeout(this.#l),this.#l=void 0)}#w(){this.#u&&(F.clearInterval(this.#u),this.#u=void 0)}createResult(e,t){const r=this.#e,s=this.options,n=this.#t,c=this.#n,i=this.#i,f=e!==r?e.state:this.#r,{state:u}=e;let l={...u},m=!1,h;if(t._optimisticResults){const b=this.hasListeners(),M=!b&&H(e,t),R=b&&q(e,r,t,s);(M||R)&&(l={...l,...fe(u.data,e.options)}),t._optimisticResults==="isRestoring"&&(l.fetchStatus="idle")}let{error:x,errorUpdatedAt:S,status:w}=l;h=l.data;let I=!1;if(t.placeholderData!==void 0&&h===void 0&&w==="pending"){let b;n?.isPlaceholderData&&t.placeholderData===i?.placeholderData?(b=n.data,I=!0):b=typeof t.placeholderData=="function"?t.placeholderData(this.#f?.state.data,this.#f):t.placeholderData,b!==void 0&&(w="success",h=$(n?.data,b,t),m=!0)}if(t.select&&h!==void 0&&!I)if(n&&h===c?.data&&t.select===this.#m)h=this.#d;else try{this.#m=t.select,h=t.select(h),h=$(n?.data,h,t),this.#d=h,this.#o=null}catch(b){this.#o=b}this.#o&&(x=this.#o,h=this.#d,S=Date.now(),w="error");const O=l.fetchStatus==="fetching",E=w==="pending",o=w==="error",y=E&&O,C=h!==void 0,g={status:w,fetchStatus:l.fetchStatus,isPending:E,isSuccess:w==="success",isError:o,isInitialLoading:y,isLoading:y,data:h,dataUpdatedAt:l.dataUpdatedAt,error:x,errorUpdatedAt:S,failureCount:l.fetchFailureCount,failureReason:l.fetchFailureReason,errorUpdateCount:l.errorUpdateCount,isFetched:l.dataUpdateCount>0||l.errorUpdateCount>0,isFetchedAfterMount:l.dataUpdateCount>f.dataUpdateCount||l.errorUpdateCount>f.errorUpdateCount,isFetching:O,isRefetching:O&&!E,isLoadingError:o&&!C,isPaused:l.fetchStatus==="paused",isPlaceholderData:m,isRefetchError:o&&C,isStale:L(e,t),refetch:this.refetch,promise:this.#a,isEnabled:v(t.enabled,e)!==!1};if(this.options.experimental_prefetchInRender){const b=N=>{g.status==="error"?N.reject(g.error):g.data!==void 0&&N.resolve(g.data)},M=()=>{const N=this.#a=g.promise=B();b(N)},R=this.#a;switch(R.status){case"pending":e.queryHash===r.queryHash&&b(R);break;case"fulfilled":(g.status==="error"||g.data!==R.value)&&M();break;case"rejected":(g.status!=="error"||g.error!==R.reason)&&M();break}}return g}updateResult(){const e=this.#t,t=this.createResult(this.#e,this.options);if(this.#n=this.#e.state,this.#i=this.options,this.#n.data!==void 0&&(this.#f=this.#e),U(t,e))return;this.#t=t;const r=()=>{if(!e)return!0;const{notifyOnChangeProps:s}=this.options,n=typeof s=="function"?s():s;if(n==="all"||!n&&!this.#p.size)return!0;const c=new Set(n??this.#p);return this.options.throwOnError&&c.add("error"),Object.keys(this.#t).some(i=>{const d=i;return this.#t[d]!==e[d]&&c.has(d)})};this.#E({listeners:r()})}#x(){const e=this.#s.getQueryCache().build(this.#s,this.options);if(e===this.#e)return;const t=this.#e;this.#e=e,this.#r=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#v()}#E(e){_.batch(()=>{e.listeners&&this.listeners.forEach(t=>{t(this.#t)}),this.#s.getQueryCache().notify({query:this.#e,type:"observerResultsUpdated"})})}};function je(e,t){return v(t.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status==="error"&&t.retryOnMount===!1)}function H(e,t){return je(e,t)||e.state.data!==void 0&&A(e,t,t.refetchOnMount)}function A(e,t,r){if(v(t.enabled,e)!==!1&&j(t.staleTime,e)!=="static"){const s=typeof r=="function"?r(e):r;return s==="always"||s!==!1&&L(e,t)}return!1}function q(e,t,r,s){return(e!==t||v(s.enabled,e)===!1)&&(!r.suspense||e.state.status!=="error")&&L(e,r)}function L(e,t){return v(t.enabled,e)!==!1&&e.isStaleByTime(j(t.staleTime,e))}function Ie(e,t){return!U(e.getCurrentResult(),t)}var Te=class extends X{#s;#e=void 0;#r;#t;constructor(e,t){super(),this.#s=e,this.setOptions(t),this.bindMethods(),this.#n()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){const t=this.options;this.options=this.#s.defaultMutationOptions(e),U(this.options,t)||this.#s.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#r,observer:this}),t?.mutationKey&&this.options.mutationKey&&V(t.mutationKey)!==V(this.options.mutationKey)?this.reset():this.#r?.state.status==="pending"&&this.#r.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#r?.removeObserver(this)}onMutationUpdate(e){this.#n(),this.#i(e)}getCurrentResult(){return this.#e}reset(){this.#r?.removeObserver(this),this.#r=void 0,this.#n(),this.#i()}mutate(e,t){return this.#t=t,this.#r?.removeObserver(this),this.#r=this.#s.getMutationCache().build(this.#s,this.options),this.#r.addObserver(this),this.#r.execute(e)}#n(){const e=this.#r?.state??pe();this.#e={...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset}}#i(e){_.batch(()=>{if(this.#t&&this.hasListeners()){const t=this.#e.variables,r=this.#e.context,s={client:this.#s,meta:this.options.meta,mutationKey:this.options.mutationKey};e?.type==="success"?(this.#t.onSuccess?.(e.data,t,r,s),this.#t.onSettled?.(e.data,null,t,r,s)):e?.type==="error"&&(this.#t.onError?.(e.error,t,r,s),this.#t.onSettled?.(void 0,e.error,t,r,s))}this.listeners.forEach(t=>{t(this.#e)})})}},oe=p.createContext(!1),Me=()=>p.useContext(oe);oe.Provider;function Ne(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var Fe=p.createContext(Ne()),Ue=()=>p.useContext(Fe),De=(e,t)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(t.isReset()||(e.retryOnMount=!1))},_e=e=>{p.useEffect(()=>{e.clearReset()},[e])},Pe=({result:e,errorResetBoundary:t,throwOnError:r,query:s,suspense:n})=>e.isError&&!t.isReset()&&!e.isFetching&&s&&(n&&e.data===void 0||Z(r,[e.error,s])),ke=e=>{if(e.suspense){const r=n=>n==="static"?n:Math.max(n??1e3,1e3),s=e.staleTime;e.staleTime=typeof s=="function"?(...n)=>r(s(...n)):r(s),typeof e.gcTime=="number"&&(e.gcTime=Math.max(e.gcTime,1e3))}},Qe=(e,t)=>e.isLoading&&e.isFetching&&!t,Ae=(e,t)=>e?.suspense&&t.isPending,z=(e,t,r)=>t.fetchOptimistic(e).catch(()=>{r.clearReset()});function Le(e,t,r){const s=Me(),n=Ue(),c=P(),i=c.defaultQueryOptions(e);c.getDefaultOptions().queries?._experimental_beforeQuery?.(i),i._optimisticResults=s?"isRestoring":"optimistic",ke(i),De(i,n),_e(n);const d=!c.getQueryCache().get(i.queryHash),[f]=p.useState(()=>new t(c,i)),u=f.getOptimisticResult(i),l=!s&&e.subscribed!==!1;if(p.useSyncExternalStore(p.useCallback(m=>{const h=l?f.subscribe(_.batchCalls(m)):D;return f.updateResult(),h},[f,l]),()=>f.getCurrentResult(),()=>f.getCurrentResult()),p.useEffect(()=>{f.setOptions(i)},[i,f]),Ae(i,u))throw z(i,f,n);if(Pe({result:u,errorResetBoundary:n,throwOnError:i.throwOnError,query:c.getQueryCache().get(i.queryHash),suspense:i.suspense}))throw u.error;return c.getDefaultOptions().queries?._experimental_afterQuery?.(i,u),i.experimental_prefetchInRender&&!Q&&Qe(u,s)&&(d?z(i,f,n):c.getQueryCache().get(i.queryHash)?.promise)?.catch(D).finally(()=>{f.updateResult()}),i.notifyOnChangeProps?u:f.trackResult(u)}function Be(e,t){return Le(e,Oe)}function Ke(e,t){const r=P(),[s]=p.useState(()=>new Te(r,e));p.useEffect(()=>{s.setOptions(e)},[s,e]);const n=p.useSyncExternalStore(p.useCallback(i=>s.subscribe(_.batchCalls(i)),[s]),()=>s.getCurrentResult(),()=>s.getCurrentResult()),c=p.useCallback((i,d)=>{s.mutate(i,d).catch(D)},[s]);if(n.error&&Z(s.options.throwOnError,[n.error]))throw n.error;return{...n,mutate:c,mutateAsync:n.mutate}}const ce=e=>typeof e=="string"?e.includes("Failed to fetch")?"Could not reach endpoint. Possible causes could include network issues, incorrect URL, or server outages.":$e(e):typeof e=="object"&&e?.message?(e?.code?`API: ${e.code}, `:"")+e?.message:"An error occurred",$e=e=>{let t=e;try{t=JSON.parse(e),t?.message&&(t=(t?.code?`API: ${t.code}, `:"")+t?.message)}catch(r){return console.warn(r),e}return t},le=(e,t)=>{let r;return function(...s){const n=this;clearTimeout(r),r=setTimeout(()=>e.apply(n,s),t)}},Ve=async e=>{try{const t=await fetch(`${e}/silences`);if(!t.ok)throw await t.json().catch(()=>{throw new Error("Unexpected error: Unable to parse error response.")});return{silences:await t.json()}}catch(t){throw console.error(t),t}},He=async e=>{try{const t=await fetch(`${e.endpoint}/silence/${e.id}`,{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!t.ok){const r=await t.json().catch(()=>null),s=r?.message||r||`Error ${t.status}: ${t.statusText}`;throw new Error(s)}return await t}catch(t){throw console.error(t),t}},qe=async e=>{try{const t=await fetch(`${e.endpoint}/silences`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e.silence)});if(!t.ok){const r=await t.json().catch(()=>null),s=r?.message||r||`Error ${t.status}: ${t.statusText}`;throw new Error(s)}return await t.json()}catch(t){throw console.error(t),t}},ze={deleteSilences:He,createSilences:qe},ue=(e,t={})=>{const r=ee(),s=ze[e];if(!s)throw new Error(`No mutation function mapped for key: ${e}`);return Ke({mutationFn:n=>s({...n,endpoint:r}),onError:t?.onError,...t})},st=e=>{const{addMessage:t}=te(),r=e.silence,[s,n]=p.useState(!1),c=P(),i=se(),{setSilences:d}=re(),{mutate:f}=ue("deleteSilences",{onSuccess:l=>{c.cancelQueries({queryKey:["silences"]});const m=i.filter(S=>S.id===l.id);let h=m.length>0?m[0]:null;h={...h,status:{state:ae.SILENCE_EXPIRED}};const x=[...i.filter(S=>S?.id!==l?.id),h];d({items:x}),t({variant:"success",text:"Silence expired successfully. Please note that it may take up to 5 minutes for the silence to show up as expired."})},onError:l=>{t({variant:"error",text:ce(l)})},onSettled:()=>{c.invalidateQueries({queryKey:["silences"]})}}),u=le(()=>{f({id:r.id}),n(!1)},200);return a.jsxs(a.Fragment,{children:[a.jsx(ne,{onClick:()=>n(!0),children:"Expire"}),s&&a.jsxs(ie,{cancelButtonLabel:"Cancel",confirmButtonLabel:"Expire Silence",onCancel:()=>n(!1),onConfirm:u,open:!0,title:"Confirmation needed",children:[a.jsxs("p",{children:["Do you really want to expire the silence ",a.jsx("b",{children:r.id}),"?"]}),a.jsxs("p",{children:["Comment for the silence: ",a.jsx("b",{children:r?.comment})]})]})]})},W=[{label:"2 hours",value:2},{label:"12 hours",value:12},{label:"1 day",value:24},{label:"3 days",value:72},{label:"7 days",value:168}],rt=e=>{if(e?.length>0)return e.sort((r,s)=>new Date(s.endsAt).getTime()-new Date(r.endsAt).getTime())[0].endsAt},We=e=>{if(!e)return{items:W};const t=new Date,n=(new Date(e).getTime()-t.getTime())/(1e3*60*60),c=W.map(d=>d.value<=n?{...d,label:d.label+" (covered with the existing silence)",covered:!0}:d),i=c.find(d=>!d?.covered);return{items:c,firstNotCovered:i}},nt=(e,t=[],r=[])=>{if(!e||!t)return;const s=[];return Object.keys(e).forEach(n=>{const c=e?.[n];if(c){const i={name:n,value:c,isRegex:!1,excluded:!1,configurable:!1};r.includes(n)||(t.includes(n)?s.push({...i,excluded:!0,configurable:!0}):s.push(i))}}),s},Ge=e=>{const s={};return e?.comment?.length<3&&(s.comment||(s.comment=[]),s.comment.push("Please enter at least 3 characters")),e?.createdBy?.length<1&&(s.createdBy||(s.createdBy=[]),s.createdBy.push("Please enter a name")),s},G=e=>e.map((t,r)=>a.jsx("span",{className:"block text-theme-danger ",children:t},r)),J={duration:2,comment:""},it=e=>{const t=e.silence,{addMessage:r}=te(),s=me(),n=se(),{setSilences:c}=re(),i=P(),[d,f]=p.useState(!1),[u,l]=p.useState(J),[m,h]=p.useState({}),[x,S]=p.useState(null);p.useLayoutEffect(()=>{d&&(l({...u,...J,createdBy:s||"",matchers:t.matchers,comment:t.comment}),S(null),h({}))},[d]);const w=p.useMemo(()=>{const o=We(0);return o.firstNotCovered&&l({...u,duration:o.firstNotCovered.value}),o.items},[]),{mutate:I}=ue("createSilences",{onMutate:o=>{i.cancelQueries({queryKey:["silences"]});const y={...o.silence,status:{state:ae.SILENCE_ACTIVE}},C=[...n,y];c({items:C}),f(!1)},onSuccess:o=>{r({variant:"success",text:`A silence object with id ${o?.silenceID} was created successfully. Please note that it may
            take up to 5 minutes for the alert to show up as silenced.`})},onError:o=>{r({variant:"error",text:ce(o)})},onSettled:()=>{i.invalidateQueries({queryKey:["silences"]})}}),O=le(()=>{S(null);const o=Ge(u);if(h(o),Object.keys(o).length>0)return;const y={...u},C=new Date,T=new Date;T.setHours(T.getHours()+Number.parseInt(y.duration||4));const g={...y,startsAt:C.toISOString(),endsAt:T.toISOString()};I({silence:g})},200),E=({key:o,value:y})=>{y&&l({...u,[o]:y})};return a.jsxs(a.Fragment,{children:[a.jsx(ne,{onClick:o=>{o.stopPropagation(),f(!d)},children:"Recreate"}),d&&a.jsxs(ie,{title:"New Silence for",size:"large",open:!0,confirmButtonLabel:"Save",onCancel:()=>f(!1),onConfirm:O,children:[x&&a.jsx(ye,{text:x,variant:"danger"}),a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"advanced-area overflow-hidden",children:[a.jsx("p",{className:"mt-2",children:"Matchers attached to this silence"}),a.jsx(ge,{gap:"2",alignment:"start",wrap:!0,className:"mt-2",children:u?.matchers&&Object.keys(u?.matchers).map((o,y)=>a.jsx(be,{pillKey:t?.matchers[o]?.name,pillKeyLabel:t?.matchers[o]?.name,pillValue:t?.matchers[o]?.value,pillValueLabel:t?.matchers[o]?.value},y))})]}),a.jsxs(ve,{className:"mt-6",children:[a.jsx(k,{children:a.jsx(Se,{required:!0,label:"Silenced by",value:u.createdBy,disabled:!!s,onChange:o=>E({key:"createdBy",value:o.target.value}),errortext:m.createdBy&&G(m.createdBy)})}),a.jsx(k,{children:a.jsx(we,{className:"h-20",label:"Description",value:u.comment,onChange:o=>E({key:"comment",value:o.target.value}),errortext:m.comment&&G(m.comment),required:!0})}),a.jsx(k,{children:a.jsx(xe,{required:!0,label:"Duration",value:u.duration,onChange:o=>E({key:"duration",value:o}),children:w?.map(o=>a.jsx(Ee,{label:o.label,value:String(o.value)},o.value))})})]})]})]})]})};let Y;const Je=async e=>{try{const t=await fetch(`${e}/alerts`);if(!t.ok)throw await t.json().catch(()=>{throw new Error("Unexpected error: Unable to parse error response.")});const r=await t.json(),s=Ce(r);s.forEach(c=>{c.labels&&(c.labels.status=c.status?.state)});const n=JSON.stringify(s);return Y!==n?(Y=n,{alerts:s,counts:Re(s)}):null}catch(t){throw console.error(t),t}},Ye={alerts:Je,silences:Ve};class Xe extends Error{constructor(t){super(t.message),this.name="CorsNetworkError",t.stack&&(this.stack=t.stack)}}function Ze(e){if(!(e instanceof TypeError))return!1;const t=e.message||"";return!!(navigator.userAgent.includes("Firefox")&&t.includes("NetworkError"))}const at=(e,{options:t}={})=>{const r=ee(),s=Ye[e];if(!s)throw new Error(`No fetch function mapped for key: ${e}`);return Be({queryKey:[e],queryFn:()=>s(r).catch(n=>{throw Ze(n)?new Xe(n):n}),...t})},ot=()=>a.jsxs("p",{children:["Firefox detected. Please ensure that you have activated ",a.jsx("b",{children:"allow_client_cert"})," to enable the retrieval of alerts and silences from the API.",a.jsxs("ul",{children:[a.jsx("li",{children:"1. Go to about:config (via address bar)"}),a.jsxs("li",{children:["2. Change ",a.jsx("b",{children:"network.cors_preflight.allow_client_cert"})," to ",a.jsx("b",{children:"true"})]}),a.jsx("li",{children:"3. Reload Greenhouse"})]})]});export{Xe as C,st as E,ot as F,it as R,ue as a,le as d,We as g,rt as l,ce as p,nt as s,at as u};
