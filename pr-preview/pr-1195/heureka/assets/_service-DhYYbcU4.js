import{j as e,V as d,d as h,K as E,M as K,N as R,P as B,Q as y,R as C,T as O,U as T,g as V,i as F,u as z,r as u,s as p,X as I,_ as M,J as q,H as b,o as m,m as S,a as w,$ as N,b as D,a0 as _,y as L,e as G,h as H,a1 as A,a2 as k,w as g,A as U,k as Q}from"./App-Dz08YyLd.js";import{a as l}from"./index-BHxdh0xP.js";import{E as f,u as P,C as X,I as $}from"./IssueCountsPerSeverityLevel-CtXR1Tic.js";import{a as J,f as W,S as Y}from"./fetchImageVersions-7BPVJJoB.js";import{I as Z}from"./IssueTimestamp-0ACFl9cS.js";const ee=({instance:s})=>e.jsxs(E,{className:"text-sm text-theme-light",children:[e.jsxs(d,{children:[e.jsx("div",{className:"text-sm whitespace-nowrap overflow-hidden text-ellipsis w-full",children:s?.pod||"--"}),e.jsxs(K,{triggerEvent:"hover",children:[e.jsx(R,{children:e.jsx(h,{icon:"info",size:"18",className:"cursor-pointer hover:text-theme-primary"})}),e.jsxs(B,{children:[e.jsxs("span",{children:[" Namespace: ",s?.namespace||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Region: ",s?.region||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Cluster: ",s?.cluster||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Container: ",s?.container||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Pod: ",s?.pod||"--"]})]})]})]}),e.jsx("div",{className:"text-sm whitespace-nowrap",children:s?.cluster||"--"})]}),se=s=>{const r={};return s.forEach(n=>{const i=n.namespace||"Unknown",o=n.container||"Unknown";r[i]||(r[i]={}),r[i][o]||(r[i][o]=[]),r[i][o].push(n)}),r},re=({imageVersion:s})=>{const[r,n]=l.useState(!1),i=se(s.componentInstances||[]);l.useEffect(()=>{n(!1)},[s]);const o=t=>{t.preventDefault(),n(!r)};return e.jsxs(e.Fragment,{children:[r&&i&&Object.entries(i).map(([t,a])=>e.jsx(e.Fragment,{children:Object.entries(a).map(([x,c])=>e.jsxs("div",{className:"my-2",children:[e.jsxs("div",{className:"mb-4",children:["Namespace ",e.jsx("b",{children:t})," - Container ",e.jsx("b",{children:x})]}),e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,_minmax(240px,_1fr))] gap-2",children:c.map((j,v)=>e.jsx(ee,{instance:j},v))})]},`${t}-${x}`))})),e.jsx("div",{className:"advance-link",children:e.jsx("a",{href:"#",rel:"noopener noreferrer",onClick:o,children:e.jsxs(d,{alignment:"center",children:[r?"Hide Occurrences":"Display Occurrences",e.jsx(h,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})})]})},ne=({queryClient:s,apiClient:r,service:n,imageVersion:i,searchTerm:o,after:t})=>s.ensureQueryData({queryKey:["imageVersionsIssues",n,i,o,t],queryFn:()=>r.query({query:T,variables:{componentVersionFilter:{version:[i]},issueMatchFilter:{serviceCcrn:[n]},issuesFilter:o?{search:[o]}:void 0,first:20,orderByIssueSeverity:[{by:O.Severity,direction:y.Desc}],orderBySeverity:[{by:C.Severity,direction:y.Desc}],orderByTrd:[{by:C.TargetRemediationDate,direction:y.Asc}],after:t}})}),ie=s=>{const r=s.toLowerCase(),n=V(r);return e.jsx(h,{icon:F[r]||"help",color:n})},ae=({severity:s})=>ie(s),oe=s=>`
    border-l-2
    ${V(s.toLowerCase())}
    h-full
    pl-5
  `,te=({issue:s})=>{const[r,n]=l.useState(!1),{needsExpansion:i,textRef:o}=z(s.description),t=a=>{a.preventDefault(),n(!r)};return e.jsxs(u,{children:[e.jsx(p,{className:"pl-0",children:e.jsx("div",{className:oe(s.severity),children:e.jsx(ae,{severity:s.severity})})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceLink&&s.sourceLink!=="-"&&e.jsx("a",{href:s.sourceLink,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(d,{gap:"1.5",alignment:"center",children:[e.jsx(h,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Vulnerability source"})]})})]})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsx(Z,{targetDate:s.earliestTargetRemediation})}),e.jsx(p,{children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{ref:o,className:r?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:s.description}),s.description&&i&&e.jsx("a",{href:"#",onClick:t,className:"link-hover",children:e.jsxs(d,{alignment:"center",children:[r?"Show less":"Show more",e.jsx(h,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})]})})]})},le=({issuesPromise:s})=>{const{error:r,data:n}=l.use(s),{issues:i}=I(n);return r?e.jsxs(f,{colSpan:4,children:["Error loading vulnerabilities: ",r.message]}):i.length===0?e.jsx(f,{colSpan:4,children:"No vulnerabilities found! ðŸš€"}):i.map(o=>e.jsx(te,{issue:o},o.name))},ce=({service:s,imageVersion:r})=>{const{apiClient:n,queryClient:i}=P({from:"/services/$service"}),[o,t]=l.useState(void 0),[a,x]=l.useState(void 0),c=ne({apiClient:n,queryClient:i,service:s,imageVersion:r.version,searchTerm:o,after:a});return e.jsxs(e.Fragment,{children:[e.jsxs(d,{gap:"2",className:"mb-4 mt-8",children:[e.jsx(M,{children:"Vulnerabilities"}),e.jsx(q,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:j=>t(j||""),onClear:()=>{t("")}})]}),e.jsxs(b,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(u,{children:[e.jsx(m,{children:e.jsx(h,{icon:"monitorHeart"})}),e.jsx(m,{children:"Vulnerability"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"})]}),c&&e.jsx(l.Suspense,{fallback:e.jsx(f,{colSpan:4,children:e.jsxs(d,{gap:"2",alignment:"center",children:[e.jsx("div",{children:"Loading vulnerabilities"}),e.jsx(S,{variant:"primary"})]})}),children:e.jsx(le,{issuesPromise:c})})]}),c&&e.jsx(l.Suspense,{children:e.jsx(X,{dataPromise:c,dataNormalizationMethod:I,goToPage:x})})]})},de=({imageVersionsPromise:s})=>{const r=w(),{service:n}=N({from:"/services/$service"}),{imageVersion:i}=D({from:"/services/$service"}),{data:o}=l.use(s),{imageVersions:t}=_(o),a=t.find(x=>x.version===i);return a?e.jsx(L,{children:e.jsx(G,{heading:`Image ${a.repository} Information`,opened:!!n,onClose:()=>r({to:"/services/$service",params:{service:n}}),size:"large",children:e.jsxs(H,{children:[e.jsx(A,{py:!0,px:!1,children:e.jsx(k,{})}),e.jsxs(b,{columns:2,gridColumnTemplate:"20% auto",children:[e.jsxs(u,{children:[e.jsx(m,{children:"Details"}),e.jsx(p,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(g,{pillKey:"tag",pillKeyLabel:"tag",pillValue:a.tag,pillValueLabel:a.tag}),e.jsx(g,{pillKey:"repository",pillKeyLabel:"repository",pillValue:a.repository,pillValueLabel:a.repository}),e.jsx(g,{pillKey:"version",pillKeyLabel:"version",pillValue:a.version,pillValueLabel:a.version})]})})]}),e.jsxs(u,{children:[e.jsx(m,{children:"Vulnerabilities Counts"}),e.jsx(p,{children:e.jsx($,{counts:a.issueCounts})})]}),e.jsxs(u,{children:[e.jsx(m,{className:"whitespace-nowrap",children:`Occurrences (${a.componentInstancesCount||0})`}),e.jsx(p,{children:e.jsx(re,{imageVersion:a})})]})]}),n&&i&&a&&e.jsx(ce,{service:n,imageVersion:a})]})})}):null},pe=({servicePromise:s})=>{const{data:r}=l.use(s),n=U(r).services[0];return e.jsxs(e.Fragment,{children:[e.jsxs(J,{children:["Service ",n.name]}),e.jsxs(b,{columns:2,gridColumnTemplate:"20% auto",className:"mb-6",children:[e.jsxs(u,{children:[e.jsx(m,{children:"Details"}),e.jsx(p,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(g,{pillKey:"service",pillKeyLabel:"service",pillValue:n.name,pillValueLabel:n.name}),n.serviceDetails?.supportGroups?.map(i=>e.jsx(g,{pillKey:"support_group",pillKeyLabel:"support_group",pillValue:i,pillValueLabel:i},i))]})})]}),e.jsxs(u,{children:[e.jsx(m,{children:"Vulnerabilities Counts"}),e.jsx(p,{children:e.jsx($,{counts:n.issuesCount})})]})]})]})},me=()=>{const s=w(),{queryClient:r,apiClient:n}=P({from:"/services/$service"}),{servicePromise:i}=Q({from:"/services/$service"}),{service:o}=N({from:"/services/$service"}),{imageVersion:t}=D({from:"/services/$service"}),[a,x]=l.useState(void 0),[c,j]=l.useState(void 0);return l.useEffect(()=>{const v=W({queryClient:r,apiClient:n,service:o,after:a});j(v)},[a]),e.jsxs(L,{children:[e.jsx(k,{className:"mb-4"}),e.jsx(l.Suspense,{fallback:e.jsx(S,{className:"mt-4"}),children:e.jsx(pe,{servicePromise:i})}),c&&e.jsx(Y,{selectedImageVersion:t,imageVersionsPromise:c,onImageVersionItemClick:v=>{s({to:"/services/$service",params:{service:o},search:{imageVersion:v.version}})},goToPage:x}),e.jsx(l.Suspense,{children:c&&e.jsx(de,{imageVersionsPromise:c})})]})},ge=me;export{ge as component};
