import{aw as W,ax as B,ay as b,az as D,aA as F,aB as le,aC as N,aD as L,aE as ue,aF as he,aG as de,aH as _,aI as U,aJ as K,aK as fe,x as A,aL as Y,s as X,a as Z,e as ee,j as a,U as te,T as se,c as re,D as pe,Y as me,K as ye,O as ge,H as ve,M,I as be,J as Se,A as xe,h as we,aM as Ce,aN as Re}from"./App-6jGlygB9.js";import{r as f}from"./index-CFrikhZ8.js";var Oe=class extends W{constructor(e,t){super(),this.options=t,this.#s=e,this.#i=null,this.#o=B(),this.options.experimental_prefetchInRender||this.#o.reject(new Error("experimental_prefetchInRender feature flag is not enabled")),this.bindMethods(),this.setOptions(t)}#s;#e=void 0;#r=void 0;#t=void 0;#n;#a;#o;#i;#m;#d;#f;#l;#u;#c;#p=new Set;bindMethods(){this.refetch=this.refetch.bind(this)}onSubscribe(){this.listeners.size===1&&(this.#e.addObserver(this),$(this.#e,this.options)?this.#h():this.updateResult(),this.#b())}onUnsubscribe(){this.hasListeners()||this.destroy()}shouldFetchOnReconnect(){return k(this.#e,this.options,this.options.refetchOnReconnect)}shouldFetchOnWindowFocus(){return k(this.#e,this.options,this.options.refetchOnWindowFocus)}destroy(){this.listeners=new Set,this.#S(),this.#x(),this.#e.removeObserver(this)}setOptions(e,t){const s=this.options,r=this.#e;if(this.options=this.#s.defaultQueryOptions(e),this.options.enabled!==void 0&&typeof this.options.enabled!="boolean"&&typeof this.options.enabled!="function"&&typeof b(this.options.enabled,this.#e)!="boolean")throw new Error("Expected enabled to be a boolean or a callback that returns a boolean");this.#w(),this.#e.setOptions(this.options),s._defaulted&&!D(this.options,s)&&this.#s.getQueryCache().notify({type:"observerOptionsUpdated",query:this.#e,observer:this});const n=this.hasListeners();n&&q(this.#e,r,this.options,s)&&this.#h(),this.updateResult(t),n&&(this.#e!==r||b(this.options.enabled,this.#e)!==b(s.enabled,this.#e)||F(this.options.staleTime,this.#e)!==F(s.staleTime,this.#e))&&this.#y();const c=this.#g();n&&(this.#e!==r||b(this.options.enabled,this.#e)!==b(s.enabled,this.#e)||c!==this.#c)&&this.#v(c)}getOptimisticResult(e){const t=this.#s.getQueryCache().build(this.#s,e),s=this.createResult(t,e);return je(this,s)&&(this.#t=s,this.#a=this.options,this.#n=this.#e.state),s}getCurrentResult(){return this.#t}trackResult(e,t){const s={};return Object.keys(e).forEach(r=>{Object.defineProperty(s,r,{configurable:!1,enumerable:!0,get:()=>(this.trackProp(r),t?.(r),e[r])})}),s}trackProp(e){this.#p.add(e)}getCurrentQuery(){return this.#e}refetch({...e}={}){return this.fetch({...e})}fetchOptimistic(e){const t=this.#s.defaultQueryOptions(e),s=this.#s.getQueryCache().build(this.#s,t);return s.fetch().then(()=>this.createResult(s,t))}fetch(e){return this.#h({...e,cancelRefetch:e.cancelRefetch??!0}).then(()=>(this.updateResult(),this.#t))}#h(e){this.#w();let t=this.#e.fetch(this.options,e);return e?.throwOnError||(t=t.catch(le)),t}#y(){this.#S();const e=F(this.options.staleTime,this.#e);if(N||this.#t.isStale||!L(e))return;const s=ue(this.#t.dataUpdatedAt,e)+1;this.#l=setTimeout(()=>{this.#t.isStale||this.updateResult()},s)}#g(){return(typeof this.options.refetchInterval=="function"?this.options.refetchInterval(this.#e):this.options.refetchInterval)??!1}#v(e){this.#x(),this.#c=e,!(N||b(this.options.enabled,this.#e)===!1||!L(this.#c)||this.#c===0)&&(this.#u=setInterval(()=>{(this.options.refetchIntervalInBackground||he.isFocused())&&this.#h()},this.#c))}#b(){this.#y(),this.#v(this.#g())}#S(){this.#l&&(clearTimeout(this.#l),this.#l=void 0)}#x(){this.#u&&(clearInterval(this.#u),this.#u=void 0)}createResult(e,t){const s=this.#e,r=this.options,n=this.#t,c=this.#n,i=this.#a,h=e!==s?e.state:this.#r,{state:u}=e;let l={...u},g=!1,p;if(t._optimisticResults){const m=this.hasListeners(),R=!m&&$(e,t),O=m&&q(e,s,t,r);(R||O)&&(l={...l,...de(u.data,e.options)}),t._optimisticResults==="isRestoring"&&(l.fetchStatus="idle")}let{error:w,errorUpdatedAt:S,status:x}=l;if(t.select&&l.data!==void 0)if(n&&l.data===c?.data&&t.select===this.#m)p=this.#d;else try{this.#m=t.select,p=t.select(l.data),p=_(n?.data,p,t),this.#d=p,this.#i=null}catch(m){this.#i=m}else p=l.data;if(t.placeholderData!==void 0&&p===void 0&&x==="pending"){let m;if(n?.isPlaceholderData&&t.placeholderData===i?.placeholderData)m=n.data;else if(m=typeof t.placeholderData=="function"?t.placeholderData(this.#f?.state.data,this.#f):t.placeholderData,t.select&&m!==void 0)try{m=t.select(m),this.#i=null}catch(R){this.#i=R}m!==void 0&&(x="success",p=_(n?.data,m,t),g=!0)}this.#i&&(w=this.#i,p=this.#d,S=Date.now(),x="error");const E=l.fetchStatus==="fetching",j=x==="pending",C=x==="error",o=j&&E,v=p!==void 0,y={status:x,fetchStatus:l.fetchStatus,isPending:j,isSuccess:x==="success",isError:C,isInitialLoading:o,isLoading:o,data:p,dataUpdatedAt:l.dataUpdatedAt,error:w,errorUpdatedAt:S,failureCount:l.fetchFailureCount,failureReason:l.fetchFailureReason,errorUpdateCount:l.errorUpdateCount,isFetched:l.dataUpdateCount>0||l.errorUpdateCount>0,isFetchedAfterMount:l.dataUpdateCount>h.dataUpdateCount||l.errorUpdateCount>h.errorUpdateCount,isFetching:E,isRefetching:E&&!j,isLoadingError:C&&!v,isPaused:l.fetchStatus==="paused",isPlaceholderData:g,isRefetchError:C&&v,isStale:P(e,t),refetch:this.refetch,promise:this.#o};if(this.options.experimental_prefetchInRender){const m=I=>{y.status==="error"?I.reject(y.error):y.data!==void 0&&I.resolve(y.data)},R=()=>{const I=this.#o=y.promise=B();m(I)},O=this.#o;switch(O.status){case"pending":e.queryHash===s.queryHash&&m(O);break;case"fulfilled":(y.status==="error"||y.data!==O.value)&&R();break;case"rejected":(y.status!=="error"||y.error!==O.reason)&&R();break}}return y}updateResult(e){const t=this.#t,s=this.createResult(this.#e,this.options);if(this.#n=this.#e.state,this.#a=this.options,this.#n.data!==void 0&&(this.#f=this.#e),D(s,t))return;this.#t=s;const r={},n=()=>{if(!t)return!0;const{notifyOnChangeProps:c}=this.options,i=typeof c=="function"?c():c;if(i==="all"||!i&&!this.#p.size)return!0;const d=new Set(i??this.#p);return this.options.throwOnError&&d.add("error"),Object.keys(this.#t).some(h=>{const u=h;return this.#t[u]!==t[u]&&d.has(u)})};e?.listeners!==!1&&n()&&(r.listeners=!0),this.#C({...r,...e})}#w(){const e=this.#s.getQueryCache().build(this.#s,this.options);if(e===this.#e)return;const t=this.#e;this.#e=e,this.#r=e.state,this.hasListeners()&&(t?.removeObserver(this),e.addObserver(this))}onQueryUpdate(){this.updateResult(),this.hasListeners()&&this.#b()}#C(e){U.batch(()=>{e.listeners&&this.listeners.forEach(t=>{t(this.#t)}),this.#s.getQueryCache().notify({query:this.#e,type:"observerResultsUpdated"})})}};function Ee(e,t){return b(t.enabled,e)!==!1&&e.state.data===void 0&&!(e.state.status==="error"&&t.retryOnMount===!1)}function $(e,t){return Ee(e,t)||e.state.data!==void 0&&k(e,t,t.refetchOnMount)}function k(e,t,s){if(b(t.enabled,e)!==!1){const r=typeof s=="function"?s(e):s;return r==="always"||r!==!1&&P(e,t)}return!1}function q(e,t,s,r){return(e!==t||b(r.enabled,e)===!1)&&(!s.suspense||e.state.status!=="error")&&P(e,s)}function P(e,t){return b(t.enabled,e)!==!1&&e.isStaleByTime(F(t.staleTime,e))}function je(e,t){return!D(e.getCurrentResult(),t)}var Te=class extends W{#s;#e=void 0;#r;#t;constructor(e,t){super(),this.#s=e,this.setOptions(t),this.bindMethods(),this.#n()}bindMethods(){this.mutate=this.mutate.bind(this),this.reset=this.reset.bind(this)}setOptions(e){const t=this.options;this.options=this.#s.defaultMutationOptions(e),D(this.options,t)||this.#s.getMutationCache().notify({type:"observerOptionsUpdated",mutation:this.#r,observer:this}),t?.mutationKey&&this.options.mutationKey&&K(t.mutationKey)!==K(this.options.mutationKey)?this.reset():this.#r?.state.status==="pending"&&this.#r.setOptions(this.options)}onUnsubscribe(){this.hasListeners()||this.#r?.removeObserver(this)}onMutationUpdate(e){this.#n(),this.#a(e)}getCurrentResult(){return this.#e}reset(){this.#r?.removeObserver(this),this.#r=void 0,this.#n(),this.#a()}mutate(e,t){return this.#t=t,this.#r?.removeObserver(this),this.#r=this.#s.getMutationCache().build(this.#s,this.options),this.#r.addObserver(this),this.#r.execute(e)}#n(){const e=this.#r?.state??fe();this.#e={...e,isPending:e.status==="pending",isSuccess:e.status==="success",isError:e.status==="error",isIdle:e.status==="idle",mutate:this.mutate,reset:this.reset}}#a(e){U.batch(()=>{if(this.#t&&this.hasListeners()){const t=this.#e.variables,s=this.#e.context;e?.type==="success"?(this.#t.onSuccess?.(e.data,t,s),this.#t.onSettled?.(e.data,null,t,s)):e?.type==="error"&&(this.#t.onError?.(e.error,t,s),this.#t.onSettled?.(void 0,e.error,t,s))}this.listeners.forEach(t=>{t(this.#e)})})}},ne=f.createContext(!1),Ie=()=>f.useContext(ne);ne.Provider;function Fe(){let e=!1;return{clearReset:()=>{e=!1},reset:()=>{e=!0},isReset:()=>e}}var De=f.createContext(Fe()),Ue=()=>f.useContext(De);function ie(e,t){return typeof e=="function"?e(...t):!!e}function Q(){}var Ae=(e,t)=>{(e.suspense||e.throwOnError||e.experimental_prefetchInRender)&&(t.isReset()||(e.retryOnMount=!1))},Me=e=>{f.useEffect(()=>{e.clearReset()},[e])},Ne=({result:e,errorResetBoundary:t,throwOnError:s,query:r})=>e.isError&&!t.isReset()&&!e.isFetching&&r&&ie(s,[e.error,r]),ke=e=>{e.suspense&&(e.staleTime===void 0&&(e.staleTime=1e3),typeof e.gcTime=="number"&&(e.gcTime=Math.max(e.gcTime,1e3)))},Qe=(e,t)=>e.isLoading&&e.isFetching&&!t,Pe=(e,t)=>e?.suspense&&t.isPending,H=(e,t,s)=>t.fetchOptimistic(e).catch(()=>{s.clearReset()});function Be(e,t,s){const r=A(),n=Ie(),c=Ue(),i=r.defaultQueryOptions(e);r.getDefaultOptions().queries?._experimental_beforeQuery?.(i),i._optimisticResults=n?"isRestoring":"optimistic",ke(i),Ae(i,c),Me(c);const d=!r.getQueryCache().get(i.queryHash),[h]=f.useState(()=>new t(r,i)),u=h.getOptimisticResult(i);if(f.useSyncExternalStore(f.useCallback(l=>{const g=n?Q:h.subscribe(U.batchCalls(l));return h.updateResult(),g},[h,n]),()=>h.getCurrentResult(),()=>h.getCurrentResult()),f.useEffect(()=>{h.setOptions(i,{listeners:!1})},[i,h]),Pe(i,u))throw H(i,h,c);if(Ne({result:u,errorResetBoundary:c,throwOnError:i.throwOnError,query:r.getQueryCache().get(i.queryHash)}))throw u.error;return r.getDefaultOptions().queries?._experimental_afterQuery?.(i,u),i.experimental_prefetchInRender&&!N&&Qe(u,n)&&(d?H(i,h,c):r.getQueryCache().get(i.queryHash)?.promise)?.catch(Q).finally(()=>{h.updateResult()}),i.notifyOnChangeProps?u:h.trackResult(u)}function Le(e,t){return Be(e,Oe)}function _e(e,t){const s=A(),[r]=f.useState(()=>new Te(s,e));f.useEffect(()=>{r.setOptions(e)},[r,e]);const n=f.useSyncExternalStore(f.useCallback(i=>r.subscribe(U.batchCalls(i)),[r]),()=>r.getCurrentResult(),()=>r.getCurrentResult()),c=f.useCallback((i,d)=>{r.mutate(i,d).catch(Q)},[r]);if(n.error&&ie(r.options.throwOnError,[n.error]))throw n.error;return{...n,mutate:c,mutateAsync:n.mutate}}const ae=e=>typeof e=="string"?e.includes("Failed to fetch")?"Could not reach endpoint. Possible causes could include network issues, incorrect URL, or server outages.":Ke(e):typeof e=="object"&&e?.message?(e?.code?`API: ${e.code}, `:"")+e?.message:"An error occurred",Ke=e=>{let t=e;try{t=JSON.parse(e),t?.message&&(t=(t?.code?`API: ${t.code}, `:"")+t?.message)}catch(s){return console.warn(s),e}return t},oe=(e,t)=>{let s;return function(...r){const n=this;clearTimeout(s),s=setTimeout(()=>e.apply(n,r),t)}},$e=async e=>{try{const t=await fetch(`${e}/silences`);if(!t.ok)throw await t.json().catch(()=>{throw new Error("Unexpected error: Unable to parse error response.")});return{silences:await t.json()}}catch(t){throw console.error(t),t}},qe=async e=>{try{const t=await fetch(`${e.endpoint}/silence/${e.id}`,{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json"}});if(!t.ok){const s=await t.json().catch(()=>null),r=s?.message||s||`Error ${t.status}: ${t.statusText}`;throw new Error(r)}return await t}catch(t){throw console.error(t),t}},He=async e=>{try{const t=await fetch(`${e.endpoint}/silences`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(e.silence)});if(!t.ok){const s=await t.json().catch(()=>null),r=s?.message||s||`Error ${t.status}: ${t.statusText}`;throw new Error(r)}return await t.json()}catch(t){throw console.error(t),t}},Ve={deleteSilences:qe,createSilences:He},ce=(e,t={})=>{const s=Y(),r=Ve[e];if(!r)throw new Error(`No mutation function mapped for key: ${e}`);return _e({mutationFn:n=>r({...n,endpoint:s}),onError:t?.onError,...t})},tt=e=>{const{addMessage:t}=X(),s=e.silence,[r,n]=f.useState(!1),c=A(),i=Z(),{setSilences:d}=ee(),{mutate:h}=ce("deleteSilences",{onSuccess:l=>{c.cancelQueries({queryKey:["silences"]});const g=i.filter(S=>S.id===l.id);let p=g.length>0?g[0]:null;p={...p,status:{state:re.SILENCE_EXPIRED}};const w=[...i.filter(S=>S?.id!==l?.id),p];d({items:w}),t({variant:"success",text:"Silence expired successfully. Please note that it may take up to 5 minutes for the silence to show up as expired."})},onError:l=>{t({variant:"error",text:ae(l)})},onSettled:()=>{c.invalidateQueries({queryKey:["silences"]})}}),u=oe(()=>{h({id:s.id}),n(!1)},200);return a.jsxs(a.Fragment,{children:[a.jsx(te,{onClick:()=>n(!0),children:"Expire"}),r&&a.jsxs(se,{cancelButtonLabel:"Cancel",confirmButtonLabel:"Expire Silence",onCancel:()=>n(!1),onConfirm:u,open:!0,title:"Confirmation needed",children:[a.jsxs("p",{children:["Do you really want to expire the silence ",a.jsx("b",{children:s.id}),"?"]}),a.jsxs("p",{children:["Comment for the silence: ",a.jsx("b",{children:s?.comment})]})]})]})},V=[{label:"2 hours",value:2},{label:"12 hours",value:12},{label:"1 day",value:24},{label:"3 days",value:72},{label:"7 days",value:168}],st=e=>{if(e?.length>0)return e.sort((s,r)=>new Date(r.endsAt).getTime()-new Date(s.endsAt).getTime())[0].endsAt},ze=e=>{if(!e)return{items:V};const t=new Date,n=(new Date(e).getTime()-t.getTime())/(1e3*60*60),c=V.map(d=>d.value<=n?{...d,label:d.label+" (covered with the existing silence)",covered:!0}:d),i=c.find(d=>!d?.covered);return{items:c,firstNotCovered:i}},rt=(e,t=[],s=[])=>{if(!e||!t)return;const r=[];return Object.keys(e).forEach(n=>{const c=e?.[n];if(c){const i={name:n,value:c,isRegex:!1,excluded:!1,configurable:!1};s.includes(n)||(t.includes(n)?r.push({...i,excluded:!0,configurable:!0}):r.push(i))}}),r},Ge=e=>{const r={};return e?.comment?.length<3&&(r.comment||(r.comment=[]),r.comment.push("Please enter at least 3 characters")),e?.createdBy?.length<1&&(r.createdBy||(r.createdBy=[]),r.createdBy.push("Please enter a name")),r},z=e=>e.map((t,s)=>a.jsx("span",{className:"block text-theme-danger ",children:t},s)),G={duration:2,comment:""},nt=e=>{const t=e.silence,{addMessage:s}=X(),r=pe(),n=Z(),{setSilences:c}=ee(),i=A(),[d,h]=f.useState(!1),[u,l]=f.useState(G),[g,p]=f.useState({}),[w,S]=f.useState(null);f.useLayoutEffect(()=>{d&&(l({...u,...G,createdBy:r||"",matchers:t.matchers,comment:t.comment}),S(null),p({}))},[d]);const x=f.useMemo(()=>{const o=ze(0);return o.firstNotCovered&&l({...u,duration:o.firstNotCovered.value}),o.items},[]),{mutate:E}=ce("createSilences",{onMutate:o=>{i.cancelQueries({queryKey:["silences"]});const v={...o.silence,status:{state:re.SILENCE_ACTIVE}},T=[...n,v];c({items:T}),h(!1)},onSuccess:o=>{s({variant:"success",text:`A silence object with id ${o?.silenceID} was created successfully. Please note that it may
            take up to 5 minutes for the alert to show up as silenced.`})},onError:o=>{s({variant:"error",text:ae(o)})},onSettled:()=>{i.invalidateQueries({queryKey:["silences"]})}}),j=oe(()=>{S(null);const o=Ge(u);if(p(o),Object.keys(o).length>0)return;const v={...u},T=new Date,y=new Date;y.setHours(y.getHours()+Number.parseInt(v.duration||4));const m={...v,startsAt:T.toISOString(),endsAt:y.toISOString()};E({silence:m})},200),C=({key:o,value:v})=>{v&&l({...u,[o]:v})};return a.jsxs(a.Fragment,{children:[a.jsx(te,{onClick:o=>{o.stopPropagation(),h(!d)},children:"Recreate"}),d&&a.jsxs(se,{title:"New Silence for",size:"large",open:!0,confirmButtonLabel:"Save",onCancel:()=>h(!1),onConfirm:j,children:[w&&a.jsx(me,{text:w,variant:"danger"}),a.jsxs(a.Fragment,{children:[a.jsxs("div",{className:"advanced-area overflow-hidden",children:[a.jsx("p",{className:"mt-2",children:"Matchers attached to this silence"}),a.jsx(ye,{gap:"2",alignment:"start",wrap:!0,className:"mt-2",children:u?.matchers&&Object.keys(u?.matchers).map((o,v)=>a.jsx(ge,{pillKey:t?.matchers[o]?.name,pillKeyLabel:t?.matchers[o]?.name,pillValue:t?.matchers[o]?.value,pillValueLabel:t?.matchers[o]?.value},v))})]}),a.jsxs(ve,{className:"mt-6",children:[a.jsx(M,{children:a.jsx(be,{required:!0,label:"Silenced by",value:u.createdBy,disabled:!!r,onChange:o=>C({key:"createdBy",value:o.target.value}),errortext:g.createdBy&&z(g.createdBy)})}),a.jsx(M,{children:a.jsx(Se,{className:"h-20",label:"Description",value:u.comment,onChange:o=>C({key:"comment",value:o.target.value}),errortext:g.comment&&z(g.comment),required:!0})}),a.jsx(M,{children:a.jsx(xe,{required:!0,label:"Duration",value:u.duration,onChange:o=>C({key:"duration",value:o}),children:x?.map(o=>a.jsx(we,{label:o.label,value:String(o.value)},o.value))})})]})]})]})]})};let J;const Je=async e=>{try{const t=await fetch(`${e}/alerts`);if(!t.ok)throw await t.json().catch(()=>{throw new Error("Unexpected error: Unable to parse error response.")});const s=await t.json(),r=Ce(s);r.forEach(c=>{c.labels&&(c.labels.status=c.status?.state)});const n=JSON.stringify(r);return J!==n?(J=n,{alerts:r,counts:Re(r)}):null}catch(t){throw console.error(t),t}},We={alerts:Je,silences:$e};class Ye extends Error{constructor(t){super(t.message),this.name="CorsNetworkError",t.stack&&(this.stack=t.stack)}}function Xe(e){if(!(e instanceof TypeError))return!1;const t=e.message||"";return!!(navigator.userAgent.includes("Firefox")&&t.includes("NetworkError"))}const it=(e,{options:t}={})=>{const s=Y(),r=We[e];if(!r)throw new Error(`No fetch function mapped for key: ${e}`);return Le({queryKey:[e],queryFn:()=>r(s).catch(n=>{throw Xe(n)?new Ye(n):n}),...t})},at=()=>a.jsxs("p",{children:["Firefox detected. Please ensure that you have activated ",a.jsx("b",{children:"allow_client_cert"})," to enable the retrieval of alerts and silences from the API.",a.jsxs("ul",{children:[a.jsx("li",{children:"1. Go to about:config (via address bar)"}),a.jsxs("li",{children:["2. Change ",a.jsx("b",{children:"network.cors_preflight.allow_client_cert"})," to ",a.jsx("b",{children:"true"})]}),a.jsx("li",{children:"3. Reload Greenhouse"})]})]});export{Ye as C,tt as E,at as F,nt as R,ce as a,oe as d,ze as g,st as l,ae as p,rt as s,it as u};
