(function(){"use strict";function N(s){let e={serviceName:null,initialFetch:!0,fetchFn:null,watch:!0,watchInterval:3e5,onFetchStart:null,onFetchEnd:null,onFetchError:null,debug:!1},r=!1;const t=Object.keys(e);let a;const c=()=>{if(e.fetchFn)return e.onFetchStart&&e.onFetchStart(),e!=null&&e.debug&&console.info(`ApiService::${e.serviceName||""}: start fetch`),r=!0,e.fetchFn().then(()=>{e.onFetchEnd&&e.onFetchEnd()}).catch(l=>{console.warn("ApiService::%s:%s",e.serviceName,l),e.onFetchError&&e.onFetchError(l)});e!=null&&e.debug&&console.warn(`ApiService::${e.serviceName||""}: missing fetch function`)},n=l=>{r&&l.watch===e.watch&&l.watchInterval===e.watchInterval||(clearInterval(a),e.watch&&(a=setInterval(c,e.watchInterval||3e5)))};this.configure=l=>{const u={...e};e={...e,...l},Object.keys(e).forEach(i=>t.indexOf(i)<0&&delete e[i]),e!=null&&e.debug&&console.debug("ApiService::%s: new config: %s",e.serviceName,e),n(u),e.initialFetch&&!r&&c()},this.fetch=c,this.configure(s)}class I extends Error{constructor(e,r){super(r||e),this.name="HTTPError",this.statusCode=e}}const O=s=>s.status<400?s:s.text().then(e=>{var r=new I(s.status,e||s.statusText);return r.statusCode=s.status,r.httperror=!0,Promise.reject(r)}),j={"Content-Type":"application/json",Accept:"application/json"},D=(s,e={})=>{const r={headers:j,...e};return fetch(s,r).then(O).then(t=>{const a=t.headers.get("Content-Type");return a&&a.includes("application/json")?t.json():t.text()})},H=(s,e={})=>D(s,{method:"GET",...e}),x=s=>{const e={global:{total:0},regions:{}};return!s||s.length===0||s.forEach(r=>{var n,l,u,i,o;e.global.total+=1;const t=(n=r.labels)==null?void 0:n.region,a=(l=r.labels)==null?void 0:l.severity,c=(u=r.status)==null?void 0:u.state;e.global[a]=e.global[a]||0,e.global[a]+=1,e.regions[t]=e.regions[t]||{},e.regions[t].total=e.regions[t].total||0,e.regions[t].total+=1,e.regions[t][a]=e.regions[t][a]||{},e.regions[t][a].total=((i=e.regions[t][a])==null?void 0:i.total)||0,e.regions[t][a].total+=1,c==="suppressed"&&(e.regions[t][a].suppressed=((o=e.regions[t][a])==null?void 0:o.suppressed)||0,e.regions[t][a].suppressed+=1)}),e},U=s=>{const e=["critical","warning"];return s.sort((r,t)=>{var a,c,n,l,u,i,o,h,g,d,E,v,A,T,F,m,S,b,w,y,R,C,L,_;return((a=r.labels)==null?void 0:a.severity)==="critical"&&((c=t.labels)==null?void 0:c.severity)!=="critical"||((n=r.labels)==null?void 0:n.severity)==="warning"&&e.indexOf((l=t.labels)==null?void 0:l.severity)<0?-1:((u=r.labels)==null?void 0:u.severity)===((i=t.labels)==null?void 0:i.severity)&&((o=r.status)==null?void 0:o.state)!==((h=t.status)==null?void 0:h.state)&&((g=r.status)!=null&&g.state)?(E=r.status)==null?void 0:E.state.localeCompare((d=t.status)==null?void 0:d.state):((v=r.labels)==null?void 0:v.severity)===((A=t.labels)==null?void 0:A.severity)&&((T=r.status)==null?void 0:T.state)===((F=t.status)==null?void 0:F.state)&&r.startsAt!==t.startsAt&&t.startsAt?(m=t.startsAt)==null?void 0:m.localeCompare(r.startsAt):((S=r.labels)==null?void 0:S.severity)===((b=t.labels)==null?void 0:b.severity)&&((w=r.status)==null?void 0:w.state)===((y=t.status)==null?void 0:y.state)&&r.startsAt===t.startsAt&&((R=r.labels)!=null&&R.region)?(_=(C=r.labels)==null?void 0:C.region)==null?void 0:_.localeCompare((L=t.labels)==null?void 0:L.region):1})};let f;const V=(s,e={})=>H(`${s}/alerts`,{params:e.params}).then(r=>{let t=U(r);t.forEach(c=>{var n;c.labels&&(c.labels.status=(n=c.status)==null?void 0:n.state)}),e!=null&&e.limit&&(e!=null&&e.debug&&console.info("Alerts service: limit set: ",e==null?void 0:e.limit),t=t.slice(0,e==null?void 0:e.limit));const a=JSON.stringify(t);e!=null&&e.debug&&console.info("Alerts service: any changes?",f!==a),f!==a?(f=a,e!=null&&e.debug&&console.info("Alerts service: inform listener"),self.postMessage({action:"ALERTS_UPDATE",alerts:t,counts:x(t)})):e!=null&&e.debug&&console.info("Alerts service: no change found")}),P=new N({serviceName:"alerts",debug:!0,onFetchStart:()=>self.postMessage({action:"ALERTS_FETCH_START"}),onFetchEnd:()=>self.postMessage({action:"ALERTS_FETCH_END"}),onFetchError:s=>{self.postMessage({action:"ALERTS_FETCH_ERROR",error:s.message})}});self.onmessage=s=>{var r,t,a;switch(((r=s==null?void 0:s.data)==null?void 0:r.action)||""){case"ALERTS_CONFIGURE":(a=(t=s==null?void 0:s.data)==null?void 0:t.fetchVars)!=null&&a.apiEndpoint&&(s.data.fetchFn=()=>{var c,n;return V((c=s.data)==null?void 0:c.fetchVars.apiEndpoint,((n=s.data)==null?void 0:n.fetchVars.options)||{})}),P.configure((s==null?void 0:s.data)||{});break;case"ALERTS_FETCH":alertService.fetch();break}}})();
