import{j as e,K as d,f as h,L as $,Z as K,w as F,y as O,A as f,B as C,D as R,G as z,C as u,v as p,E as b,F as T,W as B,l as I,h as m,x as S,b as w,J as V,d as N,M,e as D,i as q,I as _,N as G,P as L,k as g,m as A,u as H}from"./App-DRu_KzCf.js";import{a as t}from"./index-CmTL6-9U.js";import{g as k,E as y,u as E,C as W}from"./CursorPagination-CdApIftj.js";import{I as P,b as U,f as Z,S as J}from"./IssueCountsPerSeverityLevel-BxGv1GWd.js";import{I as Q}from"./IssueTimestamp-CoLKDUFG.js";const X=({instance:s})=>e.jsxs($,{className:"text-sm text-theme-light",children:[e.jsxs(d,{children:[e.jsx("div",{className:"text-sm whitespace-nowrap overflow-hidden text-ellipsis w-full",children:s?.pod||"--"}),e.jsxs(K,{triggerEvent:"hover",children:[e.jsx(F,{children:e.jsx(h,{icon:"info",size:"18",className:"cursor-pointer hover:text-theme-primary"})}),e.jsxs(O,{children:[e.jsxs("span",{children:[" Namespace: ",s?.namespace||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Region: ",s?.region||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Cluster: ",s?.cluster||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Container: ",s?.container||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Pod: ",s?.pod||"--"]})]})]})]}),e.jsx("div",{className:"text-sm whitespace-nowrap",children:s?.cluster||"--"})]}),Y=s=>{const r={};return s.forEach(n=>{const i=n.namespace||"Unknown",a=n.container||"Unknown";r[i]||(r[i]={}),r[i][a]||(r[i][a]=[]),r[i][a].push(n)}),r},ee=({imageVersion:s})=>{const[r,n]=t.useState(!1),i=Y(s.componentInstances||[]);t.useEffect(()=>{n(!1)},[s]);const a=c=>{c.preventDefault(),n(!r)};return e.jsxs(e.Fragment,{children:[r&&i&&Object.entries(i).map(([c,o])=>e.jsx(e.Fragment,{children:Object.entries(o).map(([x,l])=>e.jsxs("div",{className:"my-2",children:[e.jsxs("div",{className:"mb-4",children:["Namespace ",e.jsx("b",{children:c})," - Container ",e.jsx("b",{children:x})]}),e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,_minmax(240px,_1fr))] gap-2",children:l.map((j,v)=>e.jsx(X,{instance:j},v))})]},`${c}-${x}`))})),e.jsx("div",{className:"advance-link",children:e.jsx("a",{href:"#",rel:"noopener noreferrer",onClick:a,children:e.jsxs(d,{alignment:"center",children:[r?"Hide Occurrences":"Display Occurrences",e.jsx(h,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})})]})},se=({queryClient:s,apiClient:r,service:n,imageVersion:i,searchTerm:a,after:c})=>s.ensureQueryData({queryKey:["imageVersionsIssues",n,i,a,c],queryFn:()=>r.query({query:z,variables:{componentVersionFilter:{version:[i]},issueMatchFilter:{serviceCcrn:[n]},issuesFilter:a?{search:[a]}:void 0,first:20,orderByIssueSeverity:[{by:R.Severity,direction:f.Desc}],orderBySeverity:[{by:C.Severity,direction:f.Desc}],orderByTrd:[{by:C.TargetRemediationDate,direction:f.Asc}],after:c}})}),re=s=>{const r=s.toLowerCase(),n=k(s),i={critical:"danger",high:"warning",medium:"errorOutline",low:"info",none:"help"};return e.jsx(h,{icon:i[r]||"help",color:n})},ne=({severity:s})=>re(s),ie=s=>`
    border-l-2
    ${k(s)}
    h-full
    pl-5
  `,ae=({issue:s})=>{const[r,n]=t.useState(!1),i=a=>{a.preventDefault(),n(!r)};return e.jsxs(u,{children:[e.jsx(p,{className:"pl-0",children:e.jsx("div",{className:ie(s.severity),children:e.jsx(ne,{severity:s.severity})})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceLink&&s.sourceLink!=="-"&&e.jsx("a",{href:s.sourceLink,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(d,{gap:"1.5",alignment:"center",children:[e.jsx(h,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Issue source"})]})})]})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsx(Q,{targetDate:s.earliestTargetRemediation})}),e.jsx(p,{children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{className:r?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:s.description}),e.jsx("a",{href:"#",onClick:i,className:"link-hover",children:e.jsxs(d,{alignment:"center",children:[r?"Show less":"Show more",e.jsx(h,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})]})})]})},oe=({issuesPromise:s})=>{const{error:r,data:n}=t.use(s),{issues:i}=b(n);return r?e.jsxs(y,{colSpan:4,children:["Error loading issues: ",r.message]}):i.length===0?e.jsx(y,{colSpan:4,children:"No issues found! ðŸš€"}):i.map(a=>e.jsx(ae,{issue:a},a.name))},te=({service:s,imageVersion:r})=>{const{apiClient:n,queryClient:i}=E({from:"/services/$service"}),[a,c]=t.useState(void 0),[o,x]=t.useState(void 0),l=se({apiClient:n,queryClient:i,service:s,imageVersion:r.version,searchTerm:a,after:o});return e.jsxs(e.Fragment,{children:[e.jsxs(d,{gap:"2",className:"mb-4 mt-8",children:[e.jsx(T,{children:"Issues"}),e.jsx(B,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:j=>c(j||""),onClear:()=>{c("")}})]}),e.jsxs(I,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(u,{children:[e.jsx(m,{children:e.jsx(h,{icon:"monitorHeart"})}),e.jsx(m,{children:"Issue"}),e.jsx(m,{children:"Target Date"}),e.jsx(m,{children:"Description"})]}),l&&e.jsx(t.Suspense,{fallback:e.jsx(y,{colSpan:4,children:e.jsxs(d,{gap:"2",alignment:"center",children:[e.jsx("div",{children:"Loading issues"}),e.jsx(S,{variant:"primary"})]})}),children:e.jsx(oe,{issuesPromise:l})})]}),l&&e.jsx(t.Suspense,{children:e.jsx(W,{dataPromise:l,dataNormalizationMethod:b,goToPage:x})})]})},ce=({imageVersionsPromise:s})=>{const r=w(),{service:n}=V({from:"/services/$service"}),{imageVersion:i}=N({from:"/services/$service"}),{data:a}=t.use(s),{imageVersions:c}=M(a),o=c.find(x=>x.version===i);return o?e.jsx(D,{children:e.jsx(q,{heading:`Image ${o.repository} Information`,opened:!!n,onClose:()=>r({to:"/services/$service",params:{service:n}}),size:"large",children:e.jsxs(_,{children:[e.jsx(G,{py:!0,px:!1,children:e.jsx(L,{})}),e.jsxs(I,{columns:2,gridColumnTemplate:"15% auto",children:[e.jsxs(u,{children:[e.jsx(m,{children:"Details"}),e.jsx(p,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(g,{pillKey:"tag",pillKeyLabel:"tag",pillValue:o.tag,pillValueLabel:o.tag}),e.jsx(g,{pillKey:"repository",pillKeyLabel:"repository",pillValue:o.repository,pillValueLabel:o.repository}),e.jsx(g,{pillKey:"version",pillKeyLabel:"version",pillValue:o.version,pillValueLabel:o.version})]})})]}),e.jsxs(u,{children:[e.jsx(m,{children:"Issues Counts"}),e.jsx(p,{children:e.jsx(P,{counts:o.issueCounts})})]}),e.jsxs(u,{children:[e.jsx(m,{className:"whitespace-nowrap",children:`Occurrences (${o.componetInstancesCount||0})`}),e.jsx(p,{children:e.jsx(ee,{imageVersion:o})})]})]}),n&&i&&o&&e.jsx(te,{service:n,imageVersion:o})]})})}):null},le=({servicePromise:s})=>{const{data:r}=t.use(s),n=A(r).services[0];return e.jsxs(e.Fragment,{children:[e.jsxs(U,{children:["Service ",n.name]}),e.jsxs(I,{columns:2,gridColumnTemplate:"10% auto",className:"mb-6",children:[e.jsxs(u,{children:[e.jsx(m,{children:"Details"}),e.jsx(p,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(g,{pillKey:"service",pillKeyLabel:"service",pillValue:n.name,pillValueLabel:n.name}),n.serviceDetails?.supportGroups?.map(i=>e.jsx(g,{pillKey:"support_group",pillKeyLabel:"support_group",pillValue:i,pillValueLabel:i},i))]})})]}),e.jsxs(u,{children:[e.jsx(m,{children:"Issues Counts"}),e.jsx(p,{children:e.jsx(P,{counts:n.issuesCount})})]})]})]})},de=()=>{const s=w(),{queryClient:r,apiClient:n}=E({from:"/services/$service"}),{servicePromise:i}=H({from:"/services/$service"}),{service:a}=V({from:"/services/$service"}),{imageVersion:c}=N({from:"/services/$service"}),[o,x]=t.useState(void 0),[l,j]=t.useState(void 0);return t.useEffect(()=>{const v=Z({queryClient:r,apiClient:n,service:a,after:o});j(v)},[o]),e.jsxs(D,{children:[e.jsx(L,{className:"mb-4"}),e.jsx(t.Suspense,{fallback:e.jsx(S,{className:"mt-4"}),children:e.jsx(le,{servicePromise:i})}),l&&e.jsx(J,{selectedImageVersion:c,imageVersionsPromise:l,onImageVersionItemClick:v=>{s({to:"/services/$service",params:{service:a},search:{imageVersion:v.version}})},goToPage:x}),e.jsx(t.Suspense,{children:l&&e.jsx(ce,{imageVersionsPromise:l})})]})},je=de;export{je as component};
