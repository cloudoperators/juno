import{j as e,k as d,f as h,q as $,V as F,K,s as O,t as y,I as C,v as R,w as T,d as u,y as p,x as b,B as z,G as q,e as I,A as x,r as S,b as V,D as w,h as N,J as B,F as D,C as G,E as M,_,L,i as v,l as A,u as H}from"./App-DporlnqB.js";import{a as t}from"./index-DxFmpwI_.js";import{g as k,E as f,u as E,C as U}from"./CursorPagination-BSal-MuK.js";import{I as P,b as J,f as Q,S as W}from"./IssueCountsPerSeverityLevel-BFQqD2An.js";import{I as X}from"./IssueTimestamp-Ces4fvri.js";const Y=({instance:s})=>e.jsxs($,{className:"text-sm text-theme-light",children:[e.jsxs(d,{children:[e.jsx("div",{className:"text-sm whitespace-nowrap overflow-hidden text-ellipsis w-full",children:(s==null?void 0:s.pod)||"--"}),e.jsxs(F,{triggerEvent:"hover",children:[e.jsx(K,{children:e.jsx(h,{icon:"info",size:"18",className:"cursor-pointer hover:text-theme-primary"})}),e.jsxs(O,{children:[e.jsxs("span",{children:[" Namespace: ",(s==null?void 0:s.namespace)||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Region: ",(s==null?void 0:s.region)||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Cluster: ",(s==null?void 0:s.cluster)||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Container: ",(s==null?void 0:s.container)||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Pod: ",(s==null?void 0:s.pod)||"--"]})]})]})]}),e.jsx("div",{className:"text-sm whitespace-nowrap",children:(s==null?void 0:s.cluster)||"--"})]}),Z=s=>{const r={};return s.forEach(i=>{const o=i.namespace||"Unknown",n=i.container||"Unknown";r[o]||(r[o]={}),r[o][n]||(r[o][n]=[]),r[o][n].push(i)}),r},ee=({imageVersion:s})=>{const[r,i]=t.useState(!1),o=Z(s.componentInstances||[]);t.useEffect(()=>{i(!1)},[s]);const n=l=>{l.preventDefault(),i(!r)};return e.jsxs(e.Fragment,{children:[r&&o&&Object.entries(o).map(([l,a])=>e.jsx(e.Fragment,{children:Object.entries(a).map(([m,c])=>e.jsxs("div",{className:"my-2",children:[e.jsxs("div",{className:"mb-4",children:["Namespace ",e.jsx("b",{children:l})," - Container ",e.jsx("b",{children:m})]}),e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,_minmax(240px,_1fr))] gap-2",children:c.map((j,g)=>e.jsx(Y,{instance:j},g))})]},`${l}-${m}`))})),e.jsx("div",{className:"advance-link",children:e.jsx("a",{href:"#",rel:"noopener noreferrer",onClick:n,children:e.jsxs(d,{alignment:"center",children:[r?"Hide Occurrences":"Display Occurrences",e.jsx(h,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})})]})},se=({queryClient:s,apiClient:r,service:i,imageVersion:o,searchTerm:n,after:l})=>s.ensureQueryData({queryKey:["imageVersionsIssues",i,o,n,l],queryFn:()=>r.query({query:T,variables:{componentVersionFilter:{version:[o]},issueMatchFilter:{serviceCcrn:[i]},issuesFilter:n?{search:[n]}:void 0,first:20,orderByIssueSeverity:[{by:R.Severity,direction:y.Desc}],orderBySeverity:[{by:C.Severity,direction:y.Desc}],orderByTrd:[{by:C.TargetRemediationDate,direction:y.Asc}],after:l}})}),re=s=>{const r=s.toLowerCase(),i=k(s),o={critical:"danger",high:"warning",medium:"errorOutline",low:"info",none:"help"};return e.jsx(h,{icon:o[r]||"help",color:i})},ie=({severity:s})=>re(s),oe=s=>`
    border-l-2
    ${k(s)}
    h-full
    pl-5
  `,ne=({issue:s})=>{const[r,i]=t.useState(!1),o=n=>{n.preventDefault(),i(!r)};return e.jsxs(u,{children:[e.jsx(p,{className:"pl-0",children:e.jsx("div",{className:oe(s.severity),children:e.jsx(ie,{severity:s.severity})})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceLink&&s.sourceLink!=="-"&&e.jsx("a",{href:s.sourceLink,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(d,{gap:"1.5",alignment:"center",children:[e.jsx(h,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Issue source"})]})})]})}),e.jsx(p,{className:"whitespace-nowrap",children:e.jsx(X,{targetDate:s.earliestTargetRemediation})}),e.jsx(p,{children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{className:r?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:s.description}),e.jsx("a",{href:"#",onClick:o,className:"link-hover",children:e.jsxs(d,{alignment:"center",children:[r?"Show less":"Show more",e.jsx(h,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})]})})]})},ae=({issuesPromise:s})=>{const{error:r,data:i}=t.use(s),{issues:o}=b(i);return r?e.jsxs(f,{colSpan:4,children:["Error loading issues: ",r.message]}):o.length===0?e.jsx(f,{colSpan:4,children:"No issues found! ðŸš€"}):o.map(n=>e.jsx(ne,{issue:n},n.name))},le=({service:s,imageVersion:r})=>{const{apiClient:i,queryClient:o}=E({from:"/services/$service"}),[n,l]=t.useState(void 0),[a,m]=t.useState(void 0),c=se({apiClient:i,queryClient:o,service:s,imageVersion:r.version,searchTerm:n,after:a});return e.jsxs(e.Fragment,{children:[e.jsxs(d,{gap:"2",className:"mb-4 mt-8",children:[e.jsx(z,{children:"Issues"}),e.jsx(q,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:j=>l(j||""),onClear:()=>{l("")}})]}),e.jsxs(I,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(u,{children:[e.jsx(x,{children:e.jsx(h,{icon:"monitorHeart"})}),e.jsx(x,{children:"Issue"}),e.jsx(x,{children:"Target Date"}),e.jsx(x,{children:"Description"})]}),c&&e.jsx(t.Suspense,{fallback:e.jsx(f,{colSpan:4,children:e.jsxs(d,{gap:"2",alignment:"center",children:[e.jsx("div",{children:"Loading issues"}),e.jsx(S,{variant:"primary"})]})}),children:e.jsx(ae,{issuesPromise:c})})]}),c&&e.jsx(t.Suspense,{children:e.jsx(U,{dataPromise:c,dataNormalizationMethod:b,goToPage:m})})]})},te=({imageVersionsPromise:s})=>{const r=V(),{service:i}=w({from:"/services/$service"}),{imageVersion:o}=N({from:"/services/$service"}),{data:n}=t.use(s),{imageVersions:l}=B(n),a=l.find(m=>m.version===o);return a?e.jsx(D,{children:e.jsx(G,{heading:`Image ${a.repository} Information`,opened:!!i,onClose:()=>r({to:"/services/$service",params:{service:i}}),size:"large",children:e.jsxs(M,{children:[e.jsx(_,{py:!0,px:!1,children:e.jsx(L,{})}),e.jsxs(I,{columns:2,gridColumnTemplate:"15% auto",children:[e.jsxs(u,{children:[e.jsx(x,{children:"Details"}),e.jsx(p,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(v,{pillKey:"tag",pillKeyLabel:"tag",pillValue:a.tag,pillValueLabel:a.tag}),e.jsx(v,{pillKey:"repository",pillKeyLabel:"repository",pillValue:a.repository,pillValueLabel:a.repository}),e.jsx(v,{pillKey:"version",pillKeyLabel:"version",pillValue:a.version,pillValueLabel:a.version})]})})]}),e.jsxs(u,{children:[e.jsx(x,{children:"Issues Counts"}),e.jsx(p,{children:e.jsx(P,{counts:a.issueCounts})})]}),e.jsxs(u,{children:[e.jsx(x,{className:"whitespace-nowrap",children:`Occurrences (${a.componetInstancesCount||0})`}),e.jsx(p,{children:e.jsx(ee,{imageVersion:a})})]})]}),i&&o&&a&&e.jsx(le,{service:i,imageVersion:a})]})})}):null},ce=({servicePromise:s})=>{var o,n;const{data:r}=t.use(s),i=A(r).services[0];return e.jsxs(e.Fragment,{children:[e.jsxs(J,{children:["Service ",i.name]}),e.jsxs(I,{columns:2,gridColumnTemplate:"10% auto",className:"mb-6",children:[e.jsxs(u,{children:[e.jsx(x,{children:"Details"}),e.jsx(p,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(v,{pillKey:"service",pillKeyLabel:"service",pillValue:i.name,pillValueLabel:i.name}),(n=(o=i.serviceDetails)==null?void 0:o.supportGroups)==null?void 0:n.map(l=>e.jsx(v,{pillKey:"support_group",pillKeyLabel:"support_group",pillValue:l,pillValueLabel:l},l))]})})]}),e.jsxs(u,{children:[e.jsx(x,{children:"Issues Counts"}),e.jsx(p,{children:e.jsx(P,{counts:i.issuesCount})})]})]})]})},de=()=>{const s=V(),{queryClient:r,apiClient:i}=E({from:"/services/$service"}),{servicePromise:o}=H({from:"/services/$service"}),{service:n}=w({from:"/services/$service"}),{imageVersion:l}=N({from:"/services/$service"}),[a,m]=t.useState(void 0),[c,j]=t.useState(void 0);return t.useEffect(()=>{const g=Q({queryClient:r,apiClient:i,service:n,after:a});j(g)},[a]),e.jsxs(D,{children:[e.jsx(L,{className:"mb-4"}),e.jsx(t.Suspense,{fallback:e.jsx(S,{className:"mt-4"}),children:e.jsx(ce,{servicePromise:o})}),c&&e.jsx(W,{selectedImageVersion:l,imageVersionsPromise:c,onImageVersionItemClick:g=>{s({to:"/services/$service",params:{service:n},search:{imageVersion:g.version}})},goToPage:m}),e.jsx(t.Suspense,{children:c&&e.jsx(te,{imageVersionsPromise:c})})]})},je=de;export{je as component};
