import{b as C,u as K,D as V,h as N,j as e,F as S,L as I,r as L,l as q,e as b,d as h,A as p,y as m,k as d,i as g,J as T,C as F,E as z,_ as B,f as j,B as E,G as O,x as k,q as _,V as M,K as R,s as A,t as f,I as w,v as U,w as G}from"./App-Da1Yg2v0-7yBA7Vmt.js";import{w as c}from"./index-Be8xNjzN.js";import{p as D,j as y,b as H,y as P}from"./CursorPagination-ACu98_oB-D-m6jIzj.js";import{P as J,K as Q,U as W,_ as $}from"./IssueCountsPerSeverityLevel-A3_GGdLC-CM0_PlnK.js";import{B as Y}from"./IssueTimestamp-bFBImrYl-Dq4k8n0B.js";import"./index-CAOJSEDT.js";const Z=({instance:s})=>e.jsxs(_,{className:"text-sm text-theme-light",children:[e.jsxs(d,{children:[e.jsx("div",{className:"text-sm whitespace-nowrap overflow-hidden text-ellipsis w-full",children:(s==null?void 0:s.pod)||"--"}),e.jsxs(M,{triggerEvent:"hover",children:[e.jsx(R,{children:e.jsx(j,{icon:"info",size:"18",className:"cursor-pointer hover:text-theme-primary"})}),e.jsxs(A,{children:[e.jsxs("span",{children:[" Namespace: ",(s==null?void 0:s.namespace)||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Region: ",(s==null?void 0:s.region)||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Cluster: ",(s==null?void 0:s.cluster)||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Container: ",(s==null?void 0:s.container)||"--"]}),e.jsx("br",{}),e.jsxs("span",{children:[" Pod: ",(s==null?void 0:s.pod)||"--"]})]})]})]}),e.jsx("div",{className:"text-sm whitespace-nowrap",children:(s==null?void 0:s.cluster)||"--"})]}),X=s=>{const r={};return s.forEach(i=>{const n=i.namespace||"Unknown",a=i.container||"Unknown";r[n]||(r[n]={}),r[n][a]||(r[n][a]=[]),r[n][a].push(i)}),r},ee=({imageVersion:s})=>{const[r,i]=c.useState(!1),n=X(s.componentInstances||[]);c.useEffect(()=>{i(!1)},[s]);const a=o=>{o.preventDefault(),i(!r)};return e.jsxs(e.Fragment,{children:[r&&n&&Object.entries(n).map(([o,l])=>e.jsx(e.Fragment,{children:Object.entries(l).map(([x,t])=>e.jsxs("div",{className:"my-2",children:[e.jsxs("div",{className:"mb-4",children:["Namespace ",e.jsx("b",{children:o})," - Container ",e.jsx("b",{children:x})]}),e.jsx("div",{className:"grid grid-cols-[repeat(auto-fill,_minmax(240px,_1fr))] gap-2",children:t.map((u,v)=>e.jsx(Z,{instance:u},v))})]},`${o}-${x}`))})),e.jsx("div",{className:"advance-link",children:e.jsx("a",{href:"#",rel:"noopener noreferrer",onClick:a,children:e.jsxs(d,{alignment:"center",children:[r?"Hide Occurrences":"Display Occurrences",e.jsx(j,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})})]})},se=({queryClient:s,apiClient:r,service:i,imageVersion:n,searchTerm:a,after:o})=>s.ensureQueryData({queryKey:["imageVersionsIssues",i,n,a,o],queryFn:()=>r.query({query:G,variables:{componentVersionFilter:{version:[n]},issueMatchFilter:{serviceCcrn:[i]},issuesFilter:a?{search:[a]}:void 0,first:20,orderByIssueSeverity:[{by:U.Severity,direction:f.Desc}],orderBySeverity:[{by:w.Severity,direction:f.Desc}],orderByTrd:[{by:w.TargetRemediationDate,direction:f.Asc}],after:o}})}),re=s=>{const r=s.toLowerCase(),i=P(s),n={critical:"danger",high:"warning",medium:"errorOutline",low:"info",none:"help"};return e.jsx(j,{icon:n[r]||"help",color:i})},ie=({severity:s})=>re(s),ne=s=>`
    border-l-2
    ${P(s)}
    h-full
    pl-5
  `,ae=({issue:s})=>{const[r,i]=c.useState(!1),n=a=>{a.preventDefault(),i(!r)};return e.jsxs(h,{children:[e.jsx(m,{className:"pl-0",children:e.jsx("div",{className:ne(s.severity),children:e.jsx(ie,{severity:s.severity})})}),e.jsx(m,{className:"whitespace-nowrap",children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{children:s.name}),s.sourceLink&&s.sourceLink!=="-"&&e.jsx("a",{href:s.sourceLink,target:"_blank",rel:"noopener noreferrer",className:"link-hover",children:e.jsxs(d,{gap:"1.5",alignment:"center",children:[e.jsx(j,{icon:"openInNew",size:"16"}),e.jsx("span",{children:"Issue source"})]})})]})}),e.jsx(m,{className:"whitespace-nowrap",children:e.jsx(Y,{targetDate:s.earliestTargetRemediation})}),e.jsx(m,{children:e.jsxs(d,{gap:"2",direction:"vertical",children:[e.jsx("span",{className:r?"":"whitespace-nowrap overflow-hidden text-ellipsis",children:s.description}),e.jsx("a",{href:"#",onClick:n,className:"link-hover",children:e.jsxs(d,{alignment:"center",children:[r?"Show less":"Show more",e.jsx(j,{color:"global-text",icon:r?"expandLess":"expandMore"})]})})]})})]})},le=({issuesPromise:s})=>{const{error:r,data:i}=c.use(s),{issues:n}=k(i);return r?e.jsxs(y,{colSpan:4,children:["Error loading issues: ",r.message]}):n.length===0?e.jsx(y,{colSpan:4,children:"No issues found! ðŸš€"}):n.map(a=>e.jsx(ae,{issue:a},a.name))},oe=({service:s,imageVersion:r})=>{const{apiClient:i,queryClient:n}=D({from:"/services/$service"}),[a,o]=c.useState(void 0),[l,x]=c.useState(void 0),t=se({apiClient:i,queryClient:n,service:s,imageVersion:r.version,searchTerm:a,after:l});return e.jsxs(e.Fragment,{children:[e.jsxs(d,{gap:"2",className:"mb-4 mt-8",children:[e.jsx(E,{children:"Issues"}),e.jsx(O,{placeholder:"Search for CVE number",className:"w-96 ml-auto",onSearch:u=>o(u||""),onClear:()=>{o("")}})]}),e.jsxs(b,{columns:4,minContentColumns:[0,1,2],cellVerticalAlignment:"top",children:[e.jsxs(h,{children:[e.jsx(p,{children:e.jsx(j,{icon:"monitorHeart"})}),e.jsx(p,{children:"Issue"}),e.jsx(p,{children:"Target Date"}),e.jsx(p,{children:"Description"})]}),t&&e.jsx(c.Suspense,{fallback:e.jsx(y,{colSpan:4,children:e.jsxs(d,{gap:"2",alignment:"center",children:[e.jsx("div",{children:"Loading issues"}),e.jsx(L,{variant:"primary"})]})}),children:e.jsx(le,{issuesPromise:t})})]}),t&&e.jsx(c.Suspense,{children:e.jsx(H,{dataPromise:t,dataNormalizationMethod:k,goToPage:x})})]})},ce=({imageVersionsPromise:s})=>{const r=C(),{service:i}=V({from:"/services/$service"}),{imageVersion:n}=N({from:"/services/$service"}),{data:a}=c.use(s),{imageVersions:o}=T(a),l=o.find(x=>x.version===n);return l?e.jsx(S,{children:e.jsx(F,{heading:`Image ${l.repository} Information`,opened:!!i,onClose:()=>r({to:"/services/$service",params:{service:i}}),size:"large",children:e.jsxs(z,{children:[e.jsx(B,{py:!0,px:!1,children:e.jsx(I,{})}),e.jsxs(b,{columns:2,gridColumnTemplate:"15% auto",children:[e.jsxs(h,{children:[e.jsx(p,{children:"Details"}),e.jsx(m,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(g,{pillKey:"tag",pillKeyLabel:"tag",pillValue:l.tag,pillValueLabel:l.tag}),e.jsx(g,{pillKey:"repository",pillKeyLabel:"repository",pillValue:l.repository,pillValueLabel:l.repository}),e.jsx(g,{pillKey:"version",pillKeyLabel:"version",pillValue:l.version,pillValueLabel:l.version})]})})]}),e.jsxs(h,{children:[e.jsx(p,{children:"Issues Counts"}),e.jsx(m,{children:e.jsx($,{counts:l.issueCounts})})]}),e.jsxs(h,{children:[e.jsx(p,{className:"whitespace-nowrap",children:`Occurrences (${l.componetInstancesCount||0})`}),e.jsx(m,{children:e.jsx(ee,{imageVersion:l})})]})]}),i&&n&&l&&e.jsx(oe,{service:i,imageVersion:l})]})})}):null},te=({servicePromise:s})=>{var r,i;const{data:n}=c.use(s),a=q(n).services[0];return e.jsxs(e.Fragment,{children:[e.jsxs(W,{children:["Service ",a.name]}),e.jsxs(b,{columns:2,gridColumnTemplate:"10% auto",className:"mb-6",children:[e.jsxs(h,{children:[e.jsx(p,{children:"Details"}),e.jsx(m,{children:e.jsxs(d,{gap:"1",direction:"horizontal",wrap:!0,children:[e.jsx(g,{pillKey:"service",pillKeyLabel:"service",pillValue:a.name,pillValueLabel:a.name}),(i=(r=a.serviceDetails)==null?void 0:r.supportGroups)==null?void 0:i.map(o=>e.jsx(g,{pillKey:"support_group",pillKeyLabel:"support_group",pillValue:o,pillValueLabel:o},o))]})})]}),e.jsxs(h,{children:[e.jsx(p,{children:"Issues Counts"}),e.jsx(m,{children:e.jsx($,{counts:a.issuesCount})})]})]})]})},de=()=>{const s=C(),{queryClient:r,apiClient:i}=D({from:"/services/$service"}),{servicePromise:n}=K({from:"/services/$service"}),{service:a}=V({from:"/services/$service"}),{imageVersion:o}=N({from:"/services/$service"}),[l,x]=c.useState(void 0),[t,u]=c.useState(void 0);return c.useEffect(()=>{const v=J({queryClient:r,apiClient:i,service:a,after:l});u(v)},[l]),e.jsxs(S,{children:[e.jsx(I,{className:"mb-4"}),e.jsx(c.Suspense,{fallback:e.jsx(L,{className:"mt-4"}),children:e.jsx(te,{servicePromise:n})}),t&&e.jsx(Q,{selectedImageVersion:o,imageVersionsPromise:t,onImageVersionItemClick:v=>{s({to:"/services/$service",params:{service:a},search:{imageVersion:v.version}})},goToPage:x}),e.jsx(c.Suspense,{children:t&&e.jsx(ce,{imageVersionsPromise:t})})]})},ve=de;export{ve as component};
