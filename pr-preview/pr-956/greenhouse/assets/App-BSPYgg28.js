import{c as V,B as U,j as n,e as W,r as T,k as p,D as j,I as z,U as y,z as B,v as C,H as P,s as L,L as R,C as q,E as G,f as H,y as v,_ as O,o as Y,p as J,n as Q,g as $,F as _,t as X,q as Z,T as ee}from"./Shell-BB7LmIpH.js";import{r as k}from"./index-asa38DL-.js";import"./index-Fw61lcph.js";const te=e=>({globals:{urlStateKey:"",apiEndpoint:null,loggedIn:!1,authData:null,actions:{setUrlStateKey:t=>e(a=>({globals:{...a.globals,urlStateKey:t}})),setLoggedIn:t=>e(a=>({globals:{...a.globals,loggedIn:t}})),setAuthData:t=>e(a=>({globals:{...a.globals,authData:t}})),setEndpoint:t=>e(a=>({globals:{...a.globals,apiEndpoint:t}}))}}}),ae=()=>V(U((e,t)=>({...te(e)}))),se=k.createContext(),ne=({children:e})=>n.jsx(se.Provider,{value:ae(),children:e}),d=W(e=>({endpoint:"",token:"",namespace:"",initialize:(t,a,r)=>e(o=>({endpoint:t,token:a,namespace:r})),urlStateKey:"secret-admin",setUrlStateKey:t=>e(a=>({urlStateKey:t})),secrets:[],modifySecrets:t=>e(a=>{let r=[...a.secrets];return t.forEach(o=>{const l=r.findIndex(u=>u.metadata.name===o.metadata.name);l>=0?r[l]=o:r.push(o)}),{...a,secrets:r}}),deleteSecrets:t=>e(a=>({secrets:a.secrets.filter(o=>!t.some(l=>o.metadata.name===l.metadata.name))})),secretDetail:void 0,setSecretDetail:t=>e(a=>({secretDetail:t})),showSecretEdit:!1,setShowSecretEdit:t=>e(a=>({showSecretEdit:t})),isSecretEditMode:!1,setIsSecretEditMode:t=>e(a=>({isSecretEditMode:t}))})),I=e=>{const t=e.dataName?e.dataName:"Data",a=e.isSecret?e.isSecret:!1,r=(u,c)=>{let g=u.split("."),E=g[0],i=g[1];switch(E){case"dataKey":let s={...e.data},m=s[i];delete s[i],s[c]=m,e.setData(s);break;case"dataValue":e.mutateValue&&(c=e.mutateValue(c)),e.setData({...e.data,[i]:c});break;default:console.log("keyIdentifier not found");break}},o=u=>{let c={...e.data};delete c[u],e.setData(c)},l=()=>{e.setData({...e.data,"":""})};return n.jsxs(T,{title:e.title,children:[e.data&&Object.keys(e.data).length>0&&Object.keys(e.data).map(u=>n.jsxs(p,{distribution:"evenly",children:[n.jsx(j,{id:"dataKey."+u,label:`${t} Key`,value:u,onBlur:c=>r("dataKey."+u,c.target.value)}),n.jsx(z,{id:"dataValue"+u,type:a?"password":"text",label:`${t} Value`,value:e.data[u],onBlur:c=>r("dataValue."+u,c.target.value)}),n.jsx(y,{icon:"deleteForever",onClick:()=>o(u)})]},u)),n.jsx(y,{icon:"addCircle",label:`Add ${t}`,onClick:l})]})},re=()=>{const e=d(c=>c.setSecretDetail),t=d(c=>c.secretDetail),a=d(c=>c.isSecretEditMode),r=c=>{e({...t,metadata:{...t==null?void 0:t.metadata,name:c}})},o=c=>{e({...t,type:c})},l=c=>{e({...t,data:c})},u=c=>{e({...t,metadata:{...t==null?void 0:t.metadata,labels:c}})};return n.jsxs(B,{children:[n.jsxs(T,{title:"General",children:[n.jsx(C,{children:n.jsx(j,{id:"name",label:"Name",placeholder:"Name of this secret",...a&&{disabled:!0},value:t==null?void 0:t.metadata.name,onBlur:c=>r(c.target.value)})}),n.jsx(C,{children:n.jsx(j,{id:"type",label:"Type",placeholder:'Type of this secret, leave empty for default "Opaque" type',...a&&{disabled:!0},value:t==null?void 0:t.type,onBlur:c=>o(c.target.value)})})]}),n.jsx(I,{title:"Labels",dataName:"Label",data:t.metadata.labels,setData:u}),n.jsx(I,{title:"Data",data:t.data,setData:l,isSecret:!0})]})},ce=()=>{const e=d(r=>r.endpoint),t=d(r=>r.token);return{client:e&&t?P({apiEndpoint:e,token:t}):null}},le=e=>{const t=d(i=>i.namespace),{client:a}=ce(),r=k.useCallback(async(i,s,m)=>!a||!t?{ok:!1,message:"Client or namespace not available"}:await a.get(i+"/"+s.metadata.name,{params:m}).then(S=>S.kind!==s.kind?{ok:!1,message:`Failed getting ${s.kind}`,response:S}:{ok:!0,response:S,message:`Successfully got ${s.kind}`}).catch(S=>({ok:!1,message:`Failed getting ${s.kind}: ${S}`})),[a,t]),o=k.useCallback(async(i,s)=>!a||!t?{ok:!1,message:"Client or namespace not available"}:await a.post(i,s).then(m=>m.kind!==s.kind?{ok:!1,message:`Failed creating ${s.kind}`}:{ok:!0,response:m,message:`Successfully created ${s.kind}`}).catch(m=>({ok:!1,message:`Failed creating ${s.kind}: ${m}`})),[a,t]),l=k.useCallback(async(i,s)=>!a||!t?{ok:!1,message:"Client or namespace not available"}:await a.put(i+"/"+s.metadata.name,s).then(m=>m.kind!==s.kind?{ok:!1,message:`Failed updating ${s.kind}`}:{ok:!0,response:m,message:`Successfully updated ${s.kind}`}).catch(m=>({ok:!1,message:`Failed updating ${s.kind}: ${m}`})),[a,t]),u=k.useCallback(async(i,s,m)=>!a||!t?{ok:!1,message:"Client or namespace not available"}:await a.delete(i+"/"+s.metadata.name,{params:m}).then(S=>S.kind==s.kind||S.kind=="Status"&&S.status=="Success"?{ok:!0,message:`Successfully deleted ${s.kind}`}:{ok:!1,message:`Failed deleting ${s.kind}`}).catch(S=>({ok:!1,message:`Failed deleting ${s.kind}: ${S}`})),[a,t]),c=k.useCallback(async(i,s,m,S,h,x)=>!a||!t?(console.log("Cannot initialize watch: client or namespace not available, waiting for client or namespace to become available"),{ok:!1,message:"Client or namespace not available"}):E(i,s).then(w=>w.ok?(a.watch(i,{params:x}).on(a.WATCH_ERROR,()=>{console.log("ERROR: Failed to watch resource")}).on(a.WATCH_ADDED,f=>{console.log(`added ${f}`),g(f,s),m(f)}).on(a.WATCH_MODIFIED,f=>{console.log(`modified ${f}`),g(f,s),S(f)}).on(a.WATCH_DELETED,f=>{console.log(`deleted ${f}`),g(f,s),h(f)}).start(),{ok:!0,message:`Successfully watching ${s}s`}):{ok:!1,message:`Cannot initialize watch for ${s}: ${w.message}`,status:403}),[a,t]),g=(i,s)=>{i.forEach(m=>{m.kind=s})},E=k.useCallback(async(i,s)=>{var h;let S=await r(i,{metadata:{name:""},kind:s});return((h=S.response)==null?void 0:h.kind)==`${s}List`?{ok:!0,message:""}:{ok:S.ok,message:S.message}},[a,t]);return{get:r,create:o,update:l,deleteObject:u,watch:c}},N=()=>{const{get:e,create:t,update:a,deleteObject:r,watch:o}=le(),l=d(h=>h.namespace),u=d(h=>h.modifySecrets),c=d(h=>h.deleteSecrets);return{getSecret:h=>e(`/api/v1/namespaces/${l}/secrets`,h),createSecret:h=>t(`/api/v1/namespaces/${l}/secrets`,h),updateSecret:h=>a(`/api/v1/namespaces/${l}/secrets`,h),deleteSecret:h=>r(`/api/v1/namespaces/${l}/secrets`,h),watchSecrets:()=>o(`/api/v1/namespaces/${l}/secrets`,"Secret",u,u,c),watchSecretsWithoutHelm:()=>{const D={fieldSelector:"type!=helm.sh/release.v1"};return o(`/api/v1/namespaces/${l}/secrets`,"Secret",u,u,c,D)}}},ie=()=>({kind:"Secret",metadata:{name:"",namespace:""},data:{}}),oe=e=>{if(e.data){let t={};Object.keys(e.data).forEach(a=>{t[a]=btoa(e.data[a])}),e.data=t}return e},K=e=>{if(e.data){let t={};Object.keys(e.data).forEach(a=>{t[a]=atob(e.data[a])}),e.data=t}return e},de=()=>{const{createSecret:e,updateSecret:t,deleteSecret:a}=N(),r=d(s=>s.secretDetail),o=d(s=>s.isSecretEditMode),l=d(s=>s.setShowSecretEdit),u=d(s=>s.setSecretDetail),c=d(s=>s.setIsSecretEditMode),{addMessage:g}=L(),E=async()=>{let s=await a(r);g({variant:s.ok?"success":"error",text:s.message}),s.ok&&setTimeout(()=>{l(!1),u(void 0),c(!1)},3e3)},i=()=>{let s=oe(r);(o?t(s):e(s)).then(async S=>{g({variant:S.ok?"success":"error",text:S.message}),S.ok&&(c(!0),S.response&&u(K(S.response)))})};return n.jsxs(p,{distribution:"between",children:[n.jsx(y,{onClick:E,variant:"primary-danger",children:"Delete Secret"}),n.jsx(y,{onClick:i,variant:"primary",children:o?"Update Secret":"Create Secret"})]})},ue=()=>n.jsx(R,{}),Se=()=>{const e=d(l=>l.showSecretEdit),t=d(l=>l.setShowSecretEdit),a=d(l=>l.setSecretDetail),r=d(l=>l.setIsSecretEditMode),o=()=>{t(!1),a(void 0),r(!1)};return n.jsx(q,{heading:n.jsx(p,{gap:"2",children:n.jsx("span",{children:"Edit Secret"})}),opened:!!e,onClose:o,size:"large",children:n.jsxs(G,{children:[n.jsx(ue,{}),n.jsx(re,{}),n.jsx(de,{})]})})},me=e=>{const t=d(l=>l.setSecretDetail),a=d(l=>l.setShowSecretEdit),r=d(l=>l.setIsSecretEditMode),o=()=>{let l=K(e.secret);t(l),r(!0),a(!0)};return n.jsxs(H,{className:"cursor-pointer",onClick:o,children:[n.jsx(v,{children:e.secret.metadata.name}),n.jsx(v,{children:e.secret.data?Object.keys(e.secret.data).join(", "):"No keys found"})]})},he=()=>{const e=d(o=>o.setShowSecretEdit),t=d(o=>o.setSecretDetail),a=()=>{e(!0),t(ie())},r=d(o=>o.secrets);return n.jsx(n.Fragment,{children:n.jsxs(O,{children:[n.jsx(Y,{children:n.jsx(J,{children:n.jsx(y,{icon:"addCircle",label:"Add Secret",onClick:a})})}),n.jsxs(Q,{columns:2,className:"secrets",children:[n.jsxs(H,{children:[n.jsx($,{children:"Name"}),n.jsx($,{children:"Keys"})]}),r.map(o=>n.jsx(me,{secret:o},o.metadata.name))]}),n.jsx(R,{})]})})},ge=()=>{const e=d(t=>t.showSecretEdit);return n.jsxs(O,{children:[n.jsx(he,{}),e&&n.jsx(_,{children:n.jsx(Se,{})})]})},fe="@tailwind base;@tailwind components;@tailwind utilities;.plugins .juno-datagrid-row:hover .juno-datagrid-cell{@apply bg-theme-background-lvl-1;}.plugins .juno-datagrid-row.active .juno-datagrid-cell{@apply bg-theme-background-lvl-2;}.filtered{-webkit-filter:grayscale(100%);filter:grayscale(100%)}.markdown-body{background-color:transparent!important}",b="greenhouse-secrets-admin",M="sd",A="sse",F="isem",ke=e=>{const[t,a]=k.useState(!1),r=X(e||b),o=d(i=>i.showSecretEdit),l=d(i=>i.setShowSecretEdit),u=d(i=>i.secretDetail),c=d(i=>i.setSecretDetail),g=d(i=>i.isSecretEditMode),E=d(i=>i.setIsSecretEditMode);k.useEffect(()=>{var S,h,x;if(t)return;console.log(`${b}: (${e||b}) setting up state from url:`,r.currentState());const i=(S=r.currentState())==null?void 0:S[A],s=(h=r.currentState())==null?void 0:h[M],m=(x=r.currentState())==null?void 0:x[F];i&&l(i),s&&c(s),m&&E(m),a(!0)},[l]),k.useEffect(()=>{t&&r.push({[A]:o,[M]:u,[F]:g})},[o])},Ee=e=>{ke(e.consumerId);const{addMessage:t}=L(),{watchSecretsWithoutHelm:a}=N();return k.useEffect(()=>{a().then(r=>{r.ok||r.message&&r.status==403&&t({variant:"error",text:r.message})})},[]),null},xe=(e={})=>(d(a=>a.initialize)(e.apiEndpoint,e.token,e.namespace),n.jsx(_,{children:n.jsxs(ee,{pageHeader:"Converged Cloud | Secrets",embedded:e.embedded==="true"||e.embedded===!0,children:[n.jsx(Ee,{}),n.jsx(ge,{props:e})]})})),je=e=>n.jsxs(Z,{theme:`${e.theme?e.theme:"theme-dark"}`,children:[n.jsx("style",{children:fe.toString()}),n.jsx(ne,{children:n.jsx(xe,{...e})})]});export{je as default};
