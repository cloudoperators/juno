name: 3rd Party License Checker

on:
  # push:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  reuse-compliance-check:
    runs-on: [ubuntu-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # https://github.com/fsfe/reuse-action
      - name: REUSE Compliance Check
        uses: fsfe/reuse-action@v3

  detect-lib-changes:
    needs: reuse-compliance-check
    runs-on: [ubuntu-latest]
    outputs:
      lib-changes: ${{ steps.lib-filters.outputs.changes }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Generate lib filters
        run: |
          for folder in libs/*; do
            folder_name=$(basename "$folder")
            echo "$folder_name: $folder/**" >> temp_lib_filters.yaml
          done

      - uses: dorny/paths-filter@v3
        id: filters
        with:
          list-files: shell
          filters: |
            libs: libs/**

      - uses: dorny/paths-filter@v3
        id: lib-filters
        with:
          list-files: shell
          filters: temp_lib_filters.yaml

      - name: Show outputs
        run: |
          echo "========"
          cat temp_lib_filters.yaml
          echo "========"
          echo libs: ${{ steps.filters.outputs.libs}}
          echo libs_files: ${{ steps.filters.outputs.libs_files}}
          echo lib changes: ${{ steps.lib-filters.outputs.changes}}
          echo "===================="

  check-3rd-party-licenses:
    needs: detect-lib-changes
    runs-on: [ubuntu-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup node
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"

      - name: Install npm dependencies
        run: |
          FILTERS=$(echo '${{ needs.detect-lib-changes.outputs.lib-changes }}' | jq -r '.[]')
          for FILTER in $FILTERS; do
            echo "Installing npm dependencies for filter: $FILTER"
          done

      # - name: build libs
      #   run: |
      #     NODE_ENV=production npm ci
      #     npm run build-libs

      # # MIT, Apache-2.0, BSD, ISC
      # - name: check license
      #   run: |
      #     npm install -g license-checker
      #     license-checker -onlyAllow "MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;BSD-4-Clause"
