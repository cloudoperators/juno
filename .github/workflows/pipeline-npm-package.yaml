# Run it locally with act (https://github.com/nektos/act)
#  1. Install act:
#     `brew install act`
#  2. Create a .secret file with the following content:
#     `GITHUB_TOKEN=your_github_token`
#  PULL REQUEST
#  1. Create a act_pull_request.json file in case of a pull request with the following content:
#     `{"inputs": {"paths": "packages/juno-ui-components apps/exampleapp", "node": "20.x", "runs-on": "ubuntu-latest"}}`
#  2. Run the following command:
#     `act workflow_call -e act_workflow_call_ci.json -W .github/workflows/check-changes-npm-package.yaml`

name: Detect Changes on the given Paths

####################################################################
# SHARED WORKFLOW
# Do not modify this file if you don't know what you are doing
####################################################################

on:
  workflow_call:
    inputs:
      paths:
        description: "Space separated list of paths indicating where to collect packages to be check for changes. Example: 'packages' will check all packages in the packages folder."
        required: false
        type: string
      folders:
        description: "Space-separated list of folders to be checked for changes. Example: 'packages/communicator packages/juno-ui-components' checks for changes in the communicator and juno-ui-components packages. You can use wildcards to check all packages within a specific folder. Example: '*/ui' checks all packages with a ui folder at the second level."
        required: false
        type: string
      runs-on:
        description: "The runner to use for the job"
        required: false
        default: "default"
        type: string
    outputs:
      changes:
        description: "List of found changes in the paths"
        value: ${{ jobs.detect-changes.outputs.changes }}

env:
  HUSKY: 0

jobs:
  input-processing:
    runs-on: ${{ inputs.runs-on}}
    steps:
      - name: Print Inputs
        run: |
          echo "====${{ github.workflow }} Inputs===="
          echo "Inputs: ${{ toJson(inputs) }}"
          echo "===="

  check-licenses:
    needs: [input-processing]
    uses: cloudoperators/juno/.github/workflows/check-licenses-npm-package.yaml@main
    with:
      path: ${{ inputs.path }}
      node: ${{ inputs.node }}
      runs-on: ${{ inputs.runs-on}}

  test-unit-and-build:
    needs: [input-processing, check-licenses]
    if: ${{ needs.check-licenses.outputs.contains-self-hosted-registry == 'false' }}
    uses: cloudoperators/juno/.github/workflows/test-build-npm-package.yaml@main
    with:
      path: ${{ inputs.path }}
      node: ${{ inputs.node }}
      runs-on: ${{ inputs.runs-on}}
